<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>상세정보 (ych_p110) - {{ company.company_name if company else '기업 상세 정보' }}</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}?v=20251118">
    <script src="/static/js/chart.umd.min.js"></script>
    <style>
        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        body {
            background: linear-gradient(135deg, #0a1f3b 0%, #2c5aa0 35%, #4a9fd9 100%);
            min-height: 100vh;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .container {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(15px);
            border-radius: 20px;
            border: 1px solid rgba(74, 159, 217, 0.3);
            margin: 20px auto;
            padding: 0;
            box-shadow: 0 8px 32px rgba(10, 31, 59, 0.3);
            max-width: 1400px;
            width: 95%;
            overflow: hidden;
        }

        /* 헤더 스타일 */
        .header {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(0, 0, 0, 0.1);
            padding: 20px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header h1 {
            margin: 0;
            font-size: 24px;
            font-weight: 600;
            color: #2c3e50;
        }

        header h1 {
            margin: 0;
            font-size: 28px;
            font-weight: 600;
            color: #2c3e50;
        }

        .header-subtext {
            font-size: 16px;
            font-weight: normal;
            opacity: 0.8;
            margin-left: 10px;
        }

        .header-right {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .user-name {
            background: rgba(255, 255, 255, 0.9);
            color: #2c3e50;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 500;
            border: 1px solid rgba(44, 62, 80, 0.2);
        }

        .header-button {
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            text-decoration: none;
            font-size: 14px;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .header-button:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-1px);
        }

        .header-button.primary {
            background: linear-gradient(45deg, #28a745, #20c997);
            border: 1px solid #28a745;
        }

        .header-button.close {
            background: linear-gradient(45deg, #6c757d, #495057);
            border: 1px solid #6c757d;
            padding: 10px 25px;
            font-size: 14px;
            min-width: 80px;
            border-radius: 25px;
            white-space: nowrap;
            font-weight: 500;
            box-shadow: 0 2px 8px rgba(108, 117, 125, 0.3);
            transition: all 0.3s ease;
        }

        .header-button.close:hover {
            background: linear-gradient(45deg, #495057, #343a40);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(220, 53, 69, 0.4);
        }

        /* 탭 메뉴 스타일 */
        .tab-menu {
            display: flex;
            background: #f8f9fa;
            border-bottom: 1px solid #dee2e6;
        }

        .tab-button {
            flex: 1;
            padding: 15px 20px;
            background: none;
            border: none;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            color: #6c757d;
        }

        .tab-button.active {
            background: linear-gradient(135deg, #2c5aa0, #4a9fd9);
            color: white;
            font-weight: 600;
        }

        .tab-button:hover:not(.active) {
            background: rgba(44, 90, 160, 0.1);
            color: #2c5aa0;
        }

        /* 컨텐츠 영역 */
        .tab-content {
            padding: 30px;
            min-height: 600px;
        }

        .tab-panel {
            display: none;
        }

        .tab-panel.active {
            display: block;
        }

        /* 검색 영역 */
        .search-section {
            background: rgba(248, 249, 250, 0.9);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid rgba(44, 90, 160, 0.2);
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .search-section input {
            padding: 10px 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            min-width: 200px;
        }

        .search-section button {
            background: linear-gradient(45deg, #28a745, #20c997);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .search-section button:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3);
        }

        /* 기업 정보 레이아웃 */
        .company-layout {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 25px;
        }

        /* 기본 정보 패널 */
        .info-panel {
            background: rgba(255, 255, 255, 0.9);
            border-radius: 15px;
            padding: 25px;
            border: 1px solid rgba(44, 90, 160, 0.2);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .info-panel h3 {
            color: #0a1f3b;
            margin-bottom: 20px;
            font-size: 18px;
            font-weight: 600;
            border-bottom: 2px solid #4a9fd9;
            padding-bottom: 8px;
        }

        .info-item {
            display: flex;
            margin-bottom: 12px;
            padding: 8px 0;
            border-bottom: 1px solid rgba(44, 90, 160, 0.1);
        }

        .info-label {
            flex: 0 0 100px;
            font-weight: 600;
            color: #2c5aa0;
            font-size: 14px;
        }

        .info-value {
            flex: 1;
            color: #333;
            font-size: 14px;
            padding-left: 10px;
        }

        .info-value.editable {
            background: #f8f9fa;
            padding: 5px 10px;
            border-radius: 4px;
            border: 1px solid #ddd;
            cursor: pointer;
        }

        .info-value.editable:hover {
            background: #e9ecef;
        }

        .edit-button {
            background: linear-gradient(45deg, #007bff, #0056b3);
            color: white;
            border: none;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
            margin-left: 10px;
        }

        .edit-button:hover {
            transform: translateY(-1px);
        }

        /* 재무 정보 테이블 */
        .financial-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }

        .financial-table th {
            background: linear-gradient(135deg, #2c5aa0, #4a9fd9);
            color: white;
            padding: 12px 8px;
            text-align: center;
            font-weight: 600;
            border: 1px solid #2c5aa0;
            font-size: 14px;
        }

        .financial-table td {
            padding: 10px 8px;
            text-align: right;
            border: 1px solid #dee2e6;
            background: rgba(255, 255, 255, 0.8);
            font-size: 13px;
        }

        .financial-table .item-name {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            font-weight: 600;
            color: #0a1f3b;
            text-align: left;
            padding-left: 15px;
        }

        .financial-table tbody tr:hover {
            background: rgba(74, 159, 217, 0.1);
        }

        /* 인물 정보 그리드 */
        .people-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .people-table {
            width: 100%;
            border-collapse: collapse;
        }

        .people-table th {
            background: linear-gradient(135deg, #6c757d, #495057);
            color: white;
            padding: 8px;
            text-align: center;
            font-size: 12px;
        }

        .people-table td {
            padding: 6px 8px;
            border: 1px solid #dee2e6;
            text-align: center;
            font-size: 12px;
        }

        /* 비상장주식가치 평가 */
        .valuation-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin-top: 20px;
        }

        /* AI 팁 섹션 */
        .ai-tip-section {
            background: linear-gradient(135deg, #e3f2fd, #bbdefb);
            border-radius: 15px;
            padding: 25px;
            margin-top: 30px;
            border: 1px solid rgba(33, 150, 243, 0.3);
        }

        .ai-tip-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .ai-tip-title {
            font-size: 18px;
            font-weight: 600;
            color: #1976d2;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .ai-tip-button {
            background: linear-gradient(45deg, #2196f3, #1976d2);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .ai-tip-button:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(33, 150, 243, 0.3);
        }

        .ai-tip-content {
            color: #1565c0;
            line-height: 1.6;
            font-size: 14px;
        }

        .ai-tip-content ul {
            margin: 10px 0;
            padding-left: 20px;
        }

        .ai-tip-content li {
            margin-bottom: 8px;
        }

        .ai-disclaimer {
            font-size: 11px;
            color: #666;
            text-align: right;
            margin-top: 15px;
            font-style: italic;
        }

        /* AI 종합 분석 스타일 */
        .ai-comprehensive-analysis {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 25px;
            border: 2px solid #4a9fd9;
            box-shadow: 0 8px 32px rgba(74, 159, 217, 0.2);
            backdrop-filter: blur(10px);
        }

        .analysis-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e9ecef;
        }

        .analysis-status {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .status-indicator {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .status-indicator.analyzing {
            background: #fff3cd;
            color: #856404;
            animation: pulse 2s infinite;
        }

        .status-indicator.completed {
            background: #d4edda;
            color: #155724;
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 0.7;
            }

            50% {
                opacity: 1;
            }
        }

        .comprehensive-report {
            background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
            margin-bottom: 25px;
            min-height: 500px;
            border: 2px solid #e9ecef;
            position: relative;
            overflow: auto;
        }

        .comprehensive-report:before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #4a9fd9, #2c5aa0, #6f42c1);
            border-radius: 15px 15px 0 0;
        }

        .loading-animation {
            text-align: center;
            padding: 50px 20px;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #6f42c1;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .analysis-steps {
            text-align: left;
            max-width: 300px;
            margin: 20px auto;
        }

        .analysis-steps .step {
            padding: 8px 0;
            color: #6c757d;
            font-size: 14px;
            opacity: 0;
            animation: fadeInStep 0.5s ease-in-out forwards;
        }

        @keyframes fadeInStep {
            to {
                opacity: 1;
            }
        }

        .followup-questions {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .question-counter {
            background: #e9ecef;
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 13px;
            color: #495057;
        }

        .question-input-container {
            margin-bottom: 25px;
        }

        .input-group {
            display: flex;
            gap: 15px;
            align-items: flex-end;
        }

        .input-group textarea {
            flex: 1;
            padding: 12px 15px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 14px;
            font-family: inherit;
            resize: vertical;
            transition: border-color 0.2s;
        }

        .input-group textarea:focus {
            outline: none;
            border-color: #6f42c1;
            box-shadow: 0 0 0 3px rgba(111, 66, 193, 0.1);
        }

        .input-group button {
            background: linear-gradient(135deg, #6f42c1 0%, #5a2d91 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
            white-space: nowrap;
        }

        .input-group button:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(111, 66, 193, 0.3);
        }

        .input-group button:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .qa-history {
            margin-bottom: 25px;
        }

        .qa-item {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            border-left: 4px solid #6f42c1;
        }

        .qa-question {
            font-weight: 600;
            color: #495057;
            margin-bottom: 10px;
        }

        .qa-answer {
            color: #6c757d;
            line-height: 1.6;
        }

        .question-suggestions h5 {
            color: #495057;
            margin-bottom: 15px;
            font-size: 14px;
        }

        .suggestion-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .suggestion-btn {
            background: #e9ecef;
            color: #495057;
            border: none;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .suggestion-btn:hover {
            background: #6f42c1;
            color: white;
        }

        .report-content {
            line-height: 1.8;
            color: #495057;
        }

        .report-section {
            margin-bottom: 25px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #007bff;
        }

        .report-section h4 {
            color: #0a1f3b;
            margin-bottom: 15px;
        }

        .highlight-box {
            background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
            border: 1px solid #ffc107;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
        }

        .highlight-box h5 {
            color: #856404;
            margin-bottom: 10px;
        }

        .ai-result-section {
            background: white;
            border-radius: 10px;
            padding: 20px;
            border: 1px solid #ddd;
            margin-top: 20px;
            min-height: 200px;
        }

        .ai-result-title {
            font-size: 16px;
            font-weight: 600;
            color: #2c5aa0;
            margin-bottom: 15px;
            border-bottom: 2px solid #4a9fd9;
            padding-bottom: 8px;
        }

        .loading-spinner {
            text-align: center;
            color: #666;
            font-style: italic;
        }

        /* 반응형 디자인 */
        @media (max-width: 1024px) {
            .company-layout {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .container {
                margin: 10px;
                width: calc(100% - 20px);
            }

            .header {
                padding: 15px 20px;
                flex-direction: column;
                gap: 10px;
            }

            .tab-content {
                padding: 20px 15px;
            }

            .financial-table th,
            .financial-table td {
                padding: 8px 4px;
                font-size: 12px;
            }
        }

        /* 모달창 스타일 */
        .modal {
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background-color: #ffffff;
            margin: 5% auto;
            padding: 0;
            border: none;
            width: 500px;
            max-width: 90%;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            animation: modalFadeIn 0.3s ease-out;
        }

        @keyframes modalFadeIn {
            from {
                opacity: 0;
                transform: translateY(-50px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .modal-header {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            padding: 20px 25px;
            border-radius: 15px 15px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .close {
            color: white;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: background-color 0.2s;
        }

        .close:hover {
            background-color: rgba(255, 255, 255, 0.2);
        }

        .modal-body {
            padding: 25px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
            font-size: 14px;
        }

        .form-input {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.2s, box-shadow 0.2s;
            box-sizing: border-box;
        }

        .form-input:focus {
            outline: none;
            border-color: #28a745;
            box-shadow: 0 0 0 3px rgba(40, 167, 69, 0.1);
        }

        .form-input[readonly] {
            background-color: #f8f9fa;
            color: #6c757d;
        }

        .form-textarea {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 14px;
            font-family: inherit;
            resize: vertical;
            min-height: 80px;
            transition: border-color 0.2s, box-shadow 0.2s;
            box-sizing: border-box;
        }

        .form-textarea:focus {
            outline: none;
            border-color: #28a745;
            box-shadow: 0 0 0 3px rgba(40, 167, 69, 0.1);
        }

        .modal-footer {
            padding: 20px 25px;
            border-top: 1px solid #e9ecef;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        .btn-cancel {
            padding: 10px 20px;
            background-color: #6c757d;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .btn-cancel:hover {
            background-color: #5a6268;
        }

        .btn-submit {
            padding: 10px 20px;
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .btn-submit:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(40, 167, 69, 0.3);
        }

        /* 11. 텍스트 기반 인포그래픽 스타일 */
        .ai-analysis-infographic {
            font-family: 'Segoe UI', Arial, sans-serif;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 15px;
            padding: 25px;
            margin: 20px 0;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        }

        .infographic-header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: linear-gradient(45deg, #007bff, #0056b3);
            border-radius: 10px;
            color: white;
        }

        .header-icon {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .infographic-header h2 {
            margin: 0;
            font-size: 1.8rem;
            font-weight: 600;
        }

        .analysis-meta {
            font-size: 0.9rem;
            opacity: 0.9;
            margin-top: 8px;
        }

        .company-card,
        .analysis-results {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
            border-left: 4px solid #007bff;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }

        .card-icon,
        .result-icon {
            font-size: 1.5rem;
            margin-bottom: 10px;
        }

        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .info-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .info-item .label {
            font-weight: 600;
            color: #495057;
        }

        .info-item .value {
            color: #007bff;
            font-weight: 500;
        }

        .analysis-body h4 {
            color: #007bff;
            border-bottom: 2px solid #e9ecef;
            padding-bottom: 5px;
            margin-top: 25px;
        }

        .analysis-body ul {
            padding-left: 20px;
        }

        .analysis-body li {
            margin-bottom: 8px;
            line-height: 1.6;
        }

        .analysis-body strong {
            color: #495057;
        }
    </style>
    <script src="{{ url_for('static', filename='js/auto-logout.js') }}"></script>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>

<body>
    <div class="container">
        <!-- 헤더 -->
        <div class="header">
            <h1>상세정보 (ych_p110) - <span id="company-title">{{ company.company_name if company else '동화에이스' }}</span>
            </h1>
            <div class="header-right">
                <span class="user-name">{{ user_name }}님</span>
                <button class="header-button primary" onclick="registerPioneering()">개척등록</button>
                <a href="javascript:window.close();" class="back-button">닫기</a>
            </div>
        </div>

        <!-- 탭 메뉴 -->
        <div class="tab-menu">
            <button id="tab-company-info" class="tab-button active" onclick="showTab('company-info', this)">기업 신상
                조회</button>
            <button id="tab-ai-search" class="tab-button" onclick="showTab('ai-search', this)">AI 서치</button>
            <button id="tab-contact-history" class="tab-button" onclick="showTab('contact-history', this)">접촉이력
                조회</button>
        </div>

        <!-- 탭 컨텐츠 -->
        <div class="tab-content">
            <!-- 기업 신상 조회 탭 -->
            <div id="company-info" class="tab-panel active">
                <!-- 검색 섹션 -->
                <div class="search-section">
                    <input type="text" id="company-search" placeholder="서영원"
                        value="{{ company.representative_name if company else '서영원' }}">
                    <button onclick="searchCompany()">조회</button>
                </div>

                <!-- 기업 정보 레이아웃 -->
                <div class="company-layout">
                    <!-- 기본 정보 -->
                    <div class="info-panel">
                        <h3>기본 정보</h3>
                        <div class="info-item">
                            <span class="info-label">사업자번호</span>
                            <span class="info-value" id="business-number">{{ company.biz_no if company else '1018139184'
                                }}</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">대표자</span>
                            <span class="info-value editable" id="ceo-name">{{ company.representative_name if company
                                else '서영원' }}</span>
                            <button onclick="searchCeoName()" class="search-btn">조회</button>
                            <button class="edit-button" onclick="editCeoName()">수정</button>
                        </div>
                        <div class="info-item">
                            <span class="info-label">설립일</span>
                            <span class="info-value">{{ company.establish_date if company else '19951005' }}</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">기업규모</span>
                            <span class="info-value">{{ company.company_size if company else '중기업' }}</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">신용등급</span>
                            <span class="info-value">{{ company.listing_status if company else 'a' }} (Tel: {{
                                company.phone_number if company and company.phone_number else '-' }})</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">직원수</span>
                            <span class="info-value">{{ company.employee_count if company and company.employee_count
                                else '-' }}</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">업종</span>
                            <span class="info-value">{{ company.industry_name if company else '육상 및 항공 운송업' }}</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">주소</span>
                            <span class="info-value">{{ company.address if company else '서울 서초구 바우뫼로 184, 5층(양재동, 화창빌딩)'
                                }}</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">단체계약여부</span>
                            <span class="info-value"
                                style="{% if company.is_group_contract == '1' %}color: #28a745; font-weight: bold;{% else %}color: #dc3545; font-weight: bold;{% endif %}">{{
                                'Y' if company.is_group_contract == '1' else 'N' }}</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">GFC거래여부</span>
                            <span class="info-value"
                                style="{% if company.is_gfc == '1' %}color: #28a745; font-weight: bold;{% else %}color: #dc3545; font-weight: bold;{% endif %}">{{
                                'Y' if company.is_gfc == '1' else 'N' }}</span>
                        </div>
                    </div>

                    <!-- 재무 정보 -->
                    <div class="info-panel">
                        <h3>재무 정보 (최근 3개년, 단위: 원)</h3>
                        <table class="financial-table">
                            <thead>
                                <tr>
                                    <th>항목</th>
                                    {% if financial_data and financial_data|length >= 3 %}
                                    <th>{{ financial_data[0].fiscal_year or '2024' }}년</th>
                                    <th>{{ financial_data[1].fiscal_year or '2023' }}년</th>
                                    <th>{{ financial_data[2].fiscal_year or '2022' }}년</th>
                                    {% else %}
                                    <th>2024년</th>
                                    <th>2023년</th>
                                    <th>2022년</th>
                                    {% endif %}
                                </tr>
                            </thead>
                            <tbody>
                                {% if financial_data and financial_data|length >= 3 %}
                                <tr>
                                    <td class="item-name">매출액</td>
                                    <td>{{ "{:,}".format(financial_data[0].sales_revenue or 0) }}</td>
                                    <td>{{ "{:,}".format(financial_data[1].sales_revenue or 0) }}</td>
                                    <td>{{ "{:,}".format(financial_data[2].sales_revenue or 0) }}</td>
                                </tr>
                                <tr>
                                    <td class="item-name">당기순이익</td>
                                    <td>{{ "{:,}".format(financial_data[0].net_income or 0) }}</td>
                                    <td>{{ "{:,}".format(financial_data[1].net_income or 0) }}</td>
                                    <td>{{ "{:,}".format(financial_data[2].net_income or 0) }}</td>
                                </tr>
                                <tr>
                                    <td class="item-name">자산총계</td>
                                    <td>{{ "{:,}".format(financial_data[0].total_assets or 0) }}</td>
                                    <td>{{ "{:,}".format(financial_data[1].total_assets or 0) }}</td>
                                    <td>{{ "{:,}".format(financial_data[2].total_assets or 0) }}</td>
                                </tr>
                                <tr>
                                    <td class="item-name">자본총계</td>
                                    <td>{{ "{:,}".format((financial_data[0].total_equity or 0) * 1000) }}</td>
                                    <td>{{ "{:,}".format((financial_data[1].total_equity or 0) * 1000) }}</td>
                                    <td>{{ "{:,}".format((financial_data[2].total_equity or 0) * 1000) }}</td>
                                </tr>
                                <tr>
                                    <td class="item-name">이익잉여금</td>
                                    <td>{{ "{:,}".format(financial_data[0].retained_earnings or 0) }}</td>
                                    <td>{{ "{:,}".format(financial_data[1].retained_earnings or 0) }}</td>
                                    <td>{{ "{:,}".format(financial_data[2].retained_earnings or 0) }}</td>
                                </tr>
                                <tr>
                                    <td class="item-name">영업이익</td>
                                    <td>{{ "{:,}".format(financial_data[0].operating_income or 0) }}</td>
                                    <td>{{ "{:,}".format(financial_data[1].operating_income or 0) }}</td>
                                    <td>{{ "{:,}".format(financial_data[2].operating_income or 0) }}</td>
                                </tr>
                                <tr>
                                    <td class="item-name">법인세비용</td>
                                    <td>{{ "{:,}".format(financial_data[0].corporate_tax or 0) }}</td>
                                    <td>{{ "{:,}".format(financial_data[1].corporate_tax or 0) }}</td>
                                    <td>{{ "{:,}".format(financial_data[2].corporate_tax or 0) }}</td>
                                </tr>
                                <tr>
                                    <td class="item-name">가지급금</td>
                                    <td>{{ "{:,}".format(financial_data[0].advances_paid or 0) }}</td>
                                    <td>{{ "{:,}".format(financial_data[1].advances_paid or 0) }}</td>
                                    <td>{{ "{:,}".format(financial_data[2].advances_paid or 0) }}</td>
                                </tr>
                                <tr>
                                    <td class="item-name">이익준비금</td>
                                    <td>{{ "{:,}".format(financial_data[0].earned_reserve or 0) }}</td>
                                    <td>{{ "{:,}".format(financial_data[1].earned_reserve or 0) }}</td>
                                    <td>{{ "{:,}".format(financial_data[2].earned_reserve or 0) }}</td>
                                </tr>
                                <tr>
                                    <td class="item-name">자본준비금</td>
                                    <td>{{ "{:,}".format(financial_data[0].capital_reserve or 0) }}</td>
                                    <td>{{ "{:,}".format(financial_data[1].capital_reserve or 0) }}</td>
                                    <td>{{ "{:,}".format(financial_data[2].capital_reserve or 0) }}</td>
                                </tr>
                                {% else %}
                                <tr>
                                    <td colspan="4" style="text-align: center;">재무 데이터가 없습니다.</td>
                                </tr>
                                {% endif %}
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- 인증 및 특허 정보 -->
                <div class="info-panel" style="margin-top: 20px;">
                    <h3>인증 및 특허 정보</h3>
                    <table class="people-table">
                        <thead>
                            <tr>
                                <th>구분</th>
                                <th>인증/보유 여부</th>
                                <th>인정/출원일</th>
                                <th>만료일</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>기업부설연구소</td>
                                <td><span
                                        class="status-{{ 'yes' if additional and additional.has_research_institute == '1' else 'no' }}">{{
                                        '보유' if additional and additional.has_research_institute == '1' else '미보유'
                                        }}</span></td>
                                <td>{{ additional.research_institute_date if additional and
                                    additional.research_institute_date else '-' }}</td>
                                <td>-</td>
                            </tr>
                            <tr>
                                <td>이노비즈</td>
                                <td><span
                                        class="status-{{ 'yes' if additional and additional.is_innobiz == '1' else 'no' }}">{{
                                        '보유' if additional and additional.is_innobiz == '1' else '미보유' }}</span></td>
                                <td>{{ additional.innobiz_cert_date if additional and additional.innobiz_cert_date else
                                    '-' }}</td>
                                <td>{{ additional.innobiz_expiry_date if additional and additional.innobiz_expiry_date
                                    else '-' }}</td>
                            </tr>
                            <tr>
                                <td>메인비즈</td>
                                <td><span
                                        class="status-{{ 'yes' if additional and additional.is_mainbiz == '1' else 'no' }}">{{
                                        '보유' if additional and additional.is_mainbiz == '1' else '미보유' }}</span></td>
                                <td>{{ additional.mainbiz_cert_date if additional and additional.mainbiz_cert_date else
                                    '-' }}</td>
                                <td>{{ additional.mainbiz_expiry_date if additional and additional.mainbiz_expiry_date
                                    else '-' }}</td>
                            </tr>
                            <tr>
                                <td>벤처인증</td>
                                <td><span
                                        class="status-{{ 'yes' if additional and additional.is_venture == '1' else 'no' }}">{{
                                        '인증' if additional and additional.is_venture == '1' else '미인증' }}</span></td>
                                <td>{{ additional.venture_cert_date if additional and additional.venture_cert_date else
                                    '-' }}</td>
                                <td>{{ additional.venture_expiry_date if additional and additional.venture_expiry_date
                                    else '-' }}</td>
                            </tr>
                            <tr>
                                <td>특허</td>
                                <td colspan="3">
                                    출원: <strong>{{ additional.patent_applications_count if additional and
                                        additional.patent_applications_count else 0 }}</strong>건 /
                                    등록: <strong>{{ additional.registered_patents_count if additional and
                                        additional.registered_patents_count else 0 }}</strong>건
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!-- 비상장주식가치 평가 -->
                <div class="info-panel" style="margin-top: 20px;">
                    <h3>비상장주식가치 평가 (참고용)</h3>
                    {% if stock_valuation and stock_valuation.total_shares_issued %}
                    <div class="valuation-section">
                        <!-- 주요 평가 결과 -->
                        <div
                            style="background: linear-gradient(135deg, #e8f5e8, #f0fff0); border-radius: 15px; padding: 20px; margin-bottom: 20px; border: 2px solid #28a745;">
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 15px;">
                                <div>
                                    <div style="font-size: 14px; color: #666; margin-bottom: 5px;">자산가치 (순자산)</div>
                                    <div style="font-size: 20px; font-weight: bold; color: #2c5aa0;">{{
                                        "{:,.0f}".format(stock_valuation.asset_value) }} 원</div>
                                </div>
                                <div>
                                    <div style="font-size: 14px; color: #666; margin-bottom: 5px;">수익가치 (3년 평균×10)</div>
                                    <div style="font-size: 20px; font-weight: bold; color: #2c5aa0;">{{
                                        "{:,.0f}".format(stock_valuation.profit_value) }} 원</div>
                                </div>
                            </div>

                            <div style="text-align: center; padding: 15px 0; border-top: 1px solid #28a745;">
                                <div style="font-size: 16px; color: #28a745; margin-bottom: 5px;">최종 평가가치 (자산 60% + 수익
                                    40%)</div>
                                <div style="font-size: 28px; font-weight: bold; color: #d63384;">{{
                                    "{:,.0f}".format(stock_valuation.calculated_value) }} 원</div>
                            </div>
                        </div>

                        <!-- 주당 정보 -->
                        <div style="background: #fff; border: 1px solid #ddd; border-radius: 10px; padding: 20px;">
                            <table style="width: 100%; border-collapse: collapse;">
                                <thead>
                                    <tr style="background: #f8f9fa;">
                                        <th style="padding: 12px; text-align: left; border-bottom: 2px solid #dee2e6;">
                                            구분</th>
                                        <th style="padding: 12px; text-align: right; border-bottom: 2px solid #dee2e6;">
                                            금액</th>
                                        <th
                                            style="padding: 12px; text-align: center; border-bottom: 2px solid #dee2e6;">
                                            비고</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td style="padding: 12px; border-bottom: 1px solid #dee2e6;">발행주식수</td>
                                        <td
                                            style="padding: 12px; text-align: right; border-bottom: 1px solid #dee2e6; font-weight: bold;">
                                            {{ "{:,.0f}".format(stock_valuation.total_shares_issued) }} 주</td>
                                        <td
                                            style="padding: 12px; text-align: center; border-bottom: 1px solid #dee2e6; font-size: 12px; color: #666;">
                                            자본금 기준 산출</td>
                                    </tr>
                                    <tr style="background: #fff8dc;">
                                        <td style="padding: 12px; border-bottom: 1px solid #dee2e6; font-weight: bold;">
                                            1주당 평가액</td>
                                        <td
                                            style="padding: 12px; text-align: right; border-bottom: 1px solid #dee2e6; font-size: 18px; font-weight: bold; color: #dc3545;">
                                            {{ "{:,.0f}".format(stock_valuation.estimated_stock_value) }} 원</td>
                                        <td
                                            style="padding: 12px; text-align: center; border-bottom: 1px solid #dee2e6; font-size: 12px; color: #666;">
                                            기본 평가액</td>
                                    </tr>
                                    <tr>
                                        <td style="padding: 12px; border-bottom: 1px solid #dee2e6;">장부가치 주당가액</td>
                                        <td style="padding: 12px; text-align: right; border-bottom: 1px solid #dee2e6;">
                                            {{ "{:,.0f}".format(stock_valuation.book_value_per_share) }} 원</td>
                                        <td
                                            style="padding: 12px; text-align: center; border-bottom: 1px solid #dee2e6; font-size: 12px; color: #666;">
                                            장부가 기준</td>
                                    </tr>
                                    <tr>
                                        <td style="padding: 12px; border-bottom: 1px solid #dee2e6;">시가 평가액 (+10%)</td>
                                        <td
                                            style="padding: 12px; text-align: right; border-bottom: 1px solid #dee2e6; color: #28a745;">
                                            {{ "{:,.0f}".format(stock_valuation.market_value_per_share) }} 원</td>
                                        <td
                                            style="padding: 12px; text-align: center; border-bottom: 1px solid #dee2e6; font-size: 12px; color: #666;">
                                            시장프리미엄</td>
                                    </tr>
                                    <tr>
                                        <td style="padding: 12px;">연금평가액 (-10%)</td>
                                        <td style="padding: 12px; text-align: right; color: #6f42c1;">{{
                                            "{:,.0f}".format(stock_valuation.annual_value_per_share) }} 원</td>
                                        <td style="padding: 12px; text-align: center; font-size: 12px; color: #666;">연금
                                            할인</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>

                        <!-- 평가 방법 및 주의사항 -->
                        <div style="background: #f8f9fa; border-radius: 10px; padding: 15px; margin-top: 15px;">
                            <h5 style="color: #495057; margin-bottom: 10px;">? 평가방법 및 주의사항</h5>
                            <ul
                                style="margin: 0; padding-left: 20px; font-size: 13px; color: #6c757d; line-height: 1.6;">
                                <li><strong>평가방법:</strong> 순자산가치(60%) + 수익가치(40%) 가중평균</li>
                                <li><strong>수익가치:</> 최근 3개년 평균 순이익 × 10배수 적용</li>
                                <li><strong>발행주식수:</strong> 자본금 ÷ 5,000원 (액면가 기준)</li>
                                <li><strong>참고용:</strong> 실제 거래가격과 차이가 날 수 있으며, 전문평가기관 감정 권장</li>
                                <li><strong>세무적용:</strong> 상속·증여세 신고 시 별도의 전문평가 필요</li>
                            </ul>
                        </div>
                    </div>
                    {% else %}
                    <div
                        style="text-align: center; padding: 40px; background: #f8f9fa; border-radius: 10px; color: #666;">
                        <div style="font-size: 48px; margin-bottom: 15px;">?</div>
                        <div style="font-size: 16px; font-weight: 500; margin-bottom: 10px;">재무 데이터 부족</div>
                        <div style="font-size: 14px;">비상장주식가치 평가를 위한 충분한 재무정보가 없습니다.</div>
                        <div style="font-size: 13px; color: #999; margin-top: 10px;">최근 3개년 재무제표 데이터가 필요합니다.</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 개척등록 모달창 -->
        <div id="pioneeringModal" class="modal" style="display: none;">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 style="color: #28a745; margin: 0; font-size: 18px;">개척 대상 등록 ({{ company.biz_no or 'ych_P111'
                        }})</h3>
                    <span class="close" onclick="closePioneeringModal()">&times;</span>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label for="companyName">기업명:</label>
                        <input type="text" id="companyName" class="form-input"
                            value="{{ company.company_name or '서우수력' }}" readonly>
                    </div>
                    <div class="form-group">
                        <label for="bizNo">사업자번호:</label>
                        <input type="text" id="bizNo" class="form-input" value="{{ company.biz_no or '1018117254' }}"
                            readonly>
                    </div>
                    <div class="form-group">
                        <label for="visitDate">방문일자 *</label>
                        <input type="date" id="visitDate" class="form-input" required>
                    </div>
                    <div class="form-group">
                        <label for="memo">메모:</label>
                        <textarea id="memo" class="form-textarea" placeholder="개척 관련 메모사항..." rows="4"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn-cancel" onclick="closePioneeringModal()">취소</button>
                    <thead>
                        <tr style="background: linear-gradient(135deg, #2c5aa0, #4a9fd9); color: white;">
                            <th style="padding: 12px 8px; text-align: left; font-weight: 600;">접촉일시</th>
                            <th style="padding: 12px 8px; text-align: left; font-weight: 600;">사업자번호</th>
                            <th style="padding: 12px 8px; text-align: left; font-weight: 600;">기업명</th>
                            <th style="padding: 12px 8px; text-align: left; font-weight: 600;">접촉유형</th>
                            <th style="padding: 12px 8px; text-align: left; font-weight: 600;">접촉자</th>
                            <th style="padding: 12px 8px; text-align: left; font-weight: 600; width: 200px;">메모</th>
                            <th style="padding: 12px 8px; text-align: center; font-weight: 600;">등록자</th>
                            <th style="padding: 12px 8px; text-align: center; font-weight: 600;">첨부2</th>

                        </tr>
                    </thead>
                    <tbody id="contactHistoryTable">
                        <tr>
                            <td colspan="8" style="padding: 40px; text-align: center; color: #6c757d;">접촉이력을 불러오는 중...
                            </td>
                        </tr>
                    </tbody>
                    </table>
                </div>
            </div>

            <!-- AI 서치 탭 -->
            <div id="ai-search" class="tab-panel">
                <div class="ai-comprehensive-analysis">
                    <!-- 분석 헤더 -->
                    <div class="analysis-header"
                        style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding: 15px; background: linear-gradient(135deg, #2c5aa0, #4a9fd9); border-radius: 10px;">
                        <h3 style="margin: 0; color: white; font-size: 20px;">📊 AI 종합 분석 리포트</h3>
                        <button class="analysis-button" onclick="startEnhancedAnalysis()"
                            style="padding: 10px 25px; background: #28a745; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; box-shadow: 0 4px 12px rgba(0,0,0,0.2);">
                            🔄 분석 실행
                        </button>
                    </div>

                    <!-- 그래프 영역 -->
                    <div id="chartsSection" class="analysis-charts-grid"
                        style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 25px;">
                        <!-- 주주 지분율 파이차트 -->
                        <div class="chart-card"
                            style="background: white; border-radius: 15px; padding: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
                            <h4 style="margin: 0 0 15px 0; color: #2c5aa0; font-size: 16px;">🏢 주주 지분 구조</h4>
                            <div style="height: 280px; position: relative;">
                                <canvas id="shareholderChart"></canvas>
                            </div>
                            <div id="shareholderLegend" style="margin-top: 10px; font-size: 12px; color: #666;"></div>
                        </div>

                        <!-- 재무 실적 추이 차트 -->
                        <div class="chart-card"
                            style="background: white; border-radius: 15px; padding: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
                            <h4 style="margin: 0 0 15px 0; color: #2c5aa0; font-size: 16px;">📈 재무 실적 추이 (3개년)</h4>
                            <div style="height: 280px; position: relative;">
                                <canvas id="financialChart"></canvas>
                            </div>
                        </div>
                    </div>

                    <!-- 접촉이력 요약 -->
                    <div id="contactSummarySection"
                        style="background: white; border-radius: 15px; padding: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); margin-bottom: 25px;">
                        <h4 style="margin: 0 0 15px 0; color: #2c5aa0; font-size: 16px;">📞 접촉이력 요약</h4>
                        <div id="contactSummary" style="display: flex; gap: 15px; flex-wrap: wrap;">
                            <div style="padding: 20px; text-align: center; color: #666;">접촉이력 데이터를 불러오는 중...</div>
                        </div>
                    </div>

                    <!-- AI 분석 보고서 -->
                    <div class="comprehensive-report" id="comprehensiveReport"
                        style="background: white; border-radius: 15px; padding: 25px; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
                        <div class="loading-animation" style="text-align: center; padding: 40px;">
                            <div class="spinner"
                                style="width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid #2c5aa0; border-radius: 50%; margin: 0 auto 20px; animation: spin 1s linear infinite;">
                            </div>
                            <p style="color: #666;">분석을 위해 상단의 <strong>분석 실행</strong> 버튼을 클릭하세요.</p>
                            <div class="analysis-steps" id="analysisSteps"
                                style="margin-top: 15px; font-size: 14px; color: #888;">
                                <div class="step">AI 분석 대기 중...</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <script>
        // 전역 변수 설정
        let currentBizNo = '{{ company.biz_no if company else "1018139184" }}';
        let currentCompanyName = '{{ company.company_name if company else "동화에이스" }}';
        let analysisCompleted = false;
        let analysisStepInterval = null; // 애니메이션 제어용 전역 변수
        let shareholderChart = null;
        let financialChart = null;

        // 개선된 분석 시작 함수 (그래프 + AI 분석)
        function startEnhancedAnalysis() {
            console.log('[DEBUG] startEnhancedAnalysis 시작');

            // 분석 상태 초기화
            analysisCompleted = false;

            // 로딩 상태 표시
            const reportDiv = document.getElementById('comprehensiveReport');
            reportDiv.innerHTML = `
                <div style="text-align: center; padding: 40px;">
                    <div class="spinner" style="width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid #2c5aa0; border-radius: 50%; margin: 0 auto 20px; animation: spin 1s linear infinite;"></div>
                    <p style="color: #666;">📊 기업 데이터를 분석하고 있습니다...</p>
                    <div id="analysisSteps" style="margin-top: 15px; font-size: 14px; color: #888;"></div>
                </div>
            `;

            // 분석 단계 애니메이션
            const steps = [
                '📁 기업 기본 정보 수집 중...',
                '👥 주주 구조 분석 중...',
                '📈 재무 데이터 분석 중...',
                '📞 접촉이력 분석 중...',
                '🤖 AI 종합 분석 생성 중...'
            ];

            let stepIndex = 0;
            const analysisSteps = document.getElementById('analysisSteps');

            analysisStepInterval = setInterval(() => {
                if (stepIndex < steps.length && analysisSteps) {
                    const stepDiv = document.createElement('div');
                    stepDiv.className = 'step';
                    stepDiv.textContent = steps[stepIndex];
                    stepDiv.style.marginTop = '5px';
                    analysisSteps.appendChild(stepDiv);
                    stepIndex++;
                }
            }, 1500);

            // 1. 그래프 데이터 로드
            fetch(`/api/company-analysis-data/${currentBizNo}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // 그래프 렌더링
                        renderShareholderChart(data.data.shareholders);
                        renderFinancialChart(data.data.financials);
                        renderContactSummary(data.data.contact_type_summary, data.data.contact_history);

                        // 2. AI 분석 요청
                        return performEnhancedAIAnalysis(data.data);
                    } else {
                        throw new Error(data.message || '데이터 로드 실패');
                    }
                })
                .catch(error => {
                    console.error('[ERROR] 분석 오류:', error);
                    clearInterval(analysisStepInterval);
                    showAnalysisError('데이터 분석 중 오류가 발생했습니다: ' + error.message);
                });
        }

        // 주주 지분율 파이차트 렌더링
        function renderShareholderChart(shareholders) {
            const ctx = document.getElementById('shareholderChart');
            if (!ctx) return;

            // 기존 차트 제거
            if (shareholderChart) {
                shareholderChart.destroy();
            }

            if (!shareholders || shareholders.length === 0) {
                document.getElementById('shareholderLegend').innerHTML = '<p style="color: #999; text-align: center;">주주 정보가 없습니다</p>';
                return;
            }

            // 상위 5명 + 기타 처리
            const top5 = shareholders.slice(0, 5);
            const othersTotal = shareholders.slice(5).reduce((sum, s) => sum + s.ownership_percent, 0);

            const labels = top5.map(s => s.name.substring(0, 8) + (s.name.length > 8 ? '...' : ''));
            const dataValues = top5.map(s => s.ownership_percent);

            if (othersTotal > 0) {
                labels.push('기타');
                dataValues.push(othersTotal);
            }

            const colors = ['#2c5aa0', '#4a9fd9', '#28a745', '#ffc107', '#dc3545', '#6f42c1'];

            shareholderChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: dataValues,
                        backgroundColor: colors,
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: {
                                font: { size: 11 },
                                padding: 8
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function (context) {
                                    return context.label + ': ' + context.raw.toFixed(1) + '%';
                                }
                            }
                        }
                    }
                }
            });

            // 범례 업데이트
            const legendHtml = top5.map((s, i) =>
                `<span style="display: inline-block; margin-right: 10px;"><span style="display: inline-block; width: 10px; height: 10px; background: ${colors[i]}; margin-right: 3px; border-radius: 2px;"></span>${s.name}: ${s.ownership_percent.toFixed(1)}%</span>`
            ).join('');
            document.getElementById('shareholderLegend').innerHTML = legendHtml;
        }

        // 재무 실적 추이 차트 렌더링
        function renderFinancialChart(financials) {
            const ctx = document.getElementById('financialChart');
            if (!ctx) return;

            // 기존 차트 제거
            if (financialChart) {
                financialChart.destroy();
            }

            if (!financials || financials.length === 0) {
                ctx.parentElement.innerHTML = '<p style="color: #999; text-align: center; padding-top: 100px;">재무 데이터가 없습니다</p>';
                return;
            }

            // 연도순 정렬 (오래된 것부터)
            const sortedData = [...financials].reverse();
            const labels = sortedData.map(f => f.year + '년');

            financialChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: '매출액',
                            data: sortedData.map(f => f.sales_revenue / 100000000), // 억원 단위
                            backgroundColor: 'rgba(44, 90, 160, 0.8)',
                            borderColor: '#2c5aa0',
                            borderWidth: 1,
                            yAxisID: 'y'
                        },
                        {
                            label: '영업이익',
                            data: sortedData.map(f => f.operating_income / 100000000), // 억원 단위
                            backgroundColor: 'rgba(40, 167, 69, 0.8)',
                            borderColor: '#28a745',
                            borderWidth: 1,
                            yAxisID: 'y'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: { font: { size: 11 } }
                        },
                        tooltip: {
                            callbacks: {
                                label: function (context) {
                                    return context.dataset.label + ': ' + context.raw.toFixed(0) + '억원';
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: '억원'
                            }
                        }
                    }
                }
            });
        }

        // 접촉이력 요약 렌더링
        function renderContactSummary(typeSummary, contactHistory) {
            const container = document.getElementById('contactSummary');
            if (!container) return;

            if (!typeSummary || Object.keys(typeSummary).length === 0) {
                container.innerHTML = '<p style="color: #999; text-align: center; padding: 20px;">접촉이력이 없습니다</p>';
                return;
            }

            const typeColors = {
                '방문': '#2c5aa0',
                '전화': '#28a745',
                '이메일': '#ffc107',
                '회의': '#6f42c1',
                '기타': '#6c757d'
            };

            let html = '';
            for (const [type, count] of Object.entries(typeSummary)) {
                const color = typeColors[type] || '#6c757d';
                html += `
                    <div style="background: ${color}; color: white; padding: 15px 20px; border-radius: 10px; text-align: center; min-width: 80px;">
                        <div style="font-size: 24px; font-weight: bold;">${count}</div>
                        <div style="font-size: 12px; opacity: 0.9;">${type}</div>
                    </div>
                `;
            }

            // 최근 접촉 정보 추가
            if (contactHistory && contactHistory.length > 0) {
                const latest = contactHistory[0];
                html += `
                    <div style="background: #f8f9fa; padding: 15px 20px; border-radius: 10px; flex: 1; min-width: 200px;">
                        <div style="font-size: 12px; color: #666; margin-bottom: 5px;">최근 접촉</div>
                        <div style="font-weight: 600; color: #333;">${latest.datetime || '-'}</div>
                        <div style="font-size: 13px; color: #666;">${latest.type} - ${latest.person || '미상'}</div>
                    </div>
                `;
            }

            container.innerHTML = html;
        }

        // 개선된 AI 분석 실행
        function performEnhancedAIAnalysis(analysisData) {
            return fetch('/api/ai-analysis', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    biz_no: currentBizNo,
                    company_name: currentCompanyName
                })
            })
                .then(response => response.json())
                .then(data => {
                    clearInterval(analysisStepInterval);

                    if (data.success && data.analysis) {
                        displayEnhancedReport(data.analysis, analysisData);
                        analysisCompleted = true;
                    } else {
                        throw new Error(data.message || 'AI 분석 실패');
                    }
                })
                .catch(error => {
                    clearInterval(analysisStepInterval);
                    console.error('[ERROR] AI 분석 오류:', error);
                    showAnalysisError('AI 분석 중 오류가 발생했습니다: ' + error.message);
                });
        }

        // 개선된 보고서 표시
        function displayEnhancedReport(analysis, analysisData) {
            const reportDiv = document.getElementById('comprehensiveReport');

            // 영업 제안 섹션 생성
            const salesProposal = generateSalesProposal(analysisData);

            reportDiv.innerHTML = `
                <div style="border-bottom: 2px solid #4a9fd9; margin-bottom: 20px; padding-bottom: 10px;">
                    <h2 style="color: #2c5aa0; margin: 0; font-size: 18px;">🤖 AI 종합 분석 결과</h2>
                </div>
                
                <div style="display: grid; gap: 20px;">
                    <!-- 기업 개요 -->
                    <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; border-left: 4px solid #2c5aa0;">
                        <h4 style="color: #2c5aa0; margin: 0 0 10px 0;">📋 기업 개요</h4>
                        <p style="line-height: 1.8; color: #333; margin: 0;">${analysis.summary || '분석 정보가 없습니다.'}</p>
                    </div>
                    
                    <!-- 재무 분석 -->
                    <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; border-left: 4px solid #28a745;">
                        <h4 style="color: #28a745; margin: 0 0 10px 0;">📈 재무 분석</h4>
                        <p style="line-height: 1.8; color: #333; margin: 0;">${analysis.financial_analysis || '재무 분석 정보가 없습니다.'}</p>
                    </div>
                    
                    <!-- 리스크 평가 -->
                    <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; border-left: 4px solid #ffc107;">
                        <h4 style="color: #e6a800; margin: 0 0 10px 0;">⚠️ 위험 평가 및 과제</h4>
                        <p style="line-height: 1.8; color: #333; margin: 0;">${analysis.risk_assessment || '위험 평가 정보가 없습니다.'}</p>
                    </div>
                    
                    <!-- 영업 제안 (새로 추가) -->
                    <div style="background: linear-gradient(135deg, #e8f5e8, #f0fff0); padding: 20px; border-radius: 10px; border: 2px solid #28a745;">
                        <h4 style="color: #28a745; margin: 0 0 15px 0;">💼 이 기업에 제안할 상품/서비스</h4>
                        ${salesProposal}
                    </div>
                    
                    <!-- 개선 권고 -->
                    <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; border-left: 4px solid #6f42c1;">
                        <h4 style="color: #6f42c1; margin: 0 0 10px 0;">🎯 개선 권고 사항</h4>
                        <p style="line-height: 1.8; color: #333; margin: 0;">${analysis.recommendations || '개선 권고 정보가 없습니다.'}</p>
                    </div>
                </div>
                
                <div style="margin-top: 30px; text-align: right; font-size: 12px; color: #888;">
                    * 본 분석은 AI에 의해 생성되었으며, 참고용으로만 활용하시기 바랍니다.
                </div>
                <div style="margin-top: 15px; text-align: center;">
                    <button onclick="analysisCompleted=false; startEnhancedAnalysis();" 
                            style="padding: 10px 25px; background: #6c757d; color: white; border: none; border-radius: 5px; cursor: pointer;">
                        🔄 다시 분석하기
                    </button>
                </div>
            `;
        }

        // 영업 제안 생성
        function generateSalesProposal(data) {
            const proposals = [];

            // 주주 구조 기반 제안
            if (data.shareholders && data.shareholders.length > 0) {
                const totalOwnership = data.shareholders.reduce((sum, s) => sum + s.ownership_percent, 0);
                if (data.shareholders[0].ownership_percent > 50) {
                    proposals.push({
                        icon: '👤',
                        title: '가업승계/상속 컨설팅',
                        reason: `대주주 지분율 ${data.shareholders[0].ownership_percent.toFixed(1)}%로 집중됨`,
                        priority: 'high'
                    });
                }
            }

            // 재무 분석 기반 제안
            if (data.financials && data.financials.length > 0) {
                const latestFinancial = data.financials[0];

                if (latestFinancial.sales_revenue > 10000000000) { // 100억 이상
                    proposals.push({
                        icon: '💰',
                        title: '기업 자금 관리 서비스',
                        reason: `매출액 ${(latestFinancial.sales_revenue / 100000000).toFixed(0)}억원 규모`,
                        priority: 'high'
                    });
                }

                if (latestFinancial.operating_income > 0) {
                    proposals.push({
                        icon: '📊',
                        title: '절세 컨설팅',
                        reason: '영업이익 발생 기업',
                        priority: 'medium'
                    });
                }

                if (latestFinancial.retained_earnings > 1000000000) { // 10억 이상
                    proposals.push({
                        icon: '🏦',
                        title: '자산관리/투자 서비스',
                        reason: `이익잉여금 ${(latestFinancial.retained_earnings / 100000000).toFixed(0)}억원 보유`,
                        priority: 'high'
                    });
                }
            }

            // 접촉이력 기반 제안
            if (data.contact_history && data.contact_history.length > 0) {
                const memos = data.contact_history.map(c => c.memo).join(' ');
                if (memos.includes('보험') || memos.includes('연금')) {
                    proposals.push({
                        icon: '🛡️',
                        title: '기업보험/연금 강화 제안',
                        reason: '이전 접촉에서 관련 니즈 파악됨',
                        priority: 'high'
                    });
                }
            }

            // 기본 제안
            if (proposals.length === 0) {
                proposals.push({
                    icon: '📋',
                    title: '기업현황분석 리포트',
                    reason: '첫 미팅용 자료',
                    priority: 'medium'
                });
                proposals.push({
                    icon: '🤝',
                    title: '니즈파악 미팅',
                    reason: '추가 정보 수집 필요',
                    priority: 'medium'
                });
            }

            // HTML 생성
            let html = '<div style="display: grid; gap: 10px;">';
            proposals.forEach((p, i) => {
                const priorityColor = p.priority === 'high' ? '#dc3545' : '#ffc107';
                html += `
                    <div style="display: flex; align-items: center; gap: 15px; padding: 12px; background: white; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05);">
                        <span style="font-size: 24px;">${p.icon}</span>
                        <div style="flex: 1;">
                            <div style="font-weight: 600; color: #333;">${p.title}</div>
                            <div style="font-size: 12px; color: #666;">${p.reason}</div>
                        </div>
                        <span style="background: ${priorityColor}; color: white; padding: 3px 10px; border-radius: 12px; font-size: 11px;">
                            ${p.priority === 'high' ? '추천' : '고려'}
                        </span>
                    </div>
                `;
            });
            html += '</div>';

            return html;
        }


        // 탭 전환 함수
        function showTab(tabId, clickedButton) {
            // 모든 탭 버튼/패널 비활성화
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-panel').forEach(panel => panel.classList.remove('active'));

            // 선택된 탭 활성화
            clickedButton.classList.add('active');
            const targetPanel = document.getElementById(tabId);
            if (targetPanel) {
                targetPanel.classList.add('active');

                // AI 서치 탭 선택 시 자동 분석 시작
                if (tabId === 'ai-search' && !analysisCompleted) {
                    setTimeout(startEnhancedAnalysis, 300);
                }
                // 접촉이력 탭 선택 시 데이터 로드
                if (tabId === 'contact-history') {
                    setTimeout(loadContactHistory, 200);
                }
            }
        }

        // 종합 분석 시작 함수 (애니메이션 시작)
        function startComprehensiveAnalysis() {
            if (analysisCompleted) return;

            const analysisSteps = document.getElementById('analysisSteps');
            if (!analysisSteps) return;

            // 초기화
            analysisSteps.innerHTML = '';
            if (analysisStepInterval) clearInterval(analysisStepInterval);

            const steps = [
                '? 재무 데이터 수집 중...',
                '? 주주 구성 및 지배구조 분석...',
                '? 동종 업계 트렌드 비교...',
                '?? 리스크 요인 진단...',
                '? 최종 리포트 생성 중...'
            ];

            let stepIndex = 0;
            // 첫 단계 즉시 표시
            const firstStep = document.createElement('div');
            firstStep.className = 'step';
            firstStep.textContent = steps[0];
            analysisSteps.appendChild(firstStep);
            stepIndex++;

            // 실제 분석 요청
            performComprehensiveAnalysis();

            // 단계별 애니메이션
            analysisStepInterval = setInterval(() => {
                if (stepIndex < steps.length) {
                    const stepDiv = document.createElement('div');
                    stepDiv.className = 'step';
                    stepDiv.textContent = steps[stepIndex];
                    analysisSteps.appendChild(stepDiv);

                    // 스크롤 자동 내리기
                    const container = document.getElementById('comprehensiveReport');
                    if (container) container.scrollTop = container.scrollHeight;

                    stepIndex++;
                } else {
                    clearInterval(analysisStepInterval);
                }
            }, 1500); // 1.5초마다 메시지 변경
        }

        // 실제 API 호출 함수 (타임아웃 90초 설정)
        function performComprehensiveAnalysis() {
            const reportDiv = document.getElementById('comprehensiveReport');

            // 분석 프롬프트 생성
            const prompt = `
Role: 전문 경영 컨설턴트
Task: [${currentCompanyName}] 기업에 대한 종합 경영 진단 보고서 작성

분석 데이터:
- 기업명: ${currentCompanyName}
- 사업자번호: ${currentBizNo}
- 대표자: ${document.getElementById('ceo-name') ? document.getElementById('ceo-name').textContent : '정보없음'}

다음 목차로 HTML 형식(h3, ul, li, p, strong 태그 사용)의 보고서를 작성해주세요:
1. Executive Summary (경영 현황 요약)
2. 재무 건전성 및 성장성 진단
3. 주요 리스크 요인 및 대응 방안
4. CEO를 위한 전략적 제언 (세무, 승계, 자금 등)

* 형식: 깔끔하고 가독성 높은 HTML 스타일 (CSS 클래스 제외, 인라인 스타일 지양)
            `;

            console.log('[DEBUG] AI 분석 API 요청 시작');

            // 90초 타임아웃 설정
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 90000);

            fetch('/api/ai-analysis', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    query: prompt,
                    biz_no: currentBizNo,
                    company_name: currentCompanyName
                }),
                signal: controller.signal
            })
                .then(response => {
                    if (!response.ok) throw new Error('Network response error');
                    return response.json();
                })
                .then(data => {
                    clearTimeout(timeoutId);
                    if (analysisStepInterval) clearInterval(analysisStepInterval); // 로딩 종료

                    if (data.success) {
                        displayComprehensiveReport(data.result);
                        analysisCompleted = true;
                    } else {
                        throw new Error(data.message || '분석 실패');
                    }
                })
                .catch(error => {
                    clearTimeout(timeoutId);
                    if (analysisStepInterval) clearInterval(analysisStepInterval); // 로딩 종료

                    console.error('[ERROR]', error);
                    let msg = '분석 중 오류가 발생했습니다.';
                    if (error.name === 'AbortError') msg = '분석 시간이 너무 오래 걸려 중단되었습니다.';
                    showAnalysisError(msg + ' (잠시 후 다시 시도해주세요)');
                });
        }

        // 결과 표시 함수
        function displayComprehensiveReport(result) {
            const reportDiv = document.getElementById('comprehensiveReport');
            // 줄바꿈 처리 및 HTML 포맷팅
            let formatted = result;
            if (!result.includes('<div') && !result.includes('<h')) {
                formatted = result.replace(/\n/g, '<br>').replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            }

            reportDiv.innerHTML = `
                <div style="background: white; padding: 30px; border-radius: 15px; box-shadow: 0 4px 20px rgba(0,0,0,0.05);">
                    <div style="border-bottom: 2px solid #4a9fd9; margin-bottom: 20px; padding-bottom: 10px;">
                        <h2 style="color: #2c5aa0; margin: 0;">? AI 종합 분석 결과</h2>
                    </div>
                    <div style="line-height: 1.8; color: #333; font-size: 15px;">
                        ${formatted}
                    </div>
                    <div style="margin-top: 30px; text-align: right; font-size: 12px; color: #888;">
                        * 본 분석은 AI에 의해 생성되었으며, 참고용으로만 활용하시기 바랍니다.
                    </div>
                    <div style="margin-top: 20px; text-align: center;">
                        <button onclick="analysisCompleted=false; startComprehensiveAnalysis()" 
                                style="padding: 10px 20px; background: #6c757d; color: white; border: none; border-radius: 5px; cursor: pointer;">
                            ? 다시 분석하기
                        </button>
                    </div>
                </div>
            `;
        }

        // 에러 표시 함수
        function showAnalysisError(msg) {
            const reportDiv = document.getElementById('comprehensiveReport');
            reportDiv.innerHTML = `
                <div style="text-align: center; padding: 40px; color: #dc3545;">
                    <div style="font-size: 48px; margin-bottom: 20px;">??</div>
                    <h3>분석을 완료하지 못했습니다</h3>
                    <p>${msg}</p>
                    <button onclick="analysisCompleted=false; startComprehensiveAnalysis()" 
                            style="margin-top: 20px; padding: 10px 20px; background: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer;">
                        다시 시도
                    </button>
                </div>
            `;
        }

        // --- 기타 기존 함수들 (접촉이력, 모달 등) ---
        // (이 부분은 기존 코드의 loadContactHistory, openPioneeringModal 등을 유지하거나 
        // 위에서 제공된 코드의 나머지 부분을 그대로 사용하시면 됩니다.)

        function loadContactHistory() {
            const tableBody = document.getElementById('contactHistoryTable');
            if (!tableBody) return;

            tableBody.innerHTML = '<tr><td colspan="8" style="text-align:center; padding:20px;">로딩 중...</td></tr>';

            fetch(`/api/contact_history?biz_no=${currentBizNo}`)
                .then(res => res.json())
                .then(data => {
                    if (data.success && data.histories.length > 0) {
                        let html = '';
                        data.histories.forEach(h => {
                            html += `
                            <tr style="border-bottom: 1px solid #eee;">
                                <td style="padding:10px;">${h.contact_datetime}</td>
                                <td style="padding:10px;">${h.biz_no}</td>
                                <td style="padding:10px;">${h.company_name}</td>
                                <td style="padding:10px;">${h.contact_type}</td>
                                <td style="padding:10px;">${h.contact_person}</td>
                                <td style="padding:10px;">${h.memo}</td>
                                <td style="padding:10px;">${h.registered_by_name || h.registered_by}</td>
                                <td style="padding:10px;">-</td>
                            </tr>
                        `;
                        });
                        tableBody.innerHTML = html;
                    } else {
                        tableBody.innerHTML = '<tr><td colspan="8" style="text-align:center; padding:20px;">접촉이력이 없습니다.</td></tr>';
                    }
                })
                .catch(err => {
                    tableBody.innerHTML = '<tr><td colspan="8" style="text-align:center; padding:20px; color:red;">데이터 로드 실패</td></tr>';
                });
        }

        // 페이지 로드 시 초기화
        document.addEventListener('DOMContentLoaded', function () {
            console.log('페이지 로드 완료');
            // 필요 시 초기화 로직 추가
        });
    </script>

    <!-- 접촉이력 등록/수정 모달 -->
    <div id="contactHistoryModal" class="modal"
        style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); z-index: 1000;">
        <div class="modal-content"
            style="position: relative; margin: 5% auto; padding: 20px; width: 80%; max-width: 600px; background: white; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
            <span class="close" onclick="closeContactModal()"
                style="position: absolute; top: 15px; right: 20px; font-size: 28px; font-weight: bold; cursor: pointer; color: #aaa;">&times;</span>
            <h3 id="contactModalTitle" style="margin-top: 0; color: #333;">접촉이력 등록</h3>

            <form id="contactHistoryForm" style="margin-top: 20px;">
                <input type="hidden" id="contactHistoryId" value="">

                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: bold; color: #333;">접촉일시 *</label>
                    <input type="datetime-local" id="contactDatetime" required
                        style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                </div>

                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: bold; color: #333;">접촉유형 *</label>
                    <select id="contactType" required
                        style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                        <option value="">선택하세요</option>
                        <option value="방문">방문</option>
                        <option value="전화">전화</option>
                        <option value="이메일">이메일</option>
                        <option value="회의">회의</option>
                        <option value="기타">기타</option>
                    </select>
                </div>

                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: bold; color: #333;">접촉자</label>
                    <input type="text" id="contactPerson"
                        style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;"
                        placeholder="담당자명">
                </div>

                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: bold; color: #333;">메모</label>
                    <textarea id="contactMemo" rows="4"
                        style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; resize: vertical;"
                        placeholder="접촉 내용을 입력하세요"></textarea>
                </div>

                <div style="text-align: right;">
                    <button type="button" onclick="closeContactModal()"
                        style="background: #6c757d; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; margin-right: 10px;">취소</button>
                    <button type="submit"
                        style="background: #007bff; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer;">저장</button>
                </div>
            </form>
        </div>
    </div>

    {% endif %}
</body>

</html>

// 클릭된 버튼을 활성화
clickedButton.classList.add('active');

// 해당 탭 패널 표시
const targetPanel = document.getElementById(tabId);
if (targetPanel) {
targetPanel.classList.add('active');
console.log('탭 전환 성공:', tabId);

// AI 서치 탭인 경우 분석 시작
if (tabId === 'ai-search') {
setTimeout(() => {
startComprehensiveAnalysis();
}, 300);
}

// 접촉이력 탭인 경우 데이터 로드
if (tabId === 'contact-history') {
setTimeout(() => {
loadContactHistory();
}, 200);
}
} else {
console.error('탭 패널을 찾을 수 없음:', tabId);
}
}

// 탭 전환 함수 (완전히 개선된 버전)
function switchTab(tabId, event) {
console.log('=== switchTab 호출 ===');
console.log('tabId:', tabId);
console.log('event:', event);

try {
// 이벤트 전파 방지
if (event) {
event.preventDefault();
event.stopPropagation();
}

// 현재 모든 탭 버튼과 패널 상태 확인
const allButtons = document.querySelectorAll('.tab-button');
const allPanels = document.querySelectorAll('.tab-panel');
console.log('발견된 탭 버튼 수:', allButtons.length);
console.log('발견된 탭 패널 수:', allPanels.length);

// 모든 탭 버튼에서 active 클래스 제거
allButtons.forEach((btn, i) => {
console.log(`버튼 ${i}: ${btn.textContent.trim()} - 활성화 해제`);
btn.classList.remove('active');
});

// 모든 탭 패널 숨김
allPanels.forEach((panel, i) => {
console.log(`패널 ${i}: ${panel.id} - 숨김`);
panel.classList.remove('active');
});

// 클릭한 탭 버튼에 active 클래스 추가
if (event && event.target) {
console.log('이벤트 타겟으로 버튼 활성화:', event.target.textContent.trim());
event.target.classList.add('active');
} else {
// ID로 버튼 찾아서 활성화
const targetButton = document.getElementById('tab-' + tabId);
if (targetButton) {
console.log('ID로 버튼 찾아서 활성화:', targetButton.textContent.trim());
targetButton.classList.add('active');
} else {
console.error('버튼을 찾을 수 없음: tab-' + tabId);
}
}

// 해당 탭 패널 표시
const targetPanel = document.getElementById(tabId);
if (targetPanel) {
console.log('타겟 패널 활성화:', tabId);
targetPanel.classList.add('active');
console.log('=== 탭 전환 성공 ===');
} else {
console.error('탭 패널을 찾을 수 없음:', tabId);
// 모든 패널 ID 출력해서 디버깅
allPanels.forEach(panel => console.log('사용가능한 패널 ID:', panel.id));
}

// AI 서치 탭으로 전환시 종합 분석 실행
if (tabId === 'ai-search') {
console.log('AI 서치 탭 - 종합 분석 시작');
setTimeout(() => {
if (typeof startComprehensiveAnalysis === 'function') {
startComprehensiveAnalysis();
} else {
console.log('startComprehensiveAnalysis 함수가 정의되지 않음');
}
}, 300);
}

// 접촉이력 탭으로 전환시 데이터 로드
if (tabId === 'contact-history') {
console.log('접촉이력 탭 - 데이터 로드 시작');
setTimeout(() => {
if (typeof loadContactHistory === 'function') {
loadContactHistory();
} else {
console.log('loadContactHistory 함수가 정의되지 않음');
}
}, 200);
}

} catch (error) {
console.error('탭 전환 중 오류 발생:', error);
}
}

// 페이지 로드 완료 후 탭 이벤트 리스너 추가
document.addEventListener('DOMContentLoaded', function() {
console.log('=== DOM 로드 완료 - 탭 시스템 초기화 ===');

// 탭 버튼들 상태 확인
const tabButtons = document.querySelectorAll('.tab-button');
console.log('탭 버튼 개수:', tabButtons.length);

tabButtons.forEach((button, index) => {
console.log(`탭 버튼 ${index}: ${button.textContent.trim()}, ID: ${button.id}`);

// 기존 이벤트 리스너 제거 후 새로 추가
button.removeEventListener('click', handleTabClick);
button.addEventListener('click', handleTabClick);
});

function handleTabClick(e) {
console.log('=== 탭 버튼 클릭 감지 ===');
console.log('클릭된 버튼:', this.textContent.trim());
console.log('버튼 ID:', this.id);

const tabIds = ['company-info', 'ai-search', 'contact-history'];
const buttonTexts = ['기업 신상 조회', 'AI 서치', '접촉이력 조회'];

// 버튼 텍스트로 탭 ID 찾기
let targetTabId = null;
const buttonText = this.textContent.trim();

if (buttonText.includes('기업 신상') || buttonText.includes('기업신상')) {
targetTabId = 'company-info';
} else if (buttonText.includes('AI') || buttonText.includes('서치')) {
targetTabId = 'ai-search';
} else if (buttonText.includes('접촉이력') || buttonText.includes('이력')) {
targetTabId = 'contact-history';
}

console.log('결정된 탭 ID:', targetTabId);

if (targetTabId) {
switchTab(targetTabId, e);
} else {
console.error('탭 ID를 결정할 수 없음:', buttonText);
}
}

console.log('=== 탭 시스템 초기화 완료 ===');
});

// 종합 분석 변수
let analysisCompleted = false;
let questionCount = 0;
const maxQuestions = 5;

// 종합 분석 시작 함수 (개선된 버전)
function startComprehensiveAnalysis() {
console.log('[DEBUG] AI 분석 시작 요청');

if (analysisCompleted) {
console.log('[INFO] 이미 분석 완료됨');
return; // 이미 분석이 완료된 경우 중복 실행 방지
}

// 기업 정보 확인
if (!currentBizNo || !currentCompanyName) {
console.error('[ERROR] 기업 정보 부족:', { currentBizNo, currentCompanyName });
showAnalysisError('기업 정보가 부족합니다.');
return;
}

const reportDiv = document.getElementById('comprehensiveReport');
const analysisSteps = document.getElementById('analysisSteps');

// 분석 단계 시뮬레이션
const steps = [
'? 재무 데이터 분석 중...',
'? 주주 구성 검토 중...',
'? 비상장 주식 평가 중...',
'? 기업 현황 종합 분석 중...',
'? 전략적 제언 수립 중...'
];

let stepIndex = 0;
const stepInterval = setInterval(() => {
if (stepIndex < steps.length) { const stepDiv=document.createElement('div'); stepDiv.className='step' ;
    stepDiv.textContent=steps[stepIndex]; stepDiv.style.animationDelay=`${stepIndex * 0.1}s`;
    analysisSteps.appendChild(stepDiv); stepIndex++; } else { clearInterval(stepInterval); // 실제 AI 분석 호출
    performComprehensiveAnalysis(); } }, 800); } // 실제 종합 분석 실행 function performComprehensiveAnalysis() { const
    reportDiv=document.getElementById('comprehensiveReport'); const
    analysisStatus=document.getElementById('analysisStatus'); // 실제 데이터로 종합 분석 프롬프트 생성 const companyData={ bizNo:
    currentBizNo || '{{ company.biz_no if company else "1018139184" }}' , companyName: currentCompanyName
    || '{{ company.company_name if company else "동화에이스" }}' , ceoName: document.getElementById('ceo-name') ?
    document.getElementById('ceo-name').textContent : '{{ company.representative_name if company else "서영원" }}' ,
    industry: '{{ company.industry_name if company else "육상 및 항공 운송업" }}' ,
    establishDate: '{{ company.establish_date if company else "1970-01-01" }}' ,
    companySize: '{{ company.company_size if company else "소기업" }}' ,
    listingStatus: '{{ company.listing_status if company else "BB" }}' ,
    address: '{{ company.address if company else "서울 서초구 바우뛰로 184, 5층" }}' ,
    gfcStatus: '{{ "Y" if company and company.is_gfc == "1" else "N" }}' }; // 재무 데이터 수집 const financialData=[]; const
    financialRows=document.querySelectorAll('.financial-table tbody tr'); financialRows.forEach((row, index)=> {
    if (index < 6) { // 주요 재무 항목만 const cells=row.querySelectorAll('td'); if (cells.length>= 4) {
        const itemName = cells[0].textContent;
        const year1 = cells[1].textContent.replace(/,/g, '');
        const year2 = cells[2].textContent.replace(/,/g, '');
        const year3 = cells[3].textContent.replace(/,/g, '');
        financialData.push({ item: itemName, year1, year2, year3 });
        }
        }
        });

        // 주주 데이터 수집
        const shareholderData = [];
        const shareholderRows = document.querySelectorAll('table tbody tr');
        shareholderRows.forEach(row => {
        const cells = row.querySelectorAll('td');
        if (cells.length >= 5) {
        const name = cells[0].textContent.trim();
        const shares = cells[1].textContent;
        const percentage = cells[2].textContent;
        const value = cells[3].textContent;
        if (name && name !== '정보없음' && !name.includes('주주 정보가 없습니다')) {
        shareholderData.push({ name, shares, percentage, value });
        }
        }
        });

        const comprehensivePrompt = `■■ ${companyData.companyName} 기업 종합 분석 리포트 ■■

        다음 기업에 대해 전문적이고 실용적인 경영 컨설팅 분석을 수행해주세요.

        ■ 기업 기본 정보
        - 기업명: ${companyData.companyName}
        - 사업자번호: ${companyData.bizNo}
        - 대표자: ${companyData.ceoName}
        - 업종: ${companyData.industry}
        - 설립일: ${companyData.establishDate}
        - 기업규모: ${companyData.companySize}
        - 신용등급: ${companyData.listingStatus}
        - 주소: ${companyData.address}
        - GFC거래여부: ${companyData.gfcStatus}

        ■ 재무 현황 (최근 3개년)
        ${financialData.map(item => `${item.item}: 2024년 ${item.year1}원, 2023년 ${item.year2}원, 2022년
        ${item.year3}원`).join('\n')}

        ■ 주주 구성 현황
        ${shareholderData.length > 0 ? shareholderData.map(sh => `- ${sh.name}: ${sh.percentage} (${sh.shares}, 가치:
        ${sh.value})`).join('\n') : '주주 정보 없음'}

        ■ 비상장주식 평가 (원고율 기준)
        - 저가차 평가가치: 22,510,097,000원
        - 수정가치 평가가치: 22,586,066,667원
        - 1주당 평가액: 9,197원 (평가일자 기준 491,900주)
        - 평가방법: 원고율 기준 수익가치 및 순자산가치 종합 평가
        - 주식가치 변동요인: 재무성과, 수익성, 성장성 반영

        ● 전문 경영컨설팅 분석 요청사항 ●

        다음 6개 분야에 대해 체계적이고 실무적인 경영컨설팅 리포트를 작성해주세요:

        **1. ? 재무 건전성 및 성장성 종합분석**
        - 3개년 재무성과 트렌드 분석 (매출성장률, 수익성 지표)
        - 재무안정성 평가 (유동성, 레버리지, 활동성 비율)
        - ROE, ROA, 매출액순이익률 등 수익성 지표 분석
        - 이익잉여금 규모 및 배당여력 평가
        - 현금흐름 및 운전자본 관리 상태
        - 동종업계 대비 재무성과 벤치마킹

        **2. ? 주주구조 및 지배구조 분석**
        - 주요주주 지분구조 및 경영권 집중도 분석
        - 소액주주 보호 및 주주권 행사 방안
        - 경영진과 주주간 이해관계 조정 방안
        - 적대적 M&A 방어 전략 수립
        - 이사회 구성 및 의사결정구조 개선방안

        **3. ? 대표자 및 경영진 핵심과제**
        - **가업승계 전략**: 세대교체 로드맵 및 세무최적화
        - **배당정책**: 주주환원 정책 수립 및 배당성향 결정
        - **퇴직급여**: 대표자 및 임원 퇴직금 최적화 방안
        - **보상체계**: 성과연동 임원보수 설계
        - **승계준비**: 후계자 육성 및 경영권 이전 계획
        - **세무전략**: 증여/상속세 절세 방안

        **4. ? 업종특화 경쟁력 및 성장전략**
        - ${companyData.industry} 업종 특성 및 시장환경 분석
        - 경쟁사 대비 차별화 요소 및 경쟁우위 발굴
        - 디지털 전환 및 기술혁신 적용방안
        - 신시장 진출 및 사업다각화 기회
        - 고객세분화 및 마케팅 전략 개선
        - 공급망 최적화 및 운영효율성 제고

        **5. ?? 리스크 관리 및 위기대응**
        - **재무리스크**: 유동성, 신용, 시장리스크 관리
        - **영업리스크**: 매출집중, 고객이탈, 공급망 리스크
        - **규제리스크**: 법규준수, 환경규제, 세무리스크
        - **경영리스크**: 핵심인력 의존도, 정보보안
        - ESG 경영 도입 및 지속가능성 제고
        - 비상계획 수립 및 위기관리 매뉴얼

        **6. ? 5년간 전략 로드맵**
        - **1년차**: 단기 수익성 개선 및 효율화
        - **2-3년차**: 성장기반 구축 및 시장확대
        - **4-5년차**: 지속가능 성장 및 가치창출
        - 핵심성과지표(KPI) 설정 및 모니터링
        - 단계별 투자계획 및 자금조달 방안
        - 목표 재무성과 및 기업가치 제고 계획

        각 분야별로 **구체적이고 실행가능한 액션플랜**을 제시하되, ${companyData.companyName}의 업종(${companyData.industry}),
        규모(${companyData.companySize}), 재무상황에 특화된 맞춤형 전략을 수립해주세요.

        특히 **중소기업 특성을 고려**하여 현실적이고 실용적인 방안을 중심으로 제안해주시기 바랍니다.`;

        console.log('[DEBUG] API 요청 시작:', {
        biz_no: companyData.bizNo,
        company: companyData.companyName,
        promptLength: comprehensivePrompt.length
        });

        // 30초 타임아웃 설정
        const controller = new AbortController();
        const timeoutId = setTimeout(() => {
        controller.abort();
        document.getElementById('ai-analysis-content').innerHTML = `
        <div style="padding: 20px; text-align: center; color: #dc3545;">
            <h4>? AI 분석 요청 시간 초과</h4>
            <p>AI 서비스 응답 시간이 30초를 초과했습니다.<br>
                잠시 후 다시 시도해주세요.</p>
            <button onclick="startAIAnalysis()" class="btn btn-primary">다시 시도</button>
        </div>
        `;
        }, 30000);

        fetch('/api/ai-analysis', {
        method: 'POST',
        headers: {
        'Content-Type': 'application/json',
        },
        body: JSON.stringify({
        query: comprehensivePrompt,
        biz_no: companyData.bizNo,
        company_name: companyData.companyName
        }),
        signal: controller.signal
        })
        .then(response => {
        console.log('[DEBUG] API 응답 수신:', response.status);
        return response.json();
        })
        .then(data => {
        console.log('[DEBUG] API 응답 데이터:', data);

        // 결과 데이터 찾기 (다양한 키 지원)
        const result = data.result || data.response || data.analysis;

        if (data.success && result) {
        console.log('[SUCCESS] AI 분석 결과 수신:', result.substring(0, 100) + '...');
        displayComprehensiveReport(result);

        // 성공 알림
        if (data.note) {
        console.log('[INFO]', data.note);
        }
        } else {
        const errorMsg = data.message || '분석 결과를 받을 수 없습니다.';
        console.error('[ERROR] API 응답 오류:', errorMsg);
        console.log('[DEBUG] 전체 응답:', data);
        showAnalysisError(errorMsg);
        }
        })
        .catch(error => {
        console.error('[ERROR] API 호출 실패:', error);
        showAnalysisError(`네트워크 오류가 발생했습니다: ${error.message}`);
        });
        }

        // 종합 분석 결과 표시
        function displayComprehensiveReport(analysisResult) {
        console.log('[DISPLAY] 결과 표시 시도:', analysisResult ? analysisResult.length + '자' : '비어있음');

        // 여러 가능한 컨테이너 ID 확인
        const reportDiv = document.getElementById('comprehensiveReport') ||
        document.getElementById('ai-analysis-content');
        const analysisStatus = document.getElementById('analysisStatus');
        const followupSection = document.getElementById('followupSection');

        if (!reportDiv) {
        console.error('[ERROR] 분석 결과 컨테이너를 찾을 수 없습니다');
        alert('분석 결과를 표시할 영역을 찾을 수 없습니다. 페이지를 새로고침 해주세요.');
        return;
        }

        // 상태 업데이트
        if (analysisStatus) {
        analysisStatus.innerHTML = '<span class="status-indicator completed">? 분석 완료</span>';
        }

        console.log('[FORMAT] 결과 포맷팅 시작:', analysisResult.substring(0, 200));

        // 간단하고 안전한 포맷팅 - HTML이 이미 포함된 경우 그대로 사용
        let formattedResult;
        if (analysisResult.includes('<div') || analysisResult.includes('<h')) { // 이미 HTML 포맷팅이 된 경우 그대로 사용
            formattedResult=analysisResult; console.log('[FORMAT] HTML 형식 감지 - 그대로 사용'); } else { // 텍스트인 경우 기본 포맷팅 적용
            formattedResult=analysisResult .replace(/\n/g, '<br>' ) .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>' )
            .replace(/\*(.*?)\*/g, '<em>$1</em>' ); console.log('[FORMAT] 텍스트 형식 감지 - 기본 포맷팅 적용'); } // 결과를 즉시 표시 (복잡한
            포맷팅 제거) console.log('[DISPLAY] 결과 표시 중...'); try { reportDiv.innerHTML=` <div
            style="padding: 20px; background: white; border-radius: 12px; margin: 10px 0;">
            <div
                style="background: linear-gradient(135deg, #4a90e2 0%, #357abd 100%); color: white; padding: 20px; margin: -20px -20px 20px -20px; border-radius: 12px 12px 0 0; text-align: center;">
                <h2 style="margin: 0; font-size: 24px;">? AI 분석 결과</h2>
                <p style="margin: 10px 0 0 0; opacity: 0.9;">즉시 분석 완료</p>
            </div>
            <div style="margin-top: 20px;">
                ${formattedResult}
            </div>
            </div>
            `;

            console.log('[SUCCESS] 분석 결과 표시 완료');

            // 스크롤하여 결과 표시
            reportDiv.scrollIntoView({ behavior: 'smooth' });

            } catch (error) {
            console.error('[ERROR] 결과 표시 중 오류:', error);
            reportDiv.innerHTML = `
            <div style="padding: 20px; background: #f8d7da; color: #721c24; border-radius: 8px; text-align: center;">
                <h3>?? 표시 오류</h3>
                <p>분석 결과를 표시하는 중 오류가 발생했습니다.</p>
                <button onclick="location.reload()"
                    style="padding: 8px 16px; background: #dc3545; color: white; border: none; border-radius: 4px; cursor: pointer;">페이지
                    새로고침</button>
            </div>
            `;
            }

            // 후속 섹션 활성화
            if (followupSection) {
            followupSection.style.display = 'block';
            </p>
            </div>
            </div>
            `;

            // 추가 질문 섹션 표시
            followupSection.style.display = 'block';
            analysisCompleted = true;

            // 부드러운 스크롤로 결과 섹션으로 이동
            setTimeout(() => {
            reportDiv.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }, 500);
            }

            // 분석 오류 표시 (개선된 버전)
            function showAnalysisError(message) {
            const reportDiv = document.getElementById('comprehensiveReport');
            const analysisStatus = document.getElementById('analysisStatus');

            console.error('[ERROR] AI 분석 오류:', message);

            analysisStatus.innerHTML = '<span class="status-indicator" style="background: #f8d7da; color: #721c24;">분석
                실패</span>';
            reportDiv.innerHTML = `
            <div
                style="text-align: center; padding: 50px; color: #dc3545; background: rgba(248, 215, 218, 0.1); border-radius: 15px;">
                <div style="font-size: 48px; margin-bottom: 20px;">??</div>
                <h4>분석을 완료할 수 없습니다</h4>
                <p style="margin: 15px 0; color: #6c757d;">${message}</p>
                <div style="margin-top: 25px;">
                    <button onclick="performComprehensiveAnalysis()"
                        style="margin: 5px; padding: 12px 24px; background: #6f42c1; color: white; border: none; border-radius: 8px; cursor: pointer;">분석
                        다시 시도</button>
                    <button onclick="analysisCompleted=false; startComprehensiveAnalysis()"
                        style="margin: 5px; padding: 12px 24px; background: #28a745; color: white; border: none; border-radius: 8px; cursor: pointer;">처음부터
                        다시</button>
                </div>
                <div style="margin-top: 20px; font-size: 12px; color: #6c757d;">
                    문제가 지속되면 네트워크 연결과 API 키 설정을 확인해주세요.
                </div>
            </div>
            `;
            }

            // 추가 질문하기
            function askFollowupQuestion() {
            if (questionCount >= maxQuestions) {
            alert('최대 5개까지만 질문할 수 있습니다.');
            return;
            }

            const questionInput = document.getElementById('followupQuestion');
            const question = questionInput.value.trim();

            if (!question) {
            alert('질문을 입력해주세요.');
            return;
            }

            // 버튼 비활성화
            const askButton = document.getElementById('askButton');
            askButton.disabled = true;
            askButton.textContent = '답변 중...';

            // API 호출
            fetch('/api/ai-analysis', {
            method: 'POST',
            headers: {
            'Content-Type': 'application/json',
            },
            body: JSON.stringify({
            query: question + '\n\n위의 기업 분석 결과를 참고하여 답변해주세요.'
            })
            })
            .then(response => response.json())
            .then(data => {
            if (data.success) {
            addQAToHistory(question, data.result);
            questionCount++;
            updateQuestionCounter();
            questionInput.value = '';
            } else {
            alert('답변을 가져올 수 없습니다: ' + data.message);
            }
            })
            .catch(error => {
            console.error('Question error:', error);
            alert('질문 처리 중 오류가 발생했습니다.');
            })
            .finally(() => {
            askButton.disabled = false;
            askButton.textContent = '질문하기';
            });
            }

            // 추천 질문 선택
            function askSuggestion(suggestionText) {
            document.getElementById('followupQuestion').value = suggestionText;
            askFollowupQuestion();
            }

            // Q&A 히스토리에 추가
            function addQAToHistory(question, answer) {
            const historyDiv = document.getElementById('qaHistory');
            const qaItem = document.createElement('div');
            qaItem.className = 'qa-item';
            qaItem.innerHTML = `
            <div class="qa-question">Q${questionCount + 1}. ${question}</div>
            <div class="qa-answer">${answer.replace(/\n/g, '<br>')}</div>
            `;
            historyDiv.appendChild(qaItem);
            }

            // 질문 카운터 업데이트
            function updateQuestionCounter() {
            document.getElementById('questionCount').textContent = questionCount;

            if (questionCount >= maxQuestions) {
            document.getElementById('askButton').disabled = true;
            document.getElementById('followupQuestion').disabled = true;
            document.getElementById('askButton').textContent = '질문 한도 초과';
            }
            }


            // 기업 검색 함수
            function searchCompany() {
            const searchValue = document.getElementById('company-search').value;

            if (searchValue.trim()) {
            // 검색 로직 구현
            console.log('검색어:', searchValue);
            // 실제 구현 시 AJAX 호출로 데이터 업데이트
            alert('검색 기능은 개발 중입니다: ' + searchValue);
            }
            }

            // 개척등록 모달창 열기
            function registerPioneering() {
            console.log('개척등록 버튼 클릭됨');
            try {
            // 오늘 날짜로 기본값 설정
            const today = new Date().toISOString().split('T')[0];

            const visitDateEl = document.getElementById('visitDate');
            const memoEl = document.getElementById('memo');
            const modalEl = document.getElementById('pioneeringModal');

            console.log('요소 확인:', {
            visitDate: !!visitDateEl,
            memo: !!memoEl,
            modal: !!modalEl
            });

            if (visitDateEl) visitDateEl.value = today;
            if (memoEl) memoEl.value = '개척 관련 메모사항...';

            // 모달창 표시
            if (modalEl) {
            modalEl.style.display = 'block';
            console.log('모달창 표시됨');
            } else {
            console.error('모달창을 찾을 수 없음');
            }
            } catch (error) {
            console.error('개척등록 함수 오류:', error);
            }
            }

            // 개척등록 모달창 닫기
            function closePioneeringModal() {
            document.getElementById('pioneeringModal').style.display = 'none';
            }

            // 실제 개척등록 실행
            function submitPioneering() {
            const companyName = document.getElementById('companyName').value;
            const bizNo = document.getElementById('bizNo').value;
            const visitDate = document.getElementById('visitDate').value;
            const memo = document.getElementById('memo').value;

            // 필수 입력 검증
            if (!visitDate) {
            alert('방문일자를 입력해주세요.');
            return;
            }

            // API 호출로 개척 대상 등록
            fetch('/api/pioneering_targets', {
            method: 'POST',
            headers: {
            'Content-Type': 'application/json',
            },
            body: JSON.stringify({
            company_name: companyName,
            biz_no: bizNo,
            visit_date: visitDate,
            notes: memo || '기업상세조회에서 등록'
            })
            })
            .then(response => response.json())
            .then(data => {
            if (data.success) {
            alert('개척 대상으로 성공적으로 등록되었습니다.');
            closePioneeringModal();
            } else {
            alert('등록 실패: ' + (data.message || '알 수 없는 오류'));
            }
            })
            .catch(error => {
            console.error('Error:', error);
            alert('등록 중 오류가 발생했습니다.');
            });
            }

            // 모달창 외부 클릭시 닫기
            window.onclick = function(event) {
            const modal = document.getElementById('pioneeringModal');
            if (event.target === modal) {
            closePioneeringModal();
            }
            }

            // 대표자명 수정 함수
            function editCeoName() {
            const ceoNameElement = document.getElementById('ceo-name');
            const currentName = ceoNameElement.textContent;

            // 마스킹된 이름인지 확인 (예: 서*원, 서**, 등)
            if (currentName.includes('*')) {
            // AI를 통해 실제 이름 검색
            searchRealCeoName(currentBizNo, currentCompanyName);
            } else {
            // 일반 수정
            const newName = prompt('새로운 대표자명을 입력하세요:', currentName);
            if (newName && newName.trim()) {
            updateCeoName(newName.trim());
            }
            }
            }

            // AI를 통한 실제 대표자명 검색
            function searchRealCeoName(bizNo, companyName) {
            const resultElement = document.getElementById('ceo-name');
            resultElement.textContent = '검색 중...';

            // AI API 호출
            fetch('/api/ai-search-ceo', {
            method: 'POST',
            headers: {
            'Content-Type': 'application/json',
            },
            body: JSON.stringify({
            biz_no: bizNo,
            company_name: companyName
            })
            })
            .then(response => response.json())
            .then(data => {
            if (data.success && data.ceo_name) {
            updateCeoName(data.ceo_name);
            } else {
            resultElement.textContent = '검색 실패';
            alert('대표자명을 찾을 수 없습니다. 직접 입력해주세요.');
            const newName = prompt('대표자명을 입력하세요:');
            if (newName && newName.trim()) {
            updateCeoName(newName.trim());
            } else {
            resultElement.textContent = currentName; // 원래 값으로 복구
            }
            }
            })
            .catch(error => {
            console.error('Error:', error);
            resultElement.textContent = '검색 오류';
            alert('검색 중 오류가 발생했습니다.');
            });
            }

            // 대표자명 업데이트
            function updateCeoName(newName) {
            document.getElementById('ceo-name').textContent = newName;
            document.getElementById('ceo-name-display').textContent = newName;

            // 서버에 업데이트 요청
            fetch('/api/update-ceo-name', {
            method: 'POST',
            headers: {
            'Content-Type': 'application/json',
            },
            body: JSON.stringify({
            biz_no: currentBizNo,
            new_ceo_name: newName
            })
            })
            .then(response => response.json())
            .then(data => {
            if (data.success) {
            console.log('대표자명이 성공적으로 업데이트되었습니다.');
            } else {
            console.error('업데이트 실패:', data.message);
            }
            })
            .catch(error => {
            console.error('Error:', error);
            });
            }

            // AI 검색 함수
            function performAISearch() {
            const query = document.getElementById('ai-query').value.trim();
            if (!query) {
            alert('검색어를 입력해주세요.');
            return;
            }

            const resultContent = document.getElementById('ai-result-content');
            const startTime = new Date();

            // 진행 상황 표시를 위한 HTML 생성
            function updateLoadingDisplay() {
            const elapsed = Math.floor((new Date() - startTime) / 1000);
            const minutes = Math.floor(elapsed / 60);
            const seconds = elapsed % 60;
            const timeStr = minutes > 0 ? `${minutes}분 ${seconds}초` : `${seconds}초`;

            resultContent.innerHTML = `
            <div
                style="background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%); padding: 25px; border-radius: 12px; border: 1px solid #2196f3; text-align: center;">
                <div style="display: flex; align-items: center; justify-content: center; margin-bottom: 15px;">
                    <div
                        style="width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid #2196f3; border-radius: 50%; animation: spin 1s linear infinite; margin-right: 15px;">
                    </div>
                    <h4 style="margin: 0; color: #1976d2; font-size: 18px;">? AI 컨설팅 보고서 작성 중</h4>
                </div>
                <div style="background: rgba(255,255,255,0.9); padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                    <p style="margin: 5px 0; font-size: 14px; color: #424242;"><strong>분석 기업:</strong>
                        ${currentCompanyName}</p>
                    <p style="margin: 5px 0; font-size: 14px; color: #424242;"><strong>분석 질문:</strong> ${query}</p>
                    <p style="margin: 5px 0; font-size: 14px; color: #1976d2;"><strong>진행 시간:</strong> ${timeStr}</p>
                </div>
                <div style="background: #fff3cd; padding: 12px; border-radius: 6px; border-left: 4px solid #ffc107;">
                    <p style="margin: 0; font-size: 13px; color: #856404;">? M&A 전문가 수준의 상세 분석을 준비 중입니다...</p>
                </div>
            </div>
            <style>
                @keyframes spin {
                    0% {
                        transform: rotate(0deg);
                    }

                    100% {
                        transform: rotate(360deg);
                    }
                }
            </style>
            `;
            }

            // 초기 로딩 화면 표시
            updateLoadingDisplay();

            // 1초마다 시간 업데이트
            const loadingInterval = setInterval(updateLoadingDisplay, 1000);

            fetch('/api/ai-analysis', {
            method: 'POST',
            headers: {
            'Content-Type': 'application/json',
            },
            body: JSON.stringify({
            query: query,
            biz_no: currentBizNo,
            company_name: currentCompanyName
            })
            })
            .then(response => response.json())
            .then(data => {
            clearInterval(loadingInterval);
            if (data.success) {
            // 완료 시 결과 표시
            const elapsed = Math.floor((new Date() - startTime) / 1000);
            const timeStr = elapsed < 60 ? `${elapsed}초` : `${Math.floor(elapsed/60)}분 ${elapsed%60}초`;
                resultContent.innerHTML=` <div
                style="background: #d4edda; padding: 12px; border-radius: 6px; border-left: 4px solid #28a745; margin-bottom: 15px;">
                <p style="margin: 0; font-size: 13px; color: #155724;">? <strong>분석 완료</strong> (소요시간: ${timeStr})</p>
                </div>
                <div style="line-height: 1.6;">${data.result}</div>
                `;
                } else {
                resultContent.innerHTML = `<p style="color: red;">오류: ${data.message}</p>`;
                }
                })
                .catch(error => {
                clearInterval(loadingInterval);
                console.error('Error:', error);
                resultContent.innerHTML = '<p style="color: red;">AI 분석 중 오류가 발생했습니다.</p>';
                });
                }

                // AI 추천 레퍼토리 함수
                function getAIRecommendation() {
                alert('AI 추천 레퍼토리 기능은 개발 중입니다.');
                }

                // 접촉이력 관리 함수들
                function openContactModal() {
                // 접촉이력 등록 모달 열기
                const currentDate = new Date();
                const formattedDate = currentDate.toISOString().slice(0, 16);

                const contactData = {
                datetime: prompt('접촉 날짜와 시간을 입력하세요 (YYYY-MM-DD HH:MM):', formattedDate.replace('T', ' ')),
                type: prompt('접촉 유형을 입력하세요 (전화/방문/이메일/회의):', '전화'),
                person: prompt('접촉 대상자를 입력하세요:', ''),
                memo: prompt('메모를 입력하세요:', '')
                };

                if (contactData.datetime && contactData.type) {
                registerContactHistory(contactData);
                }
                }

                function registerContactHistory(contactData = null) {
                if (!contactData) {
                contactData = {
                datetime: document.getElementById('contactDateTime')?.value,
                type: document.getElementById('contactType')?.value,
                person: document.getElementById('contactPerson')?.value,
                memo: document.getElementById('contactMemo')?.value
                };
                }

                const requestData = {
                biz_no: '{{ company.biz_no if company else "1298602676" }}',
                contact_datetime: contactData.datetime,
                contact_type: contactData.type,
                contact_person: contactData.person || '',
                memo: contactData.memo || ''
                };

                if (!requestData.contact_datetime || !requestData.contact_type) {
                alert('접촉일시와 접촉유형은 필수입니다.');
                return;
                }

                fetch('/api/contact_history', {
                method: 'POST',
                headers: {
                'Content-Type': 'application/json'
                },
                body: JSON.stringify(requestData)
                })
                .then(response => response.json())
                .then(data => {
                if (data.success) {
                alert('접촉이력이 등록되었습니다.');
                loadContactHistory(); // 목록 새로고침
                } else {
                alert('등록 실패: ' + data.message);
                }
                })
                .catch(error => {
                console.error('접촉이력 등록 오류:', error);
                alert('등록 중 오류가 발생했습니다.');
                });
                }

                function searchContactHistory() {
                // 접촉이력 검색
                loadContactHistory();
                }

                function resetContactFilter() {
                // 검색 필터 초기화
                document.getElementById('contact-start-date').value = '';
                document.getElementById('contact-end-date').value = '';
                document.getElementById('contact-search').value = '';
                loadContactHistory();
                }

                function loadContactHistory() {
                const tableBody = document.getElementById('contactHistoryTable');
                tableBody.innerHTML = '<tr>
                    <td colspan="8" style="padding: 20px; text-align: center; color: #6c757d;">접촉이력을 불러오는 중...</td>
                </tr>';

                // API 호출로 접촉이력 데이터 로드
                fetch(`/api/contact_history?biz_no=${currentBizNo}`)
                .then(response => response.json())
                .then(data => {
                if (data.success && data.histories && data.histories.length > 0) {
                displayContactHistory(data.histories);
                } else {
                tableBody.innerHTML = '<tr>
                    <td colspan="8" style="padding: 40px; text-align: center; color: #6c757d;">접촉이력이 없습니다.</td>
                </tr>';
                }
                })
                .catch(error => {
                console.error('Error loading contact history:', error);
                tableBody.innerHTML = '<tr>
                    <td colspan="8" style="padding: 20px; text-align: center; color: #dc3545;">접촉이력 로드 중 오류가 발생했습니다.
                    </td>
                </tr>';
                });
                }

                function displayContactHistory(histories) {
                const tableBody = document.getElementById('contactHistoryTable');
                let html = '';

                histories.forEach((history, index) => {
                const bgColor = index % 2 === 0 ? '#ffffff' : '#f8f9fa';
                const shortMemo = history.memo ? (history.memo.length > 20 ? history.memo.substring(0, 20) + '...' :
                history.memo) : '';

                html += `
                <tr style="background: ${bgColor}; border-bottom: 1px solid #e9ecef;"
                    onmouseover="this.style.background='#e3f2fd'" onmouseout="this.style.background='${bgColor}'">
                    <td style="padding: 12px 8px; color: #495057;">${formatDateTime(history.contact_datetime)}</td>
                    <td style="padding: 12px 8px; color: #6c757d; font-family: 'Courier New', monospace;">
                        ${history.biz_no || ''}</td>
                    <td style="padding: 12px 8px; color: #495057; font-weight: 500;">${history.company_name || ''}</td>
                    <td style="padding: 12px 8px; color: #6c757d;">${history.contact_type || ''}</td>
                    <td style="padding: 12px 8px; color: #6c757d;">${history.contact_person || ''}</td>
                    <td style="padding: 12px 8px; color: #6c757d; position: relative; cursor: pointer;"
                        onmouseover="showMemoTooltip(event, '${escapeHtml(history.memo || '')}')"
                        onmouseout="hideMemoTooltip()">${shortMemo}</td>
                    <td style="padding: 12px 8px; text-align: center; color: #495057;">${history.registered_by_name ||
                        history.registered_by || ''}</td>
                    <td style="padding: 12px 8px; text-align: center;">
                        <button onclick="editContactHistory(${history.id})"
                            style="background: #007bff; color: white; border: none; padding: 4px 8px; border-radius: 4px; font-size: 11px; cursor: pointer; margin-right: 2px;">수정</button>
                        <button onclick="deleteContactHistory(${history.id})"
                            style="background: #dc3545; color: white; border: none; padding: 4px 8px; border-radius: 4px; font-size: 11px; cursor: pointer;">삭제</button>
                    </td>
                </tr>
                `;
                });

                tableBody.innerHTML = html;
                }

                // 메모 툴팁 표시 함수
                function showMemoTooltip(event, memoText) {
                if (!memoText || memoText.trim() === '' || memoText === 'undefined') return;

                // 기존 툴팁 제거
                const existingTooltip = document.getElementById('memoTooltip');
                if (existingTooltip) {
                existingTooltip.remove();
                }

                // 새 툴팁 생성
                const tooltip = document.createElement('div');
                tooltip.id = 'memoTooltip';
                tooltip.style.cssText = `
                position: absolute;
                background: linear-gradient(135deg, #2c3e50, #34495e);
                color: white;
                padding: 12px 16px;
                border-radius: 10px;
                font-size: 13px;
                line-height: 1.5;
                z-index: 1000;
                max-width: 350px;
                min-width: 200px;
                word-wrap: break-word;
                box-shadow: 0 8px 25px rgba(0,0,0,0.3);
                pointer-events: none;
                border: 1px solid rgba(255,255,255,0.1);
                backdrop-filter: blur(10px);
                animation: tooltipFadeIn 0.2s ease-out;
                `;

                // 툴팁 내용 구성
                tooltip.innerHTML = `
                <div style="display: flex; align-items: center; margin-bottom: 8px;">
                    <span style="font-size: 16px; margin-right: 8px;">?</span>
                    <strong style="color: #74b9ff;">메모 상세내용</strong>
                </div>
                <div style="color: #ddd; word-break: break-word;">${memoText}</div>
                `;

                // 애니메이션 CSS 추가
                if (!document.getElementById('tooltipAnimation')) {
                const style = document.createElement('style');
                style.id = 'tooltipAnimation';
                style.textContent = `
                @keyframes tooltipFadeIn {
                from { opacity: 0; transform: translateY(10px) scale(0.9); }
                to { opacity: 1; transform: translateY(0) scale(1); }
                }
                `;
                document.head.appendChild(style);
                }

                // 위치 설정
                document.body.appendChild(tooltip);
                const rect = event.target.getBoundingClientRect();
                const tooltipRect = tooltip.getBoundingClientRect();

                // 화면 바깥쪽 및 위쪽 넘침 방지
                let left = rect.left + window.scrollX;
                let top = rect.top + window.scrollY - tooltipRect.height - 15;

                if (left + tooltipRect.width > window.innerWidth) {
                left = window.innerWidth - tooltipRect.width - 20;
                }
                if (left
                < 10) { left=10; } if (top < window.scrollY + 10) { top=rect.bottom + window.scrollY + 10; // 아래쪽에 표시 }
                    tooltip.style.left=left + 'px' ; tooltip.style.top=top + 'px' ; } // 메모 툴팁 숨김 함수 function
                    hideMemoTooltip() { const tooltip=document.getElementById('memoTooltip'); if (tooltip) {
                    tooltip.remove(); } } // HTML 이스케이프 함수 function escapeHtml(text) { if (!text) return '' ; return
                    text.replace(/'/g, '&#39;' ).replace(/"/g, '&quot;' ).replace(/</g, '&lt;' ).replace( />/g, '&gt;');
                }

                // 날짜시간 포맷 함수
                function formatDateTime(dateTimeStr) {
                if (!dateTimeStr) return '';
                const date = new Date(dateTimeStr);
                return date.toLocaleString('ko-KR', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
                });
                }

                // 접촉이력 수정 함수
                function editContactHistory(historyId) {
                // 기존 접촉이력 데이터를 가져와서 모달에 채움
                fetch(`/api/contact_history?contact_id=${historyId}`)
                .then(response => response.json())
                .then(data => {
                if (data.success && data.histories && data.histories.length > 0) {
                const history = data.histories[0];
                openContactModal(history);
                } else {
                alert('접촉이력 데이터를 불러올 수 없습니다.');
                }
                })
                .catch(error => {
                console.error('Error loading contact history:', error);
                alert('접촉이력 로드 중 오류가 발생했습니다.');
                });
                }

                // 접촉이력 모달 열기 함수
                function openContactModal(historyData = null) {
                const modal = document.getElementById('contactHistoryModal');
                const modalTitle = document.getElementById('contactModalTitle');

                if (historyData) {
                // 수정 모드
                modalTitle.textContent = '접촉이력 수정';
                document.getElementById('contactHistoryId').value = historyData.id;

                // 날짜 형식 변환 (YYYY-MM-DD HH:MM:SS -> YYYY-MM-DDTHH:MM)
                if (historyData.contact_datetime) {
                const dateStr = historyData.contact_datetime.replace(' ', 'T').substring(0, 16);
                document.getElementById('contactDatetime').value = dateStr;
                }

                document.getElementById('contactType').value = historyData.contact_type || '';
                document.getElementById('contactPerson').value = historyData.contact_person || '';
                document.getElementById('contactMemo').value = historyData.memo || '';
                } else {
                // 등록 모드
                modalTitle.textContent = '접촉이력 등록';
                document.getElementById('contactHistoryId').value = '';

                // 현재 시간으로 기본값 설정
                const now = new Date();
                const localDateTime = new Date(now.getTime() - now.getTimezoneOffset() * 60000)
                .toISOString().substring(0, 16);
                document.getElementById('contactDatetime').value = localDateTime;

                document.getElementById('contactType').value = '';
                document.getElementById('contactPerson').value = '';
                document.getElementById('contactMemo').value = '';
                }

                modal.style.display = 'block';
                }

                // 접촉이력 모달 닫기 함수
                function closeContactModal() {
                const modal = document.getElementById('contactHistoryModal');
                modal.style.display = 'none';
                }

                // 접촉이력 등록 함수 (접촉이력 탭에서 호출)
                function addNewContactHistory() {
                openContactModal();
                }

                // 접촉이력 삭제 함수
                function deleteContactHistory(historyId) {
                if (confirm('이 접촉이력을 삭제하시겠습니까?')) {
                fetch(`/api/contact_history/${historyId}`, {
                method: 'DELETE',
                headers: {
                'Content-Type': 'application/json',
                }
                })
                .then(response => response.json())
                .then(data => {
                if (data.success) {
                alert('접촉이력이 성공적으로 삭제되었습니다.');
                loadContactHistory(); // 목록 새로고침
                } else {
                alert('삭제 실패: ' + (data.message || '알 수 없는 오류'));
                }
                })
                .catch(error => {
                console.error('Error:', error);
                alert('삭제 중 오류가 발생했습니다.');
                });
                }
                }

                // 접촉이력 폼 제출 처리
                document.addEventListener('DOMContentLoaded', function() {
                const contactForm = document.getElementById('contactHistoryForm');
                if (contactForm) {
                contactForm.addEventListener('submit', function(e) {
                e.preventDefault();

                const historyId = document.getElementById('contactHistoryId').value;
                const contactDatetime = document.getElementById('contactDatetime').value;
                const contactType = document.getElementById('contactType').value;
                const contactPerson = document.getElementById('contactPerson').value;
                const contactMemo = document.getElementById('contactMemo').value;

                if (!contactDatetime || !contactType) {
                alert('접촉일시와 접촉유형은 필수입니다.');
                return;
                }

                const data = {
                biz_no: currentBizNo,
                company_name: currentCompanyName,
                contact_datetime: contactDatetime.replace('T', ' ') + ':00',
                contact_type: contactType,
                contact_person: contactPerson,
                memo: contactMemo
                };

                const url = historyId ? `/api/contact_history/${historyId}` : '/api/contact_history';
                const method = historyId ? 'PUT' : 'POST';

                fetch(url, {
                method: method,
                headers: {
                'Content-Type': 'application/json',
                },
                body: JSON.stringify(data)
                })
                .then(response => response.json())
                .then(result => {
                if (result.success) {
                alert(historyId ? '접촉이력이 성공적으로 수정되었습니다.' : '접촉이력이 성공적으로 등록되었습니다.');
                closeContactModal();
                loadContactHistory(); // 목록 새로고침
                } else {
                alert('처리 실패: ' + (result.message || '알 수 없는 오류'));
                }
                })
                .catch(error => {
                console.error('Error:', error);
                alert('처리 중 오류가 발생했습니다.');
                });
                });
                }
                });

                // 페이지 로드 시 초기화
                document.addEventListener('DOMContentLoaded', function() {
                console.log('기업 상세 페이지 로드 완료');

                // 현재 기업 정보 로그
                console.log('현재 기업:', currentCompanyName, '사업자번호:', currentBizNo);

                // AI Tip 자동 분석 실행
                autoAnalyzeCompany();

                // 접촉이력 탭 활성화 시 데이터 로드를 위한 이벤트 리스너
                document.querySelector('.tab-button:nth-child(2)').addEventListener('click', function() {
                setTimeout(() => {
                if (document.getElementById('contact-history').classList.contains('active')) {
                loadContactHistory();
                }
                }, 100);
                });
                });

                // AI 자동 분석 함수
                function autoAnalyzeCompany() {
                const tipContent = document.getElementById('ai-tip-content-main');

                fetch('/api/ai-analysis', {
                method: 'POST',
                headers: {
                'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                query: `${currentCompanyName}의 재무상태, 투자가치, 리스크 요인을 종합적으로 분석해주세요. 기업의 강점과 약점, 향후 전망에 대해서도 설명해주세요.`,
                biz_no: currentBizNo,
                company_name: currentCompanyName
                })
                })
                .then(response => response.json())
                .then(data => {
                if (data.success) {
                tipContent.innerHTML = `
                <div style="line-height: 1.6;">${data.result}</div>
                <div class="ai-disclaimer">* Gemini AI 모델을 사용하여 실시간 분석한 결과입니다.</div>
                `;
                } else {
                tipContent.innerHTML = `
                <p style="color: red;">AI 분석을 불러올 수 없습니다: ${data.message}</p>
                <div class="ai-disclaimer">* Gemini AI 연결을 확인해주세요.</div>
                `;
                }
                })
                .catch(error => {
                console.error('AI 분석 오류:', error);
                tipContent.innerHTML = `
                <p style="color: red;">AI 분석 중 오류가 발생했습니다.</p>
                <div class="ai-disclaimer">* 네트워크 연결을 확인해주세요.</div>
                `;
                });
                }

                // 주주 삭제 모드 토글
                let deleteMode = false;
                function toggleDeleteMode() {
                deleteMode = !deleteMode;
                const deleteButtons = document.querySelectorAll('.delete-btn');
                const deleteModeBtn = document.getElementById('deleteModeBtn');

                if (deleteMode) {
                deleteButtons.forEach(btn => btn.style.display = 'inline-block');
                deleteModeBtn.textContent = '삭제 취소';
                deleteModeBtn.style.background = '#6c757d';
                } else {
                deleteButtons.forEach(btn => btn.style.display = 'none');
                deleteModeBtn.textContent = '삭제 모드';
                deleteModeBtn.style.background = '#dc3545';
                }
                }

                // 주주 삭제 함수
                function deleteShareholder(shareholderName) {
                if (confirm(`'${shareholderName}' 주주를 삭제하시겠습니까?`)) {
                // A
                // PI 호출로 주주 삭제
                fetch('/api/delete-shareholder', {
                method: 'POST',
                headers: {
                'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                biz_no: currentBizNo,
                shareholder_name: shareholderName
                })
                })
                .then(response => response.json())
                .then(data => {
                if (data.success) {
                alert('주주가 성공적으로 삭제되었습니다.');
                location.reload(); // 페이지 새로고침으로 변경사항 반영
                } else {
                alert('삭제 실패: ' + (data.message || '알 수 없는 오류'));
                }
                })
                .catch(error => {
                console.error('Error:', error);
                alert('삭제 중 오류가 발생했습니다.');
                });
                }
                }

                // 주주명 수정 함수
                function editShareholder(shareholderName) {
                // 마스킹된 이름인지 확인 (예: 홍*동, 홍**, 등)
                if (shareholderName.includes('*')) {
                // AI를 통해 실제 이름 검색 또는 직접 입력
                const newName = prompt('주주명을 입력하세요 (마스킹 해제):', '');
                if (newName && newName.trim()) {
                updateShareholderName(shareholderName, newName.trim());
                }
                } else {
                // 일반 수정
                const newName = prompt('새로운 주주명을 입력하세요:', shareholderName);
                if (newName && newName.trim() && newName !== shareholderName) {
                updateShareholderName(shareholderName, newName.trim());
                }
                }
                }

                // 주주명 업데이트 API 호출
                function updateShareholderName(oldName, newName) {
                fetch('/api/update-shareholder', {
                method: 'POST',
                headers: {
                'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                biz_no: currentBizNo,
                old_shareholder_name: oldName,
                new_shareholder_name: newName
                })
                })
                .then(response => response.json())
                .then(data => {
                if (data.success) {
                alert('주주명이 성공적으로 업데이트되었습니다.');
                location.reload(); // 페이지 새로고침으로 변경사항 반영
                } else {
                alert('업데이트 실패: ' + (data.message || '알 수 없는 오류'));
                }
                })
                .catch(error => {
                console.error('Error:', error);
                alert('업데이트 중 오류가 발생했습니다.');
                });
                }

                // 수식수 변경 함수
                function updateShareCount(shareholderName, currentShareCount) {
                const newShareCount = prompt('수식수를 입력하세요:', currentShareCount || '0');

                if (newShareCount !== null && newShareCount.trim() !== '') {
                const shareCountNum = parseInt(newShareCount.replace(/,/g, ''), 10);

                if (isNaN(shareCountNum)) {
                alert('올바른 숫자를 입력해주세요.');
                return;
                }

                fetch('/api/update-share-count', {
                method: 'POST',
                headers: {
                'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                biz_no: currentBizNo,
                shareholder_name: shareholderName,
                new_share_count: shareCountNum
                })
                })
                .then(response => response.json())
                .then(data => {
                if (data.success) {
                alert('수식수가 성공적으로 업데이트되었습니다.');
                location.reload(); // 페이지 새로고침으로 변경사항 반영
                } else {
                alert('업데이트 실패: ' + (data.message || '알 수 없는 오류'));
                }
                })
                .catch(error => {
                console.error('Error:', error);
                alert('업데이트 중 오류가 발생했습니다.');
                });
                }
                }


                // 7. 스크롤 네비게이션 함수들
                function scrollToTop() {
                window.scrollTo({ top: 0, behavior: 'smooth' });
                }

                function scrollToBottom() {
                window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' });
                }

                // 스크롤에 따라 버튼 표시/숨김
                window.addEventListener('scroll', function() {
                const scrollNav = document.getElementById('scrollNav');
                if (window.scrollY > 300) {
                scrollNav.style.display = 'block';
                } else {
                scrollNav.style.display = 'none';
                }
                });

                // 페이지 로드 시 스크롤 버튼 초기화
                document.addEventListener('DOMContentLoaded', function() {
                const scrollNav = document.getElementById('scrollNav');
                if (scrollNav) {
                scrollNav.style.display = window.scrollY > 300 ? 'block' : 'none';
                }
                });
                </script>

                <!-- 긴급 수정: 최하단 함수 재정의 -->
                <script>
                    // 확실한 함수 정의 - 브라우저 호환성 최대화
                    window.showTab = function (tabId, clickedButton) {
                        console.log('=== showTab 함수 실행 시작 ===');
                        console.log('탭 ID:', tabId, '버튼:', clickedButton);

                        try {
                            // 모든 탭 버튼 비활성화
                            var tabButtons = document.querySelectorAll('.tab-button');
                            console.log('찾은 탭 버튼 수:', tabButtons.length);

                            for (var i = 0; i < tabButtons.length; i++) {
                                tabButtons[i].classList.remove('active');
                                console.log('버튼', i, '비활성화');
                            }

                            // 모든 탭 패널 숨김
                            var tabPanels = document.querySelectorAll('.tab-panel');
                            console.log('찾은 탭 패널 수:', tabPanels.length);

                            for (var j = 0; j < tabPanels.length; j++) {
                                tabPanels[j].classList.remove('active');
                                console.log('패널', j, '숨김');
                            }

                            // 클릭된 버튼 활성화
                            if (clickedButton) {
                                clickedButton.classList.add('active');
                                console.log('클릭된 버튼 활성화');
                            }

                            // 타겟 패널 표시
                            var targetPanel = document.getElementById(tabId);
                            if (targetPanel) {
                                targetPanel.classList.add('active');
                                console.log('타겟 패널', tabId, '활성화 완료');

                                // 특별한 처리
                                if (tabId === 'ai-search') {
                                    console.log('AI 서치 탭 - 분석 시작 준비');
                                    setTimeout(function () {
                                        if (window.startComprehensiveAnalysis) {
                                            startComprehensiveAnalysis();
                                        }
                                    }, 300);
                                }

                                if (tabId === 'contact-history') {
                                    console.log('접촉이력 탭 - 데이터 로드 준비');
                                    setTimeout(function () {
                                        if (window.loadContactHistory) {
                                            loadContactHistory();
                                        }
                                    }, 200);
                                }
                            } else {
                                console.error('타겟 패널을 찾을 수 없음:', tabId);
                            }

                            console.log('=== showTab 함수 실행 완료 ===');
                            return true;

                        } catch (error) {
                            console.error('showTab 함수 오류:', error);
                            alert('탭 전환 중 오류가 발생했습니다: ' + error.message);
                            return false;
                        }
                    };

                    window.registerPioneering = function () {
                        console.log('=== registerPioneering 함수 실행 시작 ===');

                        try {
                            // 간단한 모달창 표시 방법
                            var modalHtml = `
                <div id="quickPioneeringModal" style="
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0,0,0,0.7);
                    z-index: 10000;
                    display: flex;
                    justify-content: center;
                    align-items: center;
                ">
                    <div style="
                        background: white;
                        padding: 30px;
                        border-radius: 15px;
                        width: 90%;
                        max-width: 500px;
                        box-shadow: 0 4px 20px rgba(0,0,0,0.3);
                    ">
                        <h2 style="margin-top: 0; color: #28a745;">개척 대상 등록 (ych_P111)</h2>
                        <form>
                            <div style="margin-bottom: 20px;">
                                <label style="display: block; margin-bottom: 5px; font-weight: 500;">기업명:</label>
                                <input type="text" id="qCompanyName" value="${window.currentCompanyName || '회사명'}" readonly 
                                       style="width: 100%; padding: 10px; border: 1px solid #ced4da; border-radius: 5px; background: #f8f9fa; box-sizing: border-box;">
                            </div>
                            <div style="margin-bottom: 20px;">
                                <label style="display: block; margin-bottom: 5px; font-weight: 500;">사업자번호:</label>
                                <input type="text" id="qBizNo" value="${window.currentBizNo || '사업자번호'}" readonly 
                                       style="width: 100%; padding: 10px; border: 1px solid #ced4da; border-radius: 5px; background: #f8f9fa; box-sizing: border-box;">
                            </div>
                            <div style="margin-bottom: 20px;">
                                <label for="qVisitDate" style="display: block; margin-bottom: 5px; font-weight: 500;">방문일자 *:</label>
                                <input type="date" id="qVisitDate" required 
                                       style="width: 100%; padding: 10px; border: 1px solid #ced4da; border-radius: 5px; box-sizing: border-box;">
                            </div>
                            <div style="margin-bottom: 30px;">
                                <label for="qMemo" style="display: block; margin-bottom: 5px; font-weight: 500;">메모:</label>
                                <textarea id="qMemo" placeholder="개척 관련 메모사항..." 
                                          style="width: 100%; padding: 10px; border: 1px solid #ced4da; border-radius: 5px; min-height: 80px; resize: vertical; box-sizing: border-box;"></textarea>
                            </div>
                            <div style="display: flex; gap: 10px; justify-content: flex-end;">
                                <button type="button" onclick="closeQuickModal()" 
                                        style="padding: 10px 20px; border: none; border-radius: 5px; background: #6c757d; color: white; cursor: pointer;">취소</button>
                                <button type="button" onclick="submitQuickPioneering()" 
                                        style="padding: 10px 20px; border: none; border-radius: 5px; background: #28a745; color: white; cursor: pointer;">등록</button>
                            </div>
                        </form>
                    </div>
                </div>
                `;

                            // 기존 모달 제거
                            var existingModal = document.getElementById('quickPioneeringModal');
                            if (existingModal) {
                                existingModal.remove();
                            }

                            // 새 모달 추가
                            document.body.insertAdjacentHTML('beforeend', modalHtml);

                            // 오늘 날짜 설정
                            var today = new Date().toISOString().split('T')[0];
                            document.getElementById('qVisitDate').value = today;

                            console.log('개척등록 모달창 표시 완료');
                            return true;

                        } catch (error) {
                            console.error('registerPioneering 함수 오류:', error);
                            alert('개척등록 모달 표시 중 오류가 발생했습니다: ' + error.message);
                            return false;
                        }
                    };

                    window.closeQuickModal = function () {
                        var modal = document.getElementById('quickPioneeringModal');
                        if (modal) {
                            modal.remove();
                            console.log('개척등록 모달창 닫힘');
                        }
                    };

                    window.submitQuickPioneering = function () {
                        console.log('개척등록 제출 시작');

                        var visitDate = document.getElementById('qVisitDate').value;
                        var memo = document.getElementById('qMemo').value;

                        if (!visitDate) {
                            alert('방문일자를 입력해주세요.');
                            return;
                        }

                        // 서버로 전송
                        var data = {
                            biz_no: window.currentBizNo || '${company.biz_no if company else "1018139184"}',
                            visit_date: visitDate,
                            notes: memo,
                            visitor_id: '${user_id if user_id else "unknown"}'
                        };

                        console.log('전송 데이터:', data);

                        fetch('/api/pioneering_targets', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(data)
                        })
                            .then(response => response.json())
                            .then(result => {
                                if (result.success) {
                                    alert('개척 대상이 정상적으로 등록되었습니다.');
                                    closeQuickModal();
                                    location.reload();
                                } else {
                                    alert(result.message || '등록에 실패했습니다.');
                                }
                            })
                            .catch(error => {
                                console.error('등록 오류:', error);
                                alert('등록 중 오류가 발생했습니다.');
                            });
                    };

                    <!-- 접촉이력 등록/수정 모달 -->
                    <div id="contactHistoryModal" class="modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); z-index: 1000;">
                        <div class="modal-content" style="position: relative; margin: 5% auto; padding: 20px; width: 80%; max-width: 600px; background: white; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                            <span class="close" onclick="closeContactModal()" style="position: absolute; top: 15px; right: 20px; font-size: 28px; font-weight: bold; cursor: pointer; color: #aaa;">&times;</span>
                            <h3 id="contactModalTitle" style="margin-top: 0; color: #333;">접촉이력 등록</h3>

                            <form id="contactHistoryForm" style="margin-top: 20px;">
                                <input type="hidden" id="contactHistoryId" value="">

                                    <div style="margin-bottom: 15px;">
                                        <label style="display: block; margin-bottom: 5px; font-weight: bold; color: #333;">접촉일시 *</label>
                                        <input type="datetime-local" id="contactDatetime" required style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                    </div>

                                    <div style="margin-bottom: 15px;">
                                        <label style="display: block; margin-bottom: 5px; font-weight: bold; color: #333;">접촉유형 *</label>
                                        <select id="contactType" required style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                            <option value="">선택하세요</option>
                                            <option value="방문">방문</option>
                                            <option value="전화">전화</option>
                                            <option value="이메일">이메일</option>
                                            <option value="회의">회의</option>
                                            <option value="기타">기타</option>
                                        </select>
                                    </div>

                                    <div style="margin-bottom: 15px;">
                                        <label style="display: block; margin-bottom: 5px; font-weight: bold; color: #333;">접촉자</label>
                                        <input type="text" id="contactPerson" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" placeholder="담당자명">
                                    </div>

                                    <div style="margin-bottom: 20px;">
                                        <label style="display: block; margin-bottom: 5px; font-weight: bold; color: #333;">메모</label>
                                        <textarea id="contactMemo" rows="4" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; resize: vertical;" placeholder="접촉 내용을 입력하세요"></textarea>
                                    </div>

                                    <div style="text-align: right;">
                                        <button type="button" onclick="closeContactModal()" style="background: #6c757d; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; margin-right: 10px;">취소</button>
                                        <button type="submit" style="background: #007bff; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer;">저장</button>
                                    </div>
                            </form>
                        </div>
                    </div>
</body >
</html >