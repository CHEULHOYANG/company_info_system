<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>{{ company.basic.company_name }} - 상세 정보</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
    <div class="container">
        <header><h1>{{ company.basic.company_name }} <span class="header-subtext">상세 정보</span></h1>
            <div>
                <a href="{{ url_for('index') }}" class="back-button">목록으로</a>
            </div>
        </header>

        <div class="detail-main-grid">
            <div class="detail-left-column">
                <div class="detail-card">
                    <h3>기본 정보</h3>
                    <div class="info-grid">
                        <div><strong>사업자번호</strong></div>
                        <div>{{ company.basic.biz_no }}</div>
                        <div><strong>법인등록번호</strong></div>
                        <div>{{ company.basic.corporate_reg_no }}</div>
                        <div><strong>대표자</strong></div>
                        <div>{{ company.basic.representative_name }}</div>
                        <div><strong>설립일</strong></div>
                        <div>{{ company.basic.establish_date }}</div>
                        <div><strong>기업규모</strong></div>
                        <div>{{ company.basic.company_size }}</div>
                        <div><strong>신용등급</strong></div>
                        <div>{{ company.basic.rating1 or 'N/A' }}</div>
                        <div class="full-width"><strong>주소</strong></div>
                        <div class="full-width">{{ company.basic.address }}</div>
                    </div>
                </div>

                 <div class="detail-card">
                    <h3>비상장 주식 가치 평가 (참고용)</h3>
                    {% if company.stock_valuation and company.stock_valuation.estimated_stock_value > 0 %}
                    <div class="info-grid">
                        <div><strong>자산가치</strong></div>
                        <div>{{ "₩{:,.0f}".format(company.stock_valuation.asset_value) }}</div>
                        <div><strong>수익가치</strong></div>
                        <div>{{ "₩{:,.0f}".format(company.stock_valuation.profit_value) }}</div>
                        <div><strong>평가액</strong></div>
                        <div>{{ "₩{:,.0f}".format(company.stock_valuation.calculated_value) }}</div>
                        <div><strong class="total-shares">총 주식수</strong></div>
                        <div class="total-shares">{{ "{:,.0f} 주".format(company.stock_valuation.total_shares_issued) }}</div>
                        <div class="full-width"><strong>1주당 추정가치</strong></div>
                        <div class="full-width estimated-value">{{ "₩{:,.0f}".format(company.stock_valuation.estimated_stock_value) }}</div>
                    </div>
                    {% else %}
                    <p>가치 평가 정보를 산출할 수 없습니다.</p>
                    {% endif %}
                </div>
            </div>

            <div class="detail-right-column">
                <div class="detail-card">
                    <h3>재무 정보 (단위: 백만)</h3>
                    {% if company.financials %}
                    <table class="results-table">
                        <thead>
                            <tr>
                                <th>년도</th>
                                <th class="text-right">매출액</th>
                                <th class="text-right">당기순이익</th>
                                <th class="text-right">자산총계</th>
                                <th class="text-right">자본총계</th>
                                <th class="text-right">이익잉여금</th>
                                <th class="text-right">법인세비용</th>
                                <th class="text-right">미처분이익잉여금</th>
                                <th class="text-right">가지급금</th>
                                <th class="text-right">가수금</th>
                            </tr>
                        </thead>
                        <tbody>
                        {% for fin in company.financials %}
                            <tr>
                                <td>{{ fin.year }}</td>
                                <td class="text-right">{{ "N/A" if fin.sales_revenue is none else "{:,.0f}".format(fin.sales_revenue / 1000000) }}</td>
                                <td class="text-right">{{ "N/A" if fin.net_income is none else "{:,.0f}".format(fin.net_income / 1000000) }}</td>
                                <td class="text-right">{{ "N/A" if fin.total_assets is none else "{:,.0f}".format(fin.total_assets / 1000000) }}</td>
                                <td class="text-right">{{ "N/A" if fin.total_equity is none else "{:,.0f}".format(fin.total_equity / 1000000) }}</td>
                                <td class="text-right">{{ "N/A" if fin.retained_earnings is none else "{:,.0f}".format(fin.retained_earnings / 1000000) }}</td>
                                <td class="text-right">{{ "N/A" if fin.corporate_tax is none else "{:,.0f}".format(fin.corporate_tax / 1000000) }}</td>
                                <td class="text-right">{{ "N/A" if fin.undistributed_retained_earnings is none else "{:,.0f}".format(fin.undistributed_retained_earnings / 1000000) }}</td>
                                <td class="text-right">{{ "N/A" if fin.advances_paid is none else "{:,.0f}".format(fin.advances_paid / 1000000) }}</td>
                                <td class="text-right">{{ "N/A" if fin.advances_received is none else "{:,.0f}".format(fin.advances_received / 1000000) }}</td>
                            </tr>
                        {% endfor %}
                        </tbody>
                    </table>
                    {% else %}
                    <p>재무 정보가 없습니다.</p>
                    {% endif %}
                </div>
            </div>
        </div>
        
        <div class="detail-card">
            <h3>대표자 정보</h3>
            {% if company.representatives %}
            <table class="results-table">
                <thead><tr><th>성명</th><th>성별</th><th>나이</th><th>생년월일</th><th>GFC 여부</th></tr></thead>
                <tbody>
                {% for rep in company.representatives %}
                    <tr><td>{{ rep.name }}</td><td>{{ rep.gender }}</td><td>{{ rep.age }}</td><td>{{ rep.birth_date }}</td><td>{{ 'Y' if rep.is_gfc == 'Y' else 'N' }}</td></tr>
                {% endfor %}
                </tbody>
            </table>
            {% else %}<p>대표자 정보가 없습니다.</p>{% endif %}
        </div>

        <div class="detail-card">
            <h3>주주 정보</h3>
             {% if company.shareholders %}
            <table class="results-table">
                <thead><tr><th>주주명</th><th>지분율(%)</th><th>관계</th><th>주주구분</th><th>경영구분</th><th>사내근로복지기금 관계</th><th>보유주식수</th></tr></thead>
                <tbody>
                {% for s in company.shareholders %}
                    <tr><td>{{ s.shareholder_name }}</td><td>{{ s.ownership_percent }}</td><td>{{ s.relationship }}</td><td>{{ s.shareholder_type }}</td><td>{{ s.management_type }}</td><td>{{ s.silent_partner_relationship }}</td><td>{{ "{:,.0f}".format(s.total_shares_owned) if s.total_shares_owned else '' }}</td></tr>
                {% endfor %}
                </tbody>
            </table>
            {% else %}<p>주주 정보가 없습니다.</p>{% endif %}
        </div>

        <div class="detail-card">
            <h3>인증 및 특허 정보</h3>
            {% if company.patents %}
            <table class="results-table">
                <thead>
                    <tr>
                        <th>특허/인증명</th>
                        <th>상태</th>
                        <th>출원/등록일</th>
                        <th>출원/등록번호</th>
                    </tr>
                </thead>
                <tbody>
                    {% for patent in company.patents %}
                    <tr>
                        <td>{{ patent.patent_name }}</td>
                        <td>{{ patent.status }}</td>
                        <td>{{ patent.application_date }}</td>
                        <td>{{ patent.application_number }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% else %}
            <p>인증 및 특허 정보가 없습니다.</p>
            {% endif %}
        </div>

        <div class="detail-card">
            <h3>접촉 이력 관리</h3>
            <form id="history-form">
                <input type="hidden" name="history_id" id="history_id">
                <input type="hidden" name="biz_no" value="{{ company.basic.biz_no }}">
                <div class="form-grid">
                    <label for="contact_datetime">접촉일시</label>
                    <input type="datetime-local" id="contact_datetime" name="contact_datetime" required>
                    <label for="contact_type">접촉구분</label>
                    <select id="contact_type" name="contact_type" required>
                        <option value="T">전화(T)</option><option value="M">문자(M)</option><option value="E">이메일(E)</option><option value="V">방문(V)</option>
                    </select>
                    <label for="contact_person">접촉대상</label>
                    <input type="text" id="contact_person" name="contact_person" placeholder="예: 김OO 대표, 박OO 부장">
                    <label for="memo" class="full-width">메모</label>
                    <textarea id="memo" name="memo" rows="3" required class="full-width"></textarea>
                </div>
                <div class="button-group">
                    <button type="submit" id="submit-btn">신규 등록</button>
                    <button type="button" id="cancel-btn" style="display:none;">취소</button>
                </div>
            </form>
            <table class="results-table" id="history-table" style="margin-top: 20px;">
                <thead><tr><th>접촉일시</th><th>구분</th><th>접촉대상</th><th>메모</th><th>등록자</th><th>관리</th></tr></thead>
                <tbody>
                {% for h in company.history %}
                    <tr data-id="{{ h.history_id }}">
                        <td class="datetime-value">{{ h.contact_datetime }}</td><td class="type">{{ h.contact_type }}</td><td class="person">{{ h.contact_person }}</td><td class="memo">{{ h.memo }}</td><td>{{ h.registered_by }}</td>
                        <td><button class="edit-btn">수정</button> <button class="delete-btn">삭제</button></td>
                    </tr>
                {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    
    <script>
    document.addEventListener('DOMContentLoaded', function () {
        const form = document.getElementById('history-form');
        const historyIdInput = document.getElementById('history_id');
        const submitBtn = document.getElementById('submit-btn');
        const cancelBtn = document.getElementById('cancel-btn');
        const datetimeInput = document.getElementById('contact_datetime');

        function resetForm() {
            form.reset();
            historyIdInput.value = '';
            submitBtn.textContent = '신규 등록';
            cancelBtn.style.display = 'none';
        }

        form.addEventListener('submit', function (e) {
            e.preventDefault();
            const historyId = historyIdInput.value;
            const method = historyId ? 'PUT' : 'POST';
            const url = historyId ? `/api/contact_history/${historyId}` : '/api/contact_history';
            
            const formData = new FormData(form);
            const data = Object.fromEntries(formData.entries());

            fetch(url, {
                method: method,
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(result => {
                if (result.success) {
                    alert(historyId ? '수정되었습니다.' : '등록되었습니다.');
                    window.location.reload();
                } else {
                    alert('오류: ' + result.message);
                }
            });
        });

        document.getElementById('history-table').addEventListener('click', (e) => {
            const row = e.target.closest('tr');
            if (!row) return;
            const historyId = row.dataset.id;

            if (e.target.classList.contains('edit-btn')) {
                historyIdInput.value = historyId;
                let dtValue = row.querySelector('.datetime-value').textContent.trim().replace(' ', 'T');
                 if (dtValue.length === 16) dtValue += ':00';
                datetimeInput.value = dtValue;
                form.contact_type.value = row.querySelector('.type').textContent;
                form.contact_person.value = row.querySelector('.person').textContent;
                form.memo.value = row.querySelector('.memo').textContent;
                submitBtn.textContent = '수정 완료';
                cancelBtn.style.display = 'inline-block';
                form.scrollIntoView({ behavior: 'smooth' });
            }

            if (e.target.classList.contains('delete-btn')) {
                if (!confirm('정말로 이 이력을 삭제하시겠습니까?')) return;
                fetch(`/api/contact_history/${historyId}`, { method: 'DELETE' })
                    .then(response => {
                        if (response.ok) {
                            alert('삭제되었습니다.');
                            row.remove();
                        } else {
                            alert('삭제 중 오류가 발생했습니다.');
                        }
                    });
            }
        });
        cancelBtn.addEventListener('click', resetForm);
    });
    </script>
</body>
</html>