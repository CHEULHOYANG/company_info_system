<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>{{ company.basic.company_name }} - 상세 정보</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
    <div class="container">
 <header>
    <h1>{{ company.basic.company_name }} <span class="header-subtext">상세 정보</span></h1>
    <div>
        {# is_popup 변수가 True이면 '닫기' 버튼을, 아니면 '목록으로' 버튼을 보여줌 #}
        {% if is_popup %}
            <a href="javascript:window.close();" class="back-button">닫기</a>
        {# 일반 화면으로 열렸을 경우 '목록으로' 버튼 표시 #}
        {% else %}
            <a href="javascript:history.back()" class="back-button">목록으로</a>
        {% endif %}
    </div>
</header>

        <div class="tab-nav">
            <button class="tab-link active" data-tab="tab1">기업 상세 조회</button>
            <button class="tab-link" data-tab="tab2">접촉이력 정보</button>
        </div>

        <div class="tab-content">
            <div id="tab1" class="tab-pane active">
                <div class="detail-main-grid">
                    <div class="detail-left-column">
                        <div class="detail-card">
                            <h3>기본 정보</h3>
                            <div class="info-grid">
                                <div><strong>사업자번호</strong></div>
                                <div>{{ company.basic.biz_no }}</div>
                                <div><strong>대표자</strong></div>
                                <div>{{ company.basic.representative_name }}</div>
                                <div><strong>설립일</strong></div>
                                <div>{{ company.basic.establish_date }}</div>
                                <div><strong>기업규모</strong></div>
                                <div>{{ company.basic.company_size }}</div>
                                <div><strong>신용등급</strong></div>
                                <div>{{ company.basic.rating1 or 'N/A' }}</div>
                                <div><strong>업종</strong></div>
                                <div>{{ company.basic.industry_name }}</div>
                                <div><strong>주소</strong></div>
                                <div>{{ company.basic.address }}</div>
                                <div><strong>단체계약여부</strong></div>
                                <div><span class="status-{{ 'yes' if company.basic.group_transaction_yn == 'Y' else 'no' }}">{{ '유' if company.basic.group_transaction_yn == 'Y' else '무' }}</span></div>
                                <div><strong>GFC거래유무</strong></div>
                                <div><span class="status-{{ 'yes' if company.basic.gfc_transaction_yn == 'Y' else 'no' }}">{{ '유' if company.basic.gfc_transaction_yn == 'Y' else '무' }}</span></div>
                            </div>
                        </div>

                        <div class="detail-card">
                            <h3>인증 및 특허 정보</h3>
                            <table class="certs-grid">
                                <thead>
                                    <tr>
                                        <th>구분</th><th>인증/보유 여부</th><th>인정/출원일</th><th>만료일</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td>기업부설연구소</td>
                                        <td><span class="status-{{ 'yes' if company.additional.has_research_institute == '1' else 'no' }}">{{ '보유' if company.additional.has_research_institute == '1' else '미보유' }}</span></td>
                                        <td>{{ company.additional.research_institute_date or '-' }}</td>
                                        <td>-</td>
                                    </tr>
                                    <tr>
                                        <td>이노비즈</td>
                                        <td><span class="status-{{ 'yes' if company.additional.is_innobiz == '1' else 'no' }}">{{ '인증' if company.additional.is_innobiz == '1' else '미인증' }}</span></td>
                                        <td>{{ company.additional.innobiz_cert_date or '-' }}</td>
                                        <td>{{ company.additional.innobiz_expiry_date or '-' }}</td>
                                    </tr>
                                    <tr>
                                        <td>메인비즈</td>
                                        <td><span class="status-{{ 'yes' if company.additional.is_mainbiz == '1' else 'no' }}">{{ '인증' if company.additional.is_mainbiz == '1' else '미인증' }}</span></td>
                                        <td>{{ company.additional.mainbiz_cert_date or '-' }}</td>
                                        <td>{{ company.additional.mainbiz_expiry_date or '-' }}</td>
                                    </tr>
                                    <tr>
                                        <td>벤처인증</td>
                                        <td><span class="status-{{ 'yes' if company.additional.is_venture == '1' else 'no' }}">{{ '인증' if company.additional.is_venture == '1' else '미인증' }}</span></td>
                                        <td>{{ company.additional.venture_cert_date or '-' }}</td>
                                        <td>{{ company.additional.venture_expiry_date or '-' }}</td>
                                    </tr>
                                    <tr>
                                        <td>특허</td>
                                        <td colspan="3">
                                            출원: <strong>{{ company.additional.patent_applications_count or 0 }}</strong>건 / 
                                            등록: <strong>{{ company.additional.registered_patents_count or 0 }}</strong>건
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>

                        <div class="detail-card">
                            <h3>비상장주식가치 평가 (참고용)</h3>
                            {% if company.stock_valuation and company.stock_valuation.total_shares_issued is defined %}
                            <div class="info-grid">
                                <div><strong>자산가치</strong></div>
                                <div>{{ "{:,.0f}".format(company.stock_valuation.asset_value) if company.stock_valuation.asset_value else 'N/A' }} 원</div>
                                <div><strong>수익가치</strong></div>
                                <div>{{ "{:,.0f}".format(company.stock_valuation.profit_value) if company.stock_valuation.profit_value else 'N/A' }} 원</div>
                                <div><strong>1주당 평가액</strong></div>
                                <div><strong class="text-danger">{{ "{:,.0f}".format(company.stock_valuation.estimated_stock_value) if company.stock_valuation.estimated_stock_value else 'N/A' }} 원</strong></div>
                                <div></div>
                                <div><span class="text-primary-large">(발행주식수: {{ "{:,.0f}".format(company.stock_valuation.total_shares_issued) if company.stock_valuation.total_shares_issued else 'N/A' }} 주)</span></div>
                            </div>
                            {% else %}
                                <p>재무 데이터가 부족하여 가치 평가 정보를 산출할 수 없습니다.</p>
                            {% endif %}
                        </div>
                    </div>

                    <div class="detail-right-column">
                        <div class="detail-card">
                            <h3>재무 정보 (최근 3개년, 단위: 원)</h3>
                            {% if company.financials %}
                            <table class="results-table">
                                <thead>
                                    <tr>
                                        <th>항목</th>
                                        {% for fin in company.financials %}<th class="text-right">{{ fin.fiscal_year }}년</th>{% endfor %}
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr><td>매출액</td>{% for fin in company.financials %} <td class="text-right">{{ "{:,.0f}".format(fin.sales_revenue) if fin.sales_revenue is not none else '' }}</td> {% endfor %}</tr>
                                    <tr><td>당기순이익</td>{% for fin in company.financials %} <td class="text-right">{{ "{:,.0f}".format(fin.net_income) if fin.net_income is not none else '' }}</td> {% endfor %}</tr>
                                    <tr><td>자산총계</td>{% for fin in company.financials %} <td class="text-right">{{ "{:,.0f}".format(fin.total_assets) if fin.total_assets is not none else '' }}</td> {% endfor %}</tr>
                                    <tr><td>자본총계</td>{% for fin in company.financials %} <td class="text-right">{{ "{:,.0f}".format(fin.total_equity) if fin.total_equity is not none else '' }}</td> {% endfor %}</tr>
                                    <tr><td>이익잉여금</td>{% for fin in company.financials %} <td class="text-right">{{ "{:,.0f}".format(fin.retained_earnings) if fin.retained_earnings is not none else '' }}</td> {% endfor %}</tr>
                                    <tr><td>미처분이익잉여금</td>{% for fin in company.financials %} <td class="text-right">{{ "{:,.0f}".format(fin.undistributed_retained_earnings) if fin.undistributed_retained_earnings is not none else '' }}</td> {% endfor %}</tr>
                                    <tr><td>법인세비용</td>{% for fin in company.financials %} <td class="text-right">{{ "{:,.0f}".format(fin.corporate_tax) if fin.corporate_tax is not none else '' }}</td> {% endfor %}</tr>
                                    <tr><td>가지급금</td>{% for fin in company.financials %} <td class="text-right">{{ "{:,.0f}".format(fin.advances_paid) if fin.advances_paid is not none else '' }}</td> {% endfor %}</tr>
                                    <tr><td>가수금</td>{% for fin in company.financials %} <td class="text-right">{{ "{:,.0f}".format(fin.advances_received) if fin.advances_received is not none else '' }}</td> {% endfor %}</tr>
                                </tbody>
                            </table>
                            {% else %}<p>재무 정보가 없습니다.</p>{% endif %}
                        </div>
                        <div class="detail-card">
                            <h3>대표자 및 주주 정보</h3>
                            <h4>대표자</h4>
                            {% if company.representatives %}
                            <table class="results-table">
                                <thead><tr><th>성명</th><th>생년월일</th><th>성별</th><th>GFC여부</th></tr></thead>
                                <tbody>
                                {% for rep in company.representatives %}
                                <tr>
                                    <td>{{ rep.name }}</td><td>{{ rep.birth_date }}</td><td>{{ rep.gender }}</td>
                                    <td><span class="status-{{ 'yes' if rep.is_gfc == 'Y' else 'no' }}">{{ 'Y' if rep.is_gfc == 'Y' else 'N' }}</span></td>
                                </tr>
                                {% endfor %}
                                </tbody>
                            </table>
                            {% else %}<p>대표자 정보가 없습니다.</p>{% endif %}
                            <h4>주주 구성</h4>
                            {% if company.shareholders %}
                            <table class="results-table">
                                <thead><tr><th>주주명</th><th style="width: 40%;">지분율</th><th>관계</th></tr></thead>
                                <tbody>
                                {% for holder in company.shareholders %}
                                <tr>
                                    <td>{{ holder.shareholder_name }}</td>
                                    <td>
                                        <div class="progress-container">
                                            <div class="progress-bar" style="width: {{ holder.ownership_percent }}%;">{{ "%.2f"|format(holder.ownership_percent) }}%</div>
                                        </div>
                                    </td>
                                    <td>{{ holder.relationship }}</td>
                                </tr>
                                {% endfor %}
                                </tbody>
                            </table>
                            {% else %}<p>주주 정보가 없습니다.</p>{% endif %}
                        </div>
                    </div>
                </div>
            </div>

            <div id="tab2" class="tab-pane">
                <div class="detail-card">
                    <h3>접촉 이력</h3>
                    <form id="contact-history-form">
                        <input type="hidden" name="history_id">
                        <input type="hidden" name="biz_no" value="{{ company.basic.biz_no }}">
                        <div class="form-row">
                            <input type="datetime-local" name="contact_datetime" required>
                            <select name="contact_type" required>
                                <option value="" disabled selected>유형 선택</option>
                                <option value="DM발송">DM발송</option>
                                <option value="전화상담">전화상담</option>
                                <option value="대면상담">대면상담</option>
                                <option value="세미나참석">세미나참석</option>
                                <option value="문자발송">문자발송</option>
                                <option value="선물발송">선물발송</option>
                            </select>
                            <input type="text" name="contact_person" placeholder="담당자" required>
                        </div>
                        <div class="form-row">
                             <textarea name="memo" placeholder="메모 내용" required></textarea>
                        </div>
                        <div class="form-row form-buttons">
                            <button type="submit" id="submit-btn">신규등록</button>
                            <button type="button" id="cancel-btn" style="display:none;">취소</button>
                        </div>
                    </form>
                    <div class="table-container">
                        <table class="results-table">
                            <thead><tr><th>일시</th><th>유형</th><th>담당자</th><th>내용</th><th>작성자</th><th>작업</th></tr></thead>
                            <tbody id="history-tbody">
                                {% for item in company.history %}
                                <tr data-id="{{ item.history_id }}">
                                    <td class="datetime-value">{{ item.contact_datetime }}</td>
                                    <td class="type">{{ item.contact_type }}</td>
                                    <td class="person">{{ item.contact_person }}</td>
                                    <td class="memo">{{ item.memo }}</td>
                                    <td>{{ item.registered_by }}</td>
                                    <td>
                                        <button class="edit-btn">수정</button>
                                        <button class="delete-btn">삭제</button>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const tabLinks = document.querySelectorAll('.tab-link');
        const tabPanes = document.querySelectorAll('.tab-pane');

        tabLinks.forEach(link => {
            link.addEventListener('click', () => {
                const tabId = link.getAttribute('data-tab');

                tabLinks.forEach(item => item.classList.remove('active'));
                tabPanes.forEach(item => item.classList.remove('active'));

                link.classList.add('active');
                document.getElementById(tabId).classList.add('active');
            });
        });

        const form = document.getElementById('contact-history-form');
        const historyIdInput = form.querySelector('input[name="history_id"]');
        const datetimeInput = form.querySelector('input[name="contact_datetime"]');
        const submitBtn = document.getElementById('submit-btn');
        const cancelBtn = document.getElementById('cancel-btn');
        const historyTbody = document.getElementById('history-tbody');
        
        function resetForm() {
            form.reset();
            historyIdInput.value = '';
            submitBtn.textContent = '신규등록';
            cancelBtn.style.display = 'none';
        }

        form.addEventListener('submit', (e) => {
            e.preventDefault();
            const historyId = historyIdInput.value;
            const method = historyId ? 'PUT' : 'POST';
            const url = '/api/contact_history';
            
            const formData = new FormData(form);
            const data = Object.fromEntries(formData.entries());

            fetch(url, {
                method: method,
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(result => {
                if(result.success) {
                    alert(result.message);
                    location.reload();
                } else {
                    alert('오류: ' + result.message);
                }
            });
        });

        historyTbody.addEventListener('click', (e) => {
            const row = e.target.closest('tr');
            if (!row) return;
            const historyId = row.dataset.id;

            if (e.target.classList.contains('edit-btn')) {
                historyIdInput.value = historyId;
                let dtValue = row.querySelector('.datetime-value').textContent.trim().replace(' ', 'T');
                if (dtValue.length === 16) dtValue += ':00';
                datetimeInput.value = dtValue;
                form.contact_type.value = row.querySelector('.type').textContent;
                form.contact_person.value = row.querySelector('.person').textContent;
                form.memo.value = row.querySelector('.memo').textContent;
                
                submitBtn.textContent = '수정완료';
                cancelBtn.style.display = 'inline-block';
                form.scrollIntoView({ behavior: 'smooth' });
            }

            if (e.target.classList.contains('delete-btn')) {
                if (!confirm('정말로 이 이력을 삭제하시겠습니까?')) return;
                fetch(`/api/contact_history/${historyId}`, { method: 'DELETE' })
                    .then(response => response.json())
                    .then(result => {
                         if(result.success) {
                            alert('삭제되었습니다.');
                            row.remove();
                         } else {
                            alert('삭제 중 오류가 발생했습니다.');
                         }
                    });
            }
        });
        cancelBtn.addEventListener('click', resetForm);
    });
    </script>
</body>
</html>