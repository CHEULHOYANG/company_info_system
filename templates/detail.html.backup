<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title> (ych_p110) -   </title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
<header style="display:flex; align-items:center; justify-content:space-between;">
    <div>
        <h1 style="display:inline-block;"> (ych_p110) - {{ company.basic.company_name }} <span class="header-subtext"> </span></h1>
    </div>
    <div style="display:flex; align-items:center; gap:10px;">
    <button onclick="registerPioneering()" class="pioneering-button" style="background:#28a745; color:white; padding:8px 16px; border:none; border-radius:5px; cursor:pointer; font-weight:500;">ô</button>
    <button onclick="registerToPipeline()" class="pipeline-button" style="background:#007bff; color:white; padding:8px 16px; border:none; border-radius:5px; cursor:pointer; font-weight:500; margin-left:5px;">+ ɱ </button>
    
    {% set source = request.args.get('source', '') %}
    {% if source == 'popup' or source == 'history_popup' %}
        <!-- ˾  : ݱ ư ǥ -->
        <a href="javascript:window.close();" class="back-button" style="background:#dc3545;">ݱ</a>
    {% elif source == 'main' %}
        <!--  ȸ  :   ư ǥ -->
        <a href="javascript:history.back();" class="back-button"> </a>
    {% else %}
        <!-- ⺻:  ư ǥ -->
        <a href="{{ url_for('index') }}" class="back-button"> ȸ ư</a>
        <a href="javascript:history.back();" class="back-button"> </a>
    {% endif %}
    
    <span id="user-name-header" style="font-weight:bold; color:#333; margin-left:10px;">{{ user_name }}</span>
    </div>
</header>
<script>
document.addEventListener('DOMContentLoaded', function() {
    var closeXBtn = document.getElementById('close-x-btn');
    if (closeXBtn) {
        closeXBtn.onclick = function() {
            window.close();
        };
    }
});
</script>

<script>
//  ȯ 
function showTab(tabId, element) {
    console.log('showTab Լ ȣ:', tabId, element);
    
    //   ũ active Ŭ 
    var tabLinks = document.getElementsByClassName('tab-link');
    for (var i = 0; i < tabLinks.length; i++) {
        tabLinks[i].classList.remove('active');
    }
    
    //   Ʈ 
    var tabPanes = document.getElementsByClassName('tab-pane');
    for (var i = 0; i < tabPanes.length; i++) {
        tabPanes[i].classList.remove('active');
    }
    
    // õ  ̱
    element.classList.add('active');
    document.getElementById(tabId).classList.add('active');
    
    // ̷    ε
    if (tabId === 'tab2') {
        loadContactHistory();
    }
    
    console.log(' ȯ Ϸ:', tabId);
}

// ô Լ
function registerPioneering() {
    console.log('registerPioneering Լ ȣ');
    openPioneeringModal();
}

// ɱ  Լ
function registerToPipeline() {
    console.log('ɱ  Լ ȣ');
    
    const companyData = {
        biz_no: '{{ company.basic.biz_no }}',
        company_name: '{{ company.basic.company_name }}',
        representative_name: '{{ company.basic.representative_name }}'
    };
    
    //  â   ̵ (  Ͽ ڵ   )
    const pipelineUrl = `/pipeline?register=true&biz_no=${encodeURIComponent(companyData.biz_no)}&company_name=${encodeURIComponent(companyData.company_name)}&representative=${encodeURIComponent(companyData.representative_name)}`;
    
    console.log('  ̵:', pipelineUrl);
    window.location.href = pipelineUrl;
}
</script>
    </div>
</header>

        <div class="tab-nav">
            <button class="tab-link active" data-tab="tab1" onclick="showTab('tab1', this)">  ȸ</button>
            <button class="tab-link" data-tab="tab3" onclick="showTab('tab3', this)">AI ġ</button>
            <button class="tab-link" data-tab="tab2" onclick="showTab('tab2', this)">̷ </button>
        </div>

        <div class="tab-content">
            <div id="tab1" class="tab-pane active">
                <div class="detail-main-grid">
                    <div class="detail-left-column">
                        <div class="detail-card">
                            <h3>⺻ </h3>
                            <div class="info-grid">
                                <div><strong>ڹȣ</strong></div>
                                <div>{{ company.basic.biz_no }}</div>
                                <div><strong>ǥ</strong></div>
                                <div id="representative-display">
                                    <span id="representative-name-text">{{ company.basic.representative_name }}</span>
                                    {% if '*' in (company.basic.representative_name or '') %}
                                    <button id="representative-edit-btn" onclick="enableRepresentativeEdit()" class="edit-name-btn"></button>
                                    {% endif %}
                                    <input type="text" id="representative-name-input" style="display:none; width:100px; padding:3px;" maxlength="20">
                                    <button id="representative-save-btn" onclick="saveRepresentativeName()" class="save-name-btn" style="display:none;"></button>
                                    <button id="representative-cancel-btn" onclick="cancelRepresentativeEdit()" class="cancel-name-btn" style="display:none;"></button>
                                </div>
                                <div><strong></strong></div>
                                <div>{{ company.basic.establish_date }}</div>
                                <div><strong>Ը</strong></div>
                                <div>{{ company.basic.company_size }}</div>
                                <div><strong>ſ</strong></div>
                                <div>{{ company.basic.rating1 or 'N/A' }}</div>
                                <div><strong></strong></div>
                                <div>{{ company.basic.pension_count or 'N/A' }}</div>
                                <div><strong></strong></div>
                                <div>{{ company.basic.industry_name }}</div>
                                <div><strong>ּ</strong></div>
                                <div>{{ company.basic.address }}</div>
                                <div><strong>ü࿩</strong></div>
                                <div><span class="status-{{ 'yes' if company.basic.group_transaction_yn == 'Y' else 'no' }}">{{ '' if company.basic.group_transaction_yn == 'Y' else '' }}</span></div>
                                <div><strong>GFCŷ</strong></div>
                                <div><span class="status-{{ 'yes' if company.basic.gfc_transaction_yn == 'Y' else 'no' }}">{{ '' if company.basic.gfc_transaction_yn == 'Y' else '' }}</span></div>
                            </div>
                        </div>

                        <div class="detail-card">
                            <h3>  Ư </h3>
                            <table class="certs-grid">
                                <thead>
                                    <tr>
                                        <th></th><th>/ </th><th>/</th><th></th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td>μ</td>
                                        <td><span class="status-{{ 'yes' if company.additional.has_research_institute == '1' else 'no' }}">{{ '' if company.additional.has_research_institute == '1' else '̺' }}</span></td>
                                        <td>{{ company.additional.research_institute_date or '-' }}</td>
                                        <td>-</td>
                                    </tr>
                                    <tr>
                                        <td>̳</td>
                                        <td><span class="status-{{ 'yes' if company.additional.is_innobiz == '1' else 'no' }}">{{ '' if company.additional.is_innobiz == '1' else '' }}</span></td>
                                        <td>{{ company.additional.innobiz_cert_date or '-' }}</td>
                                        <td>{{ company.additional.innobiz_expiry_date or '-' }}</td>
                                    </tr>
                                    <tr>
                                        <td>κ</td>
                                        <td><span class="status-{{ 'yes' if company.additional.is_mainbiz == '1' else 'no' }}">{{ '' if company.additional.is_mainbiz == '1' else '' }}</span></td>
                                        <td>{{ company.additional.mainbiz_cert_date or '-' }}</td>
                                        <td>{{ company.additional.mainbiz_expiry_date or '-' }}</td>
                                    </tr>
                                    <tr>
                                        <td>ó</td>
                                        <td><span class="status-{{ 'yes' if company.additional.is_venture == '1' else 'no' }}">{{ '' if company.additional.is_venture == '1' else '' }}</span></td>
                                        <td>{{ company.additional.venture_cert_date or '-' }}</td>
                                        <td>{{ company.additional.venture_expiry_date or '-' }}</td>
                                    </tr>
                                    <tr>
                                        <td>Ư</td>
                                        <td colspan="3">
                                            : <strong>{{ company.additional.patent_applications_count or 0 }}</strong> / 
                                            : <strong>{{ company.additional.registered_patents_count or 0 }}</strong>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>

                        <div class="detail-card">
                            <h3>ֽİġ  ()</h3>
                            {% if company.stock_valuation and company.stock_valuation.total_shares_issued is defined %}
                            <div class="info-grid">
                                <div><strong>ڻ갡ġ</strong></div>
                                <div>{{ "{:,.0f}".format(company.stock_valuation.asset_value) if company.stock_valuation.asset_value else 'N/A' }} </div>
                                <div><strong>Ͱġ</strong></div>
                                <div>{{ "{:,.0f}".format(company.stock_valuation.profit_value) if company.stock_valuation.profit_value else 'N/A' }} </div>
                                <div><strong>1ִ 򰡾</strong></div>
                                <div><strong class="text-danger">{{ "{:,.0f}".format(company.stock_valuation.estimated_stock_value) if company.stock_valuation.estimated_stock_value else 'N/A' }} </strong></div>
                                <div></div>
                                <div><span class="text-primary-large">(ֽļ: {{ "{:,.0f}".format(company.stock_valuation.total_shares_issued) if company.stock_valuation.total_shares_issued else 'N/A' }} )</span></div>
                            </div>
                            {% else %}
                                <p>繫 Ͱ Ͽ ġ     ϴ.</p>
                            {% endif %}
                        </div>
                    </div>

                    <div class="detail-right-column">
                        <div class="detail-card">
                            <h3>繫  (ֱ 3, : õ)</h3>
                            {% if company.financials %}
                            <table class="results-table">
                                <thead>
                                    <tr>
                                        <th>׸</th>
                                        {% for fin in company.financials %}<th class="text-right">{{ fin.fiscal_year }}</th>{% endfor %}
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr><td></td>{% for fin in company.financials %} <td class="text-right">{{ "{:,.0f}".format((fin.sales_revenue / 1000)|round(0)) if fin.sales_revenue is not none else '' }}</td> {% endfor %}</tr>
                                    <tr><td></td>{% for fin in company.financials %} <td class="text-right">{{ "{:,.0f}".format((fin.operating_income / 1000)|round(0)) if fin.operating_income is not none else '' }}</td> {% endfor %}</tr>
                                    <tr><td>ڻѰ</td>{% for fin in company.financials %} <td class="text-right">{{ "{:,.0f}".format((fin.total_assets / 1000)|round(0)) if fin.total_assets is not none else '' }}</td> {% endfor %}</tr>
                                    <tr class="financial-separator"><td>ںѰ</td>{% for fin in company.financials %} <td class="text-right">{{ "{:,.0f}".format(fin.total_equity) if fin.total_equity is not none else '' }}</td> {% endfor %}</tr>
                                    <tr><td>μ</td>{% for fin in company.financials %} <td class="text-right">{{ "{:,.0f}".format((fin.corporate_tax / 1000)|round(0)) if fin.corporate_tax is not none else '' }}</td> {% endfor %}</tr>
                                </tbody>
                            </table>
                            
                            <!-- ٽ 繫 ǥ (ֱٳ⵵) - ¿  -->
                            <div style="margin-top: 30px;">
                                <h4>ٽ 繫 ǥ ({{ company.financials[0].fiscal_year }} , : õ)</h4>
                                <div style="display: flex; gap: 20px;">
                                    <!-- : 繫 ǥ ̺ -->
                                    <div style="flex: 1; min-width: 200px;">
                                        <table class="results-table">
                                            <tbody>
                                                <tr><td><strong>ڻѰ</strong></td><td class="text-right"><strong>{{ "{:,.0f}".format((company.financials[0].total_assets / 1000)|round(0)) if company.financials[0].total_assets is not none else '' }}</strong></td></tr>
                                                <tr><td><strong>׿</strong></td><td class="text-right"><strong>{{ "{:,.0f}".format((company.financials[0].retained_earnings / 1000)|round(0)) if company.financials[0].retained_earnings is not none else '' }}</strong></td></tr>
                                                <tr><td>ޱ</td><td class="text-right">{{ "{:,.0f}".format((company.financials[0].advances_paid / 1000)|round(0)) if company.financials[0].advances_paid is not none else '' }}</td></tr>
                                                <tr><td></td><td class="text-right">{{ "{:,.0f}".format((company.financials[0].advances_received / 1000)|round(0)) if company.financials[0].advances_received is not none else '' }}</td></tr>
                                            </tbody>
                                        </table>
                                    </div>
                                    <!-- : / Ʈ -->
                                    <div style="flex: 1; min-width: 250px;">
                                        <canvas id="financialChart" style="max-height: 180px;"></canvas>
                                        <div id="chartLegend" style="display: flex; justify-content: center; gap: 30px; margin-top: 8px; font-size: 12px;">
                                            <span style="display: flex; align-items: center; gap: 5px;"><span style="display:inline-block; width:12px; height:12px; background:#4a9fd9; border-radius:2px;"></span></span>
                                            <span style="display: flex; align-items: center; gap: 5px;"><span style="display:inline-block; width:12px; height:12px; background:#28a745; border-radius:2px;"></span></span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% else %}<p>繫  ϴ.</p>{% endif %}
                        </div>
                        <div class="detail-card">
                            <h3>ǥ   </h3>
                            <h4>ǥ</h4>
                            {% if company.representatives %}
                            <table class="results-table">
                                <thead><tr><th></th><th></th><th></th><th>GFC</th><th></th></tr></thead>
                                <tbody>
                                {% for rep in company.representatives %}
                                <tr id="rep-row-{{ loop.index }}">
                                    <td>{{ rep.name }}</td><td>{{ rep.birth_date }}</td><td>{{ rep.gender }}</td>
                                    <td><span class="status-{{ 'yes' if rep.is_gfc == 'Y' else 'no' }}">{{ 'Y' if rep.is_gfc == 'Y' else 'N' }}</span></td>
                                    <td>
                                        {% if '*' in (rep.name or '') %}
                                        <button onclick="deleteRepresentative('{{ company.basic.biz_no }}', '{{ rep.name }}', {{ loop.index }})" class="delete-btn-small"></button>
                                        {% else %}
                                        -
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                                </tbody>
                            </table>
                            {% else %}<p>ǥ  ϴ.</p>{% endif %}
                            {% set has_predicted = company.shareholders | selectattr("is_predicted", "equalto", true) | list | length > 0 %}
                            {% set has_actual = company.shareholders | selectattr("is_predicted", "equalto", false) | list | length > 0 %}
                            <h4>  
                                {% if has_predicted and not has_actual %}
                                    <span style="font-weight: bold; color: #e74c3c; font-size: 14px;">( ֽļ)</span>
                                {% elif has_predicted and has_actual %}
                                    <span style="font-weight: bold; color: #2980b9; font-size: 14px;">( +  ֽļ)</span>
                                {% endif %}
                            </h4>
                            {% if company.shareholders %}
                            <table class="results-table">
                                <thead>
                                    <tr>
                                        <th>ָ</th>
                                        <th {% if has_predicted and not has_actual %}title="ֽļ     ֽļ"{% endif %}>
                                            ֽļ{% if has_predicted and not has_actual %} *{% endif %}
                                        </th>
                                        <th></th>
                                        <th>ֽİ</th>
                                        <th></th>
                                        <th></th>
                                    </tr>
                                </thead>
                                <tbody>
                                {% for holder in company.shareholders %}
                                <tr id="shareholder-row-{{ loop.index }}">
                                    <td>{{ holder.shareholder_name or '' }}</td>
                                    <td style="text-align: right;{% if holder.is_predicted %} color: #666;{% endif %}" 
                                        {% if holder.is_predicted %}title=" ֽļ (ֽļ  )"{% endif %}>
                                        {{ "{:,.0f}".format(holder.stock_quantity|default(0)) }}{% if holder.is_predicted %} *{% endif %}
                                    </td>
                                    <td>
                                        <div class="progress-container-improved">
                                            <div class="progress-bar-improved" style="width: {{ holder.ownership_percent|default(0) }}%;"></div>
                                            <div class="progress-text-improved progress-text-{% if (holder.ownership_percent|default(0)) < 15 %}dark{% else %}light{% endif %}">
                                                {{ "{:.2f}".format(holder.ownership_percent|default(0)) }}%
                                            </div>
                                        </div>
                                    </td>
                                    <td style="text-align: right;">{{ "{:,.0f}".format(holder.stock_value_amount|default(0)) }}</td>
                                    <td>{{ holder.relationship or '' }}</td>
                                    <td>
                                        {% if '*' in (holder.shareholder_name or '') %}
                                        <button onclick="deleteShareholder('{{ company.basic.biz_no }}', '{{ holder.shareholder_name }}', {{ loop.index }})" class="delete-btn-small"></button>
                                        {% else %}
                                        -
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                                </tbody>
                            </table>
                            {% if has_predicted %}
                                <p style="font-size: 12px; color: #666; margin-top: 10px; font-style: italic;">
                                    * ǥ(*) ǥõ ֽļ ֽļ    Դϴ.
                                </p>
                            {% endif %}
                            {% else %}<p>  ϴ.</p>{% endif %}
                        </div>
                    </div>
                </div>
            </div>

            <!-- ̷   -->
            <div id="tab2" class="tab-pane">
                <div class="contact-history-container">
                    <!-- ̷   -->
                    <div class="contact-form-section">
                        <h3>̷ </h3>
                        <form id="contactHistoryForm" class="contact-form">
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="contactDate">Ͻ *</label>
                                    <input type="datetime-local" id="contactDate" name="contactDate" required>
                                </div>
                                <div class="form-group">
                                    <label for="contactType"> *</label>
                                    <select id="contactType" name="contactType" required>
                                        <option value="">ϼ</option>
                                        <option value="ȭ">ȭ</option>
                                        <option value="ڹ߼">ڹ߼</option>
                                        <option value=""></option>
                                        <option value=""></option>
                                        <option value="̳">̳</option>
                                        <option value="DM߼">DM߼</option>
                                        <option value="Ÿ">Ÿ</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="contactPerson">˴</label>
                                    <input type="text" id="contactPerson" name="contactPerson" placeholder=" ڸ">
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="contactMemo">˳ *</label>
                                <textarea id="contactMemo" name="contactMemo" rows="4" placeholder="   Էϼ" required></textarea>
                            </div>
                            <div class="form-buttons">
                                <button type="submit" class="btn-primary"></button>
                                <button type="button" class="btn-secondary" onclick="resetContactForm()">ʱȭ</button>
                            </div>
                        </form>
                    </div>

                    <!-- ̷  -->
                    <div class="contact-history-section">
                        <h3>{{ company.basic.company_name }} ̷</h3>
                        <div class="contact-history-list" id="contactHistoryList">
                            <div class="loading">̷ ҷ ...</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- AI ġ  -->
            <div id="tab3" class="tab-pane">
                <div class="ai-search-section">
                    <h3>AI  м</h3>
                    <div class="ai-analysis-container">
                        <div class="analysis-status">
                            <h4>AI  м </h4>
                            <p>OpenAI GPT-4 Ȱ    м մϴ.</p>
                            <div class="analysis-features">
                                <div class="feature-item">-   繫 м</div>
                                <div class="feature-item">-    ũ </div>
                                <div class="feature-item">-    ǰ </div>
                            </div>
                            <button class="analysis-btn" onclick="startAIAnalysis()">
                                 AI м 
                            </button>
                        </div>
                        <div class="analysis-results" id="aiAnalysisResults" style="display: none;">
                            <div class="loading">
                                <div class="loading-spinner"></div>
                                <div>AI  ͸ мϰ ֽϴ...<br><small>   м  Դϴ.</small></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ̷   -->
    <div id="editContactModal" class="modal" style="display: none;">
        <div class="modal-content">
            <span class="close" onclick="closeEditContactModal()">&times;</span>
            <h3>̷ </h3>
            <form id="editContactForm" class="contact-form">
                <input type="hidden" id="editHistoryId" name="historyId">
                <div class="form-row">
                    <div class="form-group">
                        <label for="editContactDate">Ͻ *</label>
                        <input type="datetime-local" id="editContactDate" name="contactDate" required>
                    </div>
                    <div class="form-group">
                        <label for="editContactType"> *</label>
                        <select id="editContactType" name="contactType" required>
                            <option value="">ϼ</option>
                            <option value="ȭ">ȭ</option>
                            <option value="ڹ߼">ڹ߼</option>
                            <option value=""></option>
                            <option value=""></option>
                            <option value="̳">̳</option>
                            <option value="DM߼">DM߼</option>
                            <option value="Ÿ">Ÿ</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="editContactPerson">˴</label>
                        <input type="text" id="editContactPerson" name="contactPerson" placeholder=" ڸ">
                    </div>
                </div>
                <div class="form-group">
                    <label for="editContactMemo">˳ *</label>
                    <textarea id="editContactMemo" name="contactMemo" rows="4" placeholder="   Էϼ" required></textarea>
                </div>
                <div class="form-buttons">
                    <button type="submit" class="btn-primary"></button>
                    <button type="button" class="btn-danger" onclick="deleteContactHistory()"></button>
                    <button type="button" class="btn-secondary" onclick="closeEditContactModal()"></button>
                </div>
            </form>
        </div>
    </div>

    <style>
    /* 繫ǥ Ÿ */
    .financial-separator td {
        border-bottom: 2px solid #333 !important;
        font-weight: bold;
    }
    
    /* ǥ ̸  ư Ÿ */
    .edit-name-btn, .save-name-btn, .cancel-name-btn {
        padding: 3px 10px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 12px;
        margin-left: 5px;
    }
    .edit-name-btn {
        background: #ffc107;
        color: #000;
    }
    .save-name-btn {
        background: #28a745;
        color: white;
    }
    .cancel-name-btn {
        background: #6c757d;
        color: white;
    }
    .edit-name-btn:hover { background: #e0a800; }
    .save-name-btn:hover { background: #218838; }
    .cancel-name-btn:hover { background: #545b62; }
    
    /*  ư Ÿ () */
    .delete-btn-small {
        padding: 3px 8px;
        border: none;
        border-radius: 4px;
        background: #dc3545;
        color: white;
        cursor: pointer;
        font-size: 11px;
    }
    .delete-btn-small:hover {
        background: #c82333;
    }
    
    /* ̷  Ÿ */
    .contact-history-container {
        padding: 20px;
        max-width: 1200px;
        margin: 0 auto;
    }

    .contact-form-section {
        background: white;
        border-radius: 10px;
        padding: 25px;
        margin-bottom: 30px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }

    .contact-form-section h3 {
        margin-top: 0;
        color: #333;
        border-bottom: 2px solid #007bff;
        padding-bottom: 10px;
    }

    .contact-form .form-row {
        display: grid;
        grid-template-columns: 1fr 1fr 1fr;
        gap: 20px;
        margin-bottom: 20px;
    }

    .contact-form .form-group {
        display: flex;
        flex-direction: column;
    }

    .contact-form label {
        font-weight: 500;
        margin-bottom: 5px;
        color: #333;
    }

    .contact-form input, .contact-form select, .contact-form textarea {
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 5px;
        font-size: 14px;
        transition: border-color 0.3s;
    }

    .contact-form input:focus, .contact-form select:focus, .contact-form textarea:focus {
        outline: none;
        border-color: #007bff;
        box-shadow: 0 0 0 2px rgba(0,123,255,0.25);
    }

    .form-buttons {
        display: flex;
        gap: 10px;
        justify-content: flex-end;
        margin-top: 20px;
    }

    .btn-primary, .btn-secondary, .btn-danger {
        padding: 10px 20px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-size: 14px;
        transition: background-color 0.3s;
        margin: 0 5px;
    }

    .btn-primary {
        background: #007bff;
        color: white;
    }

    .btn-primary:hover {
        background: #0056b3;
    }

    .btn-secondary {
        background: #6c757d;
        color: white;
    }

    .btn-secondary:hover {
        background: #545b62;
    }

    .btn-danger {
        background: #dc3545;
        color: white;
    }

    .btn-danger:hover {
        background: #c82333;
    }

    .contact-history-section {
        background: white;
        border-radius: 10px;
        padding: 25px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }

    .contact-history-section h3 {
        margin-top: 0;
        color: #333;
        border-bottom: 2px solid #28a745;
        padding-bottom: 10px;
    }

    .contact-history-item {
        border: 1px solid #e9ecef;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 15px;
        background: #f8f9fa;
        transition: transform 0.2s;
    }

    .contact-history-item:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }

    .contact-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
    }

    .contact-info {
        display: flex;
        gap: 20px;
        font-size: 14px;
    }

    .contact-type {
        background: #007bff;
        color: white;
        padding: 2px 8px;
        border-radius: 12px;
        font-size: 12px;
    }

    .contact-actions {
        display: flex;
        gap: 5px;
    }

    .action-btn {
        padding: 5px 10px;
        border: none;
        border-radius: 3px;
        cursor: pointer;
        font-size: 12px;
    }

    .edit-btn {
        background: #ffc107;
        color: #000;
    }

    .delete-btn {
        background: #dc3545;
        color: white;
    }

    .contact-content {
        background: white;
        padding: 10px;
        border-radius: 5px;
        line-height: 1.5;
    }

    .loading {
        text-align: center;
        padding: 40px;
        color: #666;
    }

    .no-data {
        text-align: center;
        padding: 40px;
        color: #666;
        font-style: italic;
    }

    /*  Ÿ */
    .modal {
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0,0,0,0.5);
    }

    .modal-content {
        background-color: white;
        margin: 5% auto;
        padding: 30px;
        border-radius: 10px;
        width: 80%;
        max-width: 600px;
        position: relative;
    }

    .close {
        position: absolute;
        right: 15px;
        top: 15px;
        font-size: 24px;
        font-weight: bold;
        cursor: pointer;
        color: #aaa;
    }

    .close:hover {
        color: #000;
    }

    /* ֱ   Ÿ */
    .progress-container-improved {
        position: relative;
        background: #e9ecef;
        border-radius: 10px;
        height: 28px; /*   */
        overflow: visible;
        min-width: 120px; /* ּ   */
        border: 1px solid #dee2e6; /* ׵θ ߰ */
    }

    .progress-bar-improved {
        background: linear-gradient(45deg, #007bff, #0056b3);
        height: 100%;
        border-radius: 10px;
        position: relative;
        min-width: 3px; /* ּ   */
        box-shadow: inset 0 1px 2px rgba(0,0,0,0.1); /* ̰ ߰ */
    }

    .progress-text-improved {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        font-weight: bold;
        font-size: 13px; /* Ʈ ũ  */
        z-index: 10;
        white-space: nowrap;
        text-align: center;
    }

    .progress-text-dark {
        color: #2d3436; /*    */
        text-shadow: 
            1px 1px 2px rgba(255,255,255,0.9),
            -1px -1px 2px rgba(255,255,255,0.9),
            1px -1px 2px rgba(255,255,255,0.9),
            -1px 1px 2px rgba(255,255,255,0.9); /* 4 ׸ڷ   */
    }

    .progress-text-light {
        color: #ffffff;
        text-shadow: 
            1px 1px 3px rgba(0,0,0,0.8),
            -1px -1px 3px rgba(0,0,0,0.8),
            1px -1px 3px rgba(0,0,0,0.8),
            -1px 1px 3px rgba(0,0,0,0.8); /* 4 ׸ڷ   */
    }

    @media (max-width: 768px) {
        .contact-form .form-row {
            grid-template-columns: 1fr;
        }
        
        .contact-info {
            flex-direction: column;
            gap: 5px;
        }
    }

    /* AI м Ÿ */
    .ai-search-section {
        padding: 20px;
        background: rgba(255, 255, 255, 0.95);
        border-radius: 15px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
    }

    .ai-analysis-container {
        max-width: 800px;
        margin: 0 auto;
    }

    .analysis-status {
        text-align: center;
        padding: 40px 20px;
    }

    .analysis-btn {
        background: linear-gradient(135deg, #2c5aa0, #4a9fd9);
        color: white;
        border: none;
        padding: 15px 30px;
        border-radius: 25px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        margin-top: 20px;
    }

    .analysis-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(44, 90, 160, 0.3);
    }

    .analysis-results {
        margin-top: 20px;
    }

    .ai-analysis-report {
        background: white;
        border-radius: 10px;
        padding: 25px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
    }

    .analysis-section {
        margin-bottom: 25px;
        padding-bottom: 20px;
        border-bottom: 1px solid #eee;
    }

    .analysis-section:last-child {
        border-bottom: none;
        margin-bottom: 0;
    }

    .analysis-section h5 {
        color: #2c5aa0;
        margin-bottom: 10px;
        font-size: 18px;
        font-weight: 600;
    }
    
    .analysis-section p {
        line-height: 1.6;
        color: #333;
        margin: 0;
    }
    
    .loading {
        text-align: center;
        padding: 40px;
        color: #666;
        font-size: 16px;
    }
    
    .error {
        text-align: center;
        padding: 40px;
        color: #e74c3c;
        font-size: 16px;
        background: #ffe6e6;
        border-radius: 5px;
    }
    
    .analysis-features {
        margin: 20px 0;
        display: flex;
        flex-direction: column;
        gap: 8px;
    }
    
    .feature-item {
        color: #2c5aa0;
        font-weight: 500;
        font-size: 14px;
    }
    
    .btn-icon {
        margin-right: 8px;
        font-size: 18px;
    }
    
    .loading-spinner {
        width: 40px;
        height: 40px;
        border: 4px solid #f3f3f3;
        border-top: 4px solid #2c5aa0;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin: 0 auto 15px;
    }
    
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    
    .loading small {
        color: #666;
        font-size: 12px;
    }
    }

    .analysis-section p {
        line-height: 1.6;
        color: #333;
        margin: 0;
    }

    .loading {
        text-align: center;
        padding: 40px;
        color: #666;
        font-size: 16px;
    }

    .error {
        text-align: center;
        padding: 20px;
        background: #fee;
        color: #c33;
        border: 1px solid #fcc;
        border-radius: 5px;
        margin: 10px 0;
    }
    </style>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        //  ȯ 
        const tabLinks = document.querySelectorAll('.tab-link');
        const tabPanes = document.querySelectorAll('.tab-pane');

        tabLinks.forEach(link => {
            link.addEventListener('click', () => {
                const tabId = link.getAttribute('data-tab');

                tabLinks.forEach(item => item.classList.remove('active'));
                tabPanes.forEach(item => item.classList.remove('active'));

                link.classList.add('active');
                document.getElementById(tabId).classList.add('active');

                // ̷  Ŭ   ε
                if (tabId === 'tab2') {
                    loadContactHistory();
                }
            });
        });

        // ̷   ̺Ʈ
        document.getElementById('contactHistoryForm').addEventListener('submit', submitContactHistory);
        document.getElementById('editContactForm').addEventListener('submit', updateContactHistory);
    });

    // ô  Լ
    function openPioneeringModal() {
        document.getElementById('pioneeringModal').style.display = 'block';
        //  ¥ ⺻ 
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('visitDate').value = today;
    }

    function closePioneeringModal() {
        document.getElementById('pioneeringModal').style.display = 'none';
        document.getElementById('pioneeringForm').reset();
    }

    // ô  
    async function submitPioneeringForm() {
        const visitDate = document.getElementById('visitDate').value;
        const notes = document.getElementById('pioneeringNotes').value;
        
        if (!visitDate) {
            alert('湮ڸ Էּ.');
            return;
        }
        
        // ¥ :  üũ
        const selectedDate = new Date(visitDate);
        const today = new Date();
        today.setHours(0, 0, 0, 0); // ð 00:00:00 Ͽ ¥ 
        
        if (selectedDate < today) {
            alert(' ¥   ϴ.   ¥ ּ.');
            return;
        }
        
        // ָ üũ (: 6, Ͽ: 0)
        const dayOfWeek = selectedDate.getDay();
        if (dayOfWeek === 0 || dayOfWeek === 6) {
            if (!confirm('Դϴ. ׷ Ͻðڽϱ?')) {
                return;
            }
        }
        
        const formData = {
            biz_no: '{{ company.basic.biz_no }}',
            visit_date: visitDate,
            notes: notes,
            visitor_id: '{{ user_id }}'
        };
        
        //  ư Ȱȭ
        const submitBtn = document.querySelector('#pioneeringModal button[onclick="submitPioneeringForm()"]');
        const originalText = submitBtn.textContent;
        submitBtn.disabled = true;
        submitBtn.textContent = ' ...';
        
        try {
            const response = await fetch('/api/pioneering_targets', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(formData)
            });
            
            const result = await response.json();
            
            if (result.success) {
                alert('ô   ϵǾϴ.');
                closePioneeringModal();
                //  ΰħ ֽ  ݿ
                location.reload();
            } else {
                alert(result.message || 'Ͽ ߽ϴ.');
            }
        } catch (error) {
            alert('   ߻߽ϴ. ٽ õּ.');
        } finally {
            //  ư 
            const submitBtn = document.querySelector('#pioneeringModal button[onclick="submitPioneeringForm()"]');
            if (submitBtn) {
                submitBtn.disabled = false;
                submitBtn.textContent = '';
            }
        }
    }

    // ̷  Լ
    let contactEditingId = null;

    // ̷  ε
    async function loadContactHistory() {
        const bizNo = '{{ company.basic.biz_no }}';
        const listContainer = document.getElementById('contactHistoryList');
        
        try {
            listContainer.innerHTML = '<div class="loading">̷ ҷ ...</div>';
            
            //  API  (/api/history_search)
            const response = await fetch(`/api/history_search?biz_no=${bizNo}`);
            const data = await response.json();
            
            //  API 迭  ȯ
            if (Array.isArray(data) && data.length > 0) {
                displayContactHistory(data);
            } else {
                listContainer.innerHTML = '<div class="no-data">ϵ ̷ ϴ.</div>';
            }
        } catch (error) {
            console.error('̷ ε :', error);
            listContainer.innerHTML = '<div class="no-data">̷ ҷµ ߽ϴ.</div>';
        }
    }

    // ̷  ǥ
    function displayContactHistory(historyList) {
        const listContainer = document.getElementById('contactHistoryList');
        
        const historyHtml = historyList.map(history => `
            <div class="contact-history-item">
                <div class="contact-header">
                    <div class="contact-info">
                        <span class="contact-type">${history.contact_type || 'Ÿ'}</span>
                        <span><strong>Ͻ:</strong> ${formatDateTime(history.contact_datetime)}</span>
                        ${history.contact_person ? `<span><strong>:</strong> ${history.contact_person}</span>` : ''}
                        <span><strong>:</strong> ${history.registered_by}</span>
                    </div>
                    <div class="contact-actions">
                        <button class="action-btn edit-btn" onclick="editContactHistory(${history.history_id})"></button>
                        <button class="action-btn delete-btn" onclick="deleteContactHistory(${history.history_id})"></button>
                    </div>
                </div>
                <div class="contact-content">${history.memo || ' '}</div>
            </div>
        `).join('');
        
        listContainer.innerHTML = historyHtml;
    }

    // ̷ 
    async function submitContactHistory(e) {
        e.preventDefault();
        
        const form = document.getElementById('contactHistoryForm');
        const formData = new FormData(form);
        const bizNo = '{{ company.basic.biz_no }}';
        
        const contactData = {
            biz_no: bizNo,
            contact_datetime: formData.get('contactDate'),
            contact_type: formData.get('contactType'),
            contact_person: formData.get('contactPerson'),
            memo: formData.get('contactMemo')
        };

        try {
            const response = await fetch('/api/contact_history', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(contactData)
            });

            const result = await response.json();
            
            if (result.success) {
                alert('̷ ϵǾϴ.');
                form.reset();
                loadContactHistory(); //  ΰħ
            } else {
                alert(' : ' + result.message);
            }
        } catch (error) {
            console.error(' :', error);
            alert('̷    ߻߽ϴ.');
        }
    }

    // ̷   
    async function editContactHistory(historyId) {
        console.log(`>>> editContactHistory ȣ - historyId: ${historyId}`);
        try {
            const url = `/api/contact_history/${historyId}`;
            console.log(`>>> API ȣ URL: ${url}`);
            
            const response = await fetch(url);
            console.log(`>>> Response status: ${response.status}`);
            console.log(`>>> Response headers:`, response.headers);
            
            const data = await response.json();
            console.log(`>>> Response data:`, data);
            
            if (data.success && data.data) {
                const history = data.data;
                contactEditingId = historyId;
                
                console.log(`>>>    ...`);
                document.getElementById('editHistoryId').value = historyId;
                document.getElementById('editContactDate').value = formatDateTimeForInput(history.contact_datetime);
                document.getElementById('editContactType').value = history.contact_type;
                document.getElementById('editContactPerson').value = history.contact_person || '';
                document.getElementById('editContactMemo').value = history.memo || '';
                
                console.log(`>>>  ǥ`);
                document.getElementById('editContactModal').style.display = 'block';
            } else {
                console.error(`>>> API  :`, data);
                alert('̷  ҷ  ϴ.  : ' + (data.message || '   '));
            }
        } catch (error) {
            console.error('>>> ̷ ҷ :', error);
            alert('̷ ҷ  Ʈũ  ߻߽ϴ: ' + error.message);
        }
    }

    // ̷ 
    async function updateContactHistory(e) {
        e.preventDefault();
        
        const form = document.getElementById('editContactForm');
        const formData = new FormData(form);
        const historyId = formData.get('historyId');
        
        const contactData = {
            contact_datetime: formData.get('contactDate'),
            contact_type: formData.get('contactType'),
            contact_person: formData.get('contactPerson'),
            memo: formData.get('contactMemo')
        };

        try {
            const response = await fetch(`/api/contact_history/${historyId}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(contactData)
            });

            const result = await response.json();
            
            if (result.success) {
                alert('̷ Ǿϴ.');
                closeEditContactModal();
                loadContactHistory(); //  ΰħ
            } else {
                alert(' : ' + result.message);
            }
        } catch (error) {
            console.error(' :', error);
            alert('̷    ߻߽ϴ.');
        }
    }

    // ̷ 
    async function deleteContactHistory(historyId) {
        if (!confirm(' ̷ Ͻðڽϱ?')) {
            return;
        }

        try {
            const response = await fetch(`/api/contact_history/${historyId}`, {
                method: 'DELETE'
            });

            const result = await response.json();
            
            if (result.success) {
                alert('̷ Ǿϴ.');
                loadContactHistory(); //  ΰħ
            } else {
                alert(' : ' + result.message);
            }
        } catch (error) {
            console.error(' :', error);
            alert('̷    ߻߽ϴ.');
        }
    }

    //   ݱ
    function closeEditContactModal() {
        document.getElementById('editContactModal').style.display = 'none';
        document.getElementById('editContactForm').reset();
        contactEditingId = null;
    }

    // ̷ 
    async function deleteContactHistory() {
        if (!contactEditingId) {
            alert(' ̷ ã  ϴ.');
            return;
        }

        if (!confirm('  ̷ Ͻðڽϱ?')) {
            return;
        }

        try {
            const response = await fetch(`/api/contact_history/${contactEditingId}`, {
                method: 'DELETE'
            });

            const result = await response.json();

            if (result.success) {
                alert('̷  Ǿϴ.');
                closeEditContactModal();
                loadContactHistory(); //  ΰħ
            } else {
                alert(result.message || ' ߽ϴ.');
            }
        } catch (error) {
            console.error(' :', error);
            alert('   ߻߽ϴ.');
        }
    }

    // ̷  ʱȭ
    function resetContactForm() {
        document.getElementById('contactHistoryForm').reset();
    }

    // ¥/ð  Լ
    function formatDateTime(dateTimeStr) {
        if (!dateTimeStr) return '';
        const date = new Date(dateTimeStr);
        return date.toLocaleString('ko-KR');
    }

    function formatDateTimeForInput(dateTimeStr) {
        if (!dateTimeStr) return '';
        const date = new Date(dateTimeStr);
        return date.toISOString().slice(0, 16);
    }

    //  ܺ Ŭ  ݱ
    window.onclick = function(event) {
        const pioneeringModal = document.getElementById('pioneeringModal');
        const editContactModal = document.getElementById('editContactModal');
        
        if (event.target === pioneeringModal) {
            closePioneeringModal();
        }
        if (event.target === editContactModal) {
            closeEditContactModal();
        }
    }

    </script>

    <!-- ô  -->
    <div id="pioneeringModal" style="display:none; position:fixed; z-index:1000; left:0; top:0; width:100%; height:100%; background-color:rgba(0,0,0,0.5);">
        <div style="background-color:white; margin:15% auto; padding:30px; border-radius:15px; width:90%; max-width:500px; box-shadow:0 4px 20px rgba(0,0,0,0.3);">
            <h2 style="margin-top:0; color:#28a745;">ô   (ych_P111)</h2>
            <form id="pioneeringForm">
                <div style="margin-bottom:20px;">
                    <label style="display:block; margin-bottom:5px; font-weight:500;">:</label>
                    <input type="text" value="{{ company.basic.company_name }}" readonly style="width:100%; padding:10px; border:1px solid #ced4da; border-radius:5px; background:#f8f9fa; box-sizing:border-box;">
                </div>
                
                <div style="margin-bottom:20px;">
                    <label style="display:block; margin-bottom:5px; font-weight:500;">ڹȣ:</label>
                    <input type="text" value="{{ company.basic.biz_no }}" readonly style="width:100%; padding:10px; border:1px solid #ced4da; border-radius:5px; background:#f8f9fa; box-sizing:border-box;">
                </div>
                
                <div style="margin-bottom:20px;">
                    <label for="visitDate" style="display:block; margin-bottom:5px; font-weight:500;">湮 *:</label>
                    <input type="date" id="visitDate" required style="width:100%; padding:10px; border:1px solid #ced4da; border-radius:5px; box-sizing:border-box;">
                </div>
                
                <div style="margin-bottom:30px;">
                    <label for="pioneeringNotes" style="display:block; margin-bottom:5px; font-weight:500;">޸:</label>
                    <textarea id="pioneeringNotes" placeholder="ô  ޸..." style="width:100%; padding:10px; border:1px solid #ced4da; border-radius:5px; min-height:80px; resize:vertical; box-sizing:border-box;"></textarea>
                </div>
                
                <div style="display:flex; gap:10px; justify-content:flex-end;">
                    <button type="button" onclick="closePioneeringModal()" style="padding:10px 20px; border:none; border-radius:5px; background:#6c757d; color:white; cursor:pointer;"></button>
                    <button type="button" onclick="submitPioneeringForm()" style="padding:10px 20px; border:none; border-radius:5px; background:#28a745; color:white; cursor:pointer;"></button>
                </div>
            </form>
        </div>
    </div>

    <!-- ũ ư -->
    <div id="scrollButtons" style="position: fixed; right: 20px; bottom: 20px; z-index: 1000; display: flex; flex-direction: column; gap: 10px;">
        <button onclick="scrollToTop()" title=" " style="
            width: 50px; height: 50px; border-radius: 50%; 
            background: #007bff; color: white; border: none; 
            cursor: pointer; font-size: 18px; box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            transition: all 0.3s ease;
        "></button>
        <button onclick="scrollToBottom()" title=" Ʒ" style="
            width: 50px; height: 50px; border-radius: 50%; 
            background: #28a745; color: white; border: none; 
            cursor: pointer; font-size: 18px; box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            transition: all 0.3s ease;
        "></button>
    </div>

    <script>
    // ũ ư 
    function scrollToTop() {
        window.scrollTo({
            top: 0,
            behavior: 'smooth'
        });
    }

    function scrollToBottom() {
        window.scrollTo({
            top: document.body.scrollHeight,
            behavior: 'smooth'
        });
    }

    // ũ ư ȣ ȿ
    document.addEventListener('DOMContentLoaded', function() {
        const scrollButtons = document.querySelectorAll('#scrollButtons button');
        scrollButtons.forEach(button => {
            button.addEventListener('mouseenter', function() {
                this.style.transform = 'scale(1.1)';
                this.style.boxShadow = '0 4px 15px rgba(0,0,0,0.3)';
            });
            button.addEventListener('mouseleave', function() {
                this.style.transform = 'scale(1)';
                this.style.boxShadow = '0 2px 10px rgba(0,0,0,0.2)';
            });
        });
    });

    // AI м 
    function startAIAnalysis() {
        console.log('[DEBUG] startAIAnalysis called');
        
        var bizNo = window.currentBizNo || document.body.dataset.bizNo || '1018100340';
        var resultsDiv = document.getElementById('aiAnalysisResults');
        var statusDiv = document.querySelector('.analysis-status');
        if (!resultsDiv) {
            console.error('aiAnalysisResults not found');
            return;
        }
        
        resultsDiv.innerHTML = '<div style="text-align:center;padding:40px;">' +
            '<div style="width:50px;height:50px;border:4px solid #f3f3f3;border-top:4px solid #2c5aa0;border-radius:50%;margin:0 auto 20px;animation:spin 1s linear infinite;"></div>' +
            '<p style="color:#666;">AI analyzing company data...</p>' +
            '<div id="analysisProgress"></div>' +
            '</div><style>@keyframes spin{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}</style>';
        
        var steps = ['Loading data...', 'Analyzing shareholders...', 'Analyzing financials...', 'Generating report...'];
        var stepIdx = 0;
        var progressDiv = document.getElementById('analysisProgress');
        var progressInt = setInterval(function() {
            if (stepIdx < steps.length && progressDiv) {
                var el = document.createElement('div');
                el.style.marginTop = '5px';
                el.style.color = '#888';
                el.style.fontSize = '13px';
                el.textContent = steps[stepIdx];
                progressDiv.appendChild(el);
                stepIdx++;
            }
        }, 1000);
        
        fetch('/api/company-analysis-data/' + bizNo)
            .then(function(r) { return r.json(); })
            .then(function(data) {
                if (!data.success) throw new Error(data.message || 'Data load failed');
                return fetch('/api/ai-analysis', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({biz_no: bizNo, company_name: data.data.company_name || ''})
                }).then(function(r) { return r.json(); })
                  .then(function(aiData) { return {analysisData: data.data, aiResult: aiData}; });
            })
            .then(function(result) {
                clearInterval(progressInt);
                if (!result.aiResult.success) throw new Error(result.aiResult.message || 'AI analysis failed');
                displayEnhancedResults(result.analysisData, result.aiResult.analysis, resultsDiv);
                // FIX: Ensure results are visible
                resultsDiv.style.display = 'block';
                if (statusDiv) statusDiv.style.display = 'none';
            })
            .catch(function(err) {
                clearInterval(progressInt);
                console.error(err);
                resultsDiv.innerHTML = '<div style="text-align:center;padding:30px;background:#fff5f5;border-radius:10px;">' +
                    '<p style="color:#dc3545;font-weight:bold;">Error: ' + err.message + '</p>' +
                    '<button onclick="startAIAnalysis()" style="padding:10px 20px;
                resultsDiv.style.display = 'block';background:#2c5aa0;color:white;border:none;border-radius:5px;cursor:pointer;margin-top:10px;">Retry</button></div>';
            });
    }
    
    function displayAIAnalysis(analysis) {
        const resultsContainer = document.getElementById('aiAnalysisResults');
        
        let html = '<div class="ai-analysis-report">';
        html += '<h4>AI  м </h4>';
        
        if (analysis.summary) {
            html += '<div class="analysis-section">';
            html += '<h5> </h5>';
            html += '<p>' + analysis.summary + '</p>';
            html += '</div>';
        }
        
        if (analysis.financial_analysis) {
            html += '<div class="analysis-section">';
            html += '<h5>繫 м</h5>';
            html += '<p>' + analysis.financial_analysis + '</p>';
            html += '</div>';
        }
        
        if (analysis.risk_assessment) {
            html += '<div class="analysis-section">';
            html += '<h5> </h5>';
            html += '<p>' + analysis.risk_assessment + '</p>';
            html += '</div>';
        }
        
        if (analysis.recommendations) {
            html += '<div class="analysis-section">';
            html += '<h5> õ</h5>';
            html += '<p>' + analysis.recommendations + '</p>';
            html += '</div>';
        }
        
        html += '</div>';
        resultsContainer.innerHTML = html;
    }

    // ǥ ̸  
    function enableRepresentativeEdit() {
        const nameText = document.getElementById('representative-name-text');
        const nameInput = document.getElementById('representative-name-input');
        const editBtn = document.getElementById('representative-edit-btn');
        const saveBtn = document.getElementById('representative-save-btn');
        const cancelBtn = document.getElementById('representative-cancel-btn');
        
        //  ̸ ŷ   Է ʵ忡 
        const currentName = nameText.textContent.trim();
        nameInput.value = currentName.replace(/\*/g, '');
        
        nameText.style.display = 'none';
        editBtn.style.display = 'none';
        nameInput.style.display = 'inline-block';
        saveBtn.style.display = 'inline-block';
        cancelBtn.style.display = 'inline-block';
        nameInput.focus();
    }

    function cancelRepresentativeEdit() {
        const nameText = document.getElementById('representative-name-text');
        const nameInput = document.getElementById('representative-name-input');
        const editBtn = document.getElementById('representative-edit-btn');
        const saveBtn = document.getElementById('representative-save-btn');
        const cancelBtn = document.getElementById('representative-cancel-btn');
        
        nameText.style.display = 'inline';
        editBtn.style.display = 'inline-block';
        nameInput.style.display = 'none';
        saveBtn.style.display = 'none';
        cancelBtn.style.display = 'none';
    }

    async function saveRepresentativeName() {
        const nameInput = document.getElementById('representative-name-input');
        const newName = nameInput.value.trim();
        const bizNo = '{{ company.basic.biz_no }}';
        
        if (!newName) {
            alert('̸ Էּ.');
            return;
        }
        
        if (!confirm('ǥ ̸ "' + newName + '" Ͻðڽϱ?')) {
            return;
        }
        
        try {
            const response = await fetch('/api/update_representative_name', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ biz_no: bizNo, new_name: newName })
            });
            
            const result = await response.json();
            if (result.success) {
                alert('ǥ ̸ Ǿϴ.');
                location.reload();
            } else {
                alert(' : ' + (result.message || '   '));
            }
        } catch (error) {
            console.error('ǥ ̸  :', error);
            alert('   ߻߽ϴ.');
        }
    }

    // ǥ   
    async function deleteRepresentative(bizNo, repName, rowIndex) {
        if (!confirm('ǥ "' + repName + '"  Ͻðڽϱ?\n\n  ۾ ǵ  ϴ.')) {
            return;
        }
        
        try {
            const response = await fetch('/api/delete_representative', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ biz_no: bizNo, name: repName })
            });
            
            const result = await response.json();
            if (result.success) {
                alert('ǥ  Ǿϴ.');
                document.getElementById('rep-row-' + rowIndex).remove();
            } else {
                alert(' : ' + (result.message || '   '));
            }
        } catch (error) {
            console.error('ǥ  :', error);
            alert('   ߻߽ϴ.');
        }
    }

    //    
    async function deleteShareholder(bizNo, shareholderName, rowIndex) {
        if (!confirm(' "' + shareholderName + '"  Ͻðڽϱ?\n\n  ۾ ǵ  ϴ.')) {
            return;
        }
        
        try {
            const response = await fetch('/api/delete_shareholder', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ biz_no: bizNo, shareholder_name: shareholderName })
            });
            
            const result = await response.json();
            if (result.success) {
                alert('  Ǿϴ.');
                document.getElementById('shareholder-row-' + rowIndex).remove();
            } else {
                alert(' : ' + (result.message || '   '));
            }
        } catch (error) {
            console.error('  :', error);
            alert('   ߻߽ϴ.');
        }
    }
    </script>
    
    <!-- Chart.js ̺귯 -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    <script>
    // 繫 Ʈ ʱȭ
    document.addEventListener('DOMContentLoaded', function() {
        const ctx = document.getElementById('financialChart');
        if (!ctx) return;
        
        // 繫   (Jinja2 )
        const financialData = [
            {% for fin in company.financials %}
            {
                year: {{ fin.fiscal_year }},
                sales: {{ fin.sales_revenue / 1000 if fin.sales_revenue else 0 }},
                profit: {{ fin.operating_income / 1000 if fin.operating_income else 0 }}
            }{% if not loop.last %},{% endif %}
            {% endfor %}
        ].reverse();
        
        if (financialData.length === 0) return;
        
        const years = financialData.map(d => d.year + '');
        const sales = financialData.map(d => d.sales);
        const profits = financialData.map(d => d.profit);
        
        new Chart(ctx, {
            type: 'bar',
            data: {
                labels: years,
                datasets: [
                    {
                        label: '',
                        data: sales,
                        backgroundColor: 'rgba(74, 159, 217, 0.7)',
                        borderColor: 'rgba(74, 159, 217, 1)',
                        borderWidth: 1
                    },
                    {
                        label: '',
                        data: profits,
                        backgroundColor: 'rgba(40, 167, 69, 0.7)',
                        borderColor: 'rgba(40, 167, 69, 1)',
                        borderWidth: 1
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return context.dataset.label + ': ' + context.raw.toLocaleString() + 'õ';
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return value.toLocaleString();
                            }
                        }
                    }
                }
            }
        });
    });
    
    
    function displayEnhancedResults(data, analysis, container) {
        var proposals = [];
        if (data.shareholders && data.shareholders.length > 0 && data.shareholders[0].ownership_percent > 50) {
            proposals.push({title: 'Succession Planning', reason: 'Major shareholder: ' + data.shareholders[0].ownership_percent.toFixed(1) + '%'});
        }
        if (data.financials && data.financials.length > 0) {
            var latest = data.financials[0];
            if (latest.sales_revenue > 10000000000) {
                proposals.push({title: 'Cash Management', reason: 'Revenue: ' + (latest.sales_revenue/100000000).toFixed(0) + 'B'});
            }
            if (latest.retained_earnings > 1000000000) {
                proposals.push({title: 'Asset Management', reason: 'Retained Earnings: ' + (latest.retained_earnings/100000000).toFixed(0) + 'B'});
            }
        }
        if (proposals.length === 0) {
            proposals.push({title: 'Company Analysis Report', reason: 'Initial meeting material'});
        }
        
        var proposalHtml = proposals.map(function(p) {
            return '<div style="display:flex;align-items:center;gap:12px;padding:12px;background:#fff;border-radius:8px">' +
                '<div><div style="font-weight:600">' + p.title + '</div><div style="font-size:12px;color:#666">' + p.reason + '</div></div></div>';
        }).join('');
        
        var chartsHtml = '';
        if ((data.shareholders && data.shareholders.length > 0) || (data.financials && data.financials.length > 0)) {
            chartsHtml = '<div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;margin:20px 0">' +
                '<div style="background:#fff;padding:20px;border-radius:12px;box-shadow:0 2px 8px rgba(0,0,0,0.05)"><h4 style="color:#2c5aa0;margin:0 0 15px">Shareholders</h4><canvas id="shareholderChart" style="max-height:250px"></canvas></div>' +
                '<div style="background:#fff;padding:20px;border-radius:12px;box-shadow:0 2px 8px rgba(0,0,0,0.05)"><h4 style="color:#2c5aa0;margin:0 0 15px">Financials</h4><canvas id="financialChart" style="max-height:250px"></canvas></div></div>';
        }
        
        container.innerHTML = chartsHtml +
            '<div style="background:linear-gradient(135deg,#e8f5e9,#f1f8e9);padding:20px;border-radius:12px;border:2px solid #4caf50;margin-bottom:20px">' +
            '<h4 style="color:#2e7d32;margin:0 0 15px">Recommended Services</h4><div style="display:grid;gap:10px">' + proposalHtml + '</div></div>' +
            '<div style="display:grid;gap:15px">' +
            '<div style="background:#f8f9fa;padding:20px;border-radius:10px;border-left:4px solid #2c5aa0"><h4 style="color:#2c5aa0;margin:0 0 10px">Company Overview</h4><p style="line-height:1.8;margin:0">' + (analysis.summary || 'No data') + '</p></div>' +
            '<div style="background:#f8f9fa;padding:20px;border-radius:10px;border-left:4px solid #28a745"><h4 style="color:#28a745;margin:0 0 10px">Financial Analysis</h4><p style="line-height:1.8;margin:0">' + (analysis.financial_analysis || 'No data') + '</p></div>' +
            '<div style="background:#f8f9fa;padding:20px;border-radius:10px;border-left:4px solid #ffc107"><h4 style="color:#e6a800;margin:0 0 10px">Risk Assessment</h4><p style="line-height:1.8;margin:0">' + (analysis.risk_assessment || 'No data') + '</p></div>' +
            '<div style="background:#f8f9fa;padding:20px;border-radius:10px;border-left:4px solid #6f42c1"><h4 style="color:#6f42c1;margin:0 0 10px">Recommendations</h4><p style="line-height:1.8;margin:0">' + (analysis.recommendations || 'No data') + '</p></div></div>' +
            '<div style="text-align:center;margin-top:20px"><button onclick="startAIAnalysis()" style="padding:10px 25px;background:#6c757d;color:white;border:none;border-radius:5px;cursor:pointer">Analyze Again</button></div>';
        
        if (typeof Chart !== 'undefined') {
            setTimeout(function() {
                if (data.shareholders && data.shareholders.length > 0) {
                    var ctx1 = document.getElementById('shareholderChart');
                    if (ctx1) {
                        var top5 = data.shareholders.slice(0, 5);
                        new Chart(ctx1, {
                            type: 'doughnut',
                            data: {labels: top5.map(function(s){return s.name.substring(0,8);}), datasets: [{data: top5.map(function(s){return s.ownership_percent;}), backgroundColor: ['#2c5aa0','#4a9fd9','#28a745','#ffc107','#dc3545']}]},
                            options: {responsive: true, plugins: {legend: {position: 'right'}}}
                        });
                    }
                }
                if (data.financials && data.financials.length > 0) {
                    var ctx2 = document.getElementById('financialChart');
                    if (ctx2) {
                        var sorted = data.financials.slice().reverse();
                        new Chart(ctx2, {
                            type: 'bar',
                            data: {labels: sorted.map(function(f){return f.year + '';}), datasets: [{label: 'Revenue', data: sorted.map(function(f){return f.sales_revenue/100000000;}), backgroundColor: 'rgba(44,90,160,0.7)'}, {label: 'Op.Income', data: sorted.map(function(f){return f.operating_income/100000000;}), backgroundColor: 'rgba(40,167,69,0.7)'}]},
                            options: {responsive: true, scales: {y: {beginAtZero: true}}}
                        });
                    }
                }
            }, 200);
        }
    }
</script>
</body>
</html>