<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <title>ê¸°ì—… ì •ë³´ ì¡°íšŒ (ych_m010)</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <style>
        body {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 50%, #dee2e6 100%);
            min-height: 100vh;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .container {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            border: 1px solid rgba(0, 0, 0, 0.1);
            margin: 20px auto;
            padding: 30px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            max-width: 1400px;
            width: 95%;
        }

        header {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(5px);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 25px;
            border: 1px solid rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        h1 {
            color: #4a90e2;
            font-size: 28px;
            font-weight: 600;
            margin: 0;
        }

        .header-subtext {
            font-size: 16px;
            font-weight: normal;
            opacity: 0.9;
        }

        .back-button,
        .logout-button-new {
            background: rgba(108, 117, 125, 0.8);
            color: white;
            text-decoration: none;
            padding: 8px 16px;
            border-radius: 15px;
            border: 1px solid rgba(108, 117, 125, 0.3);
            backdrop-filter: blur(5px);
            transition: all 0.3s ease;
            font-weight: 500;
        }

        .back-button:hover,
        .logout-button-new:hover {
            background: rgba(108, 117, 125, 1);
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }

        .subscription-badge {
            font-size: 12px;
            padding: 4px 8px;
            border-radius: 12px;
            margin-left: 8px;
            backdrop-filter: blur(5px);
            border: 1px solid rgba(0, 0, 0, 0.1);
        }

        .main-actions {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(5px);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 25px;
            border: 1px solid rgba(0, 0, 0, 0.1);
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        .action-button {
            background: linear-gradient(45deg, #4CAF50, #45a049);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 25px;
            cursor: pointer;
            font-weight: 500;
            font-size: 14px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(76, 175, 80, 0.3);
        }

        .action-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(76, 175, 80, 0.4);
        }

        .reset-button {
            background: linear-gradient(45deg, #ff9800, #f57c00);
            box-shadow: 0 4px 15px rgba(255, 152, 0, 0.3);
        }

        .excel-button {
            background: linear-gradient(45deg, #2196f3, #1976d2);
            box-shadow: 0 4px 15px rgba(33, 150, 243, 0.3);
        }

        .search-container {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(5px);
            border-radius: 10px;
            padding: 25px;
            margin-bottom: 25px;
            border: 1px solid rgba(0, 0, 0, 0.1);
        }

        .search-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
        }

        .search-grid input,
        .search-grid select {
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 12px 16px;
            font-size: 14px;
            transition: all 0.3s ease;
            color: #333;
        }

        .search-grid input:focus,
        .search-grid select:focus {
            outline: none;
            border-color: #007bff;
            box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.1);
        }

        .range-input {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .range-input input {
            flex: 1;
        }

        .range-input span {
            color: #333;
            font-weight: 500;
        }

        .results-container {
            background: white;
            border-radius: 10px;
            overflow: hidden;
            border: 1px solid #ddd;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            margin-bottom: 25px;
        }

        .results-table {
            width: 100%;
            border-collapse: collapse;
        }

        .results-table thead {
            background: linear-gradient(45deg, #b3d9ff, #87ceeb);
            color: #000;
        }

        .results-table th {
            padding: 15px;
            text-align: left;
            font-weight: 600;
            font-size: 14px;
            color: #000;
        }

        .results-table tbody tr:nth-child(even) {
            background: #e3f2fd;
        }

        .results-table tbody tr:nth-child(odd) {
            background: #f0f8ff;
        }

        .results-table tbody tr:hover {
            background: #bbdefb;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .results-table td {
            padding: 12px 15px;
            border-bottom: 1px solid #eee;
            font-size: 14px;
            color: #000;
        }

        .text-center {
            text-align: center;
        }

        .text-right {
            text-align: right;
        }

        .loading {
            text-align: center;
            font-style: italic;
            color: #666;
        }

        .footer-actions {
            display: flex;
            justify-content: center;
            margin: 20px 0;
        }

        #load-next-btn {
            background: linear-gradient(45deg, #9c27b0, #673ab7);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 25px;
            cursor: pointer;
            font-weight: 500;
            font-size: 16px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(156, 39, 176, 0.3);
        }

        #load-next-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(156, 39, 176, 0.4);
        }

        .scroll-buttons {
            position: fixed;
            right: 30px;
            bottom: 30px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .scroll-buttons button {
            background: rgba(108, 117, 125, 0.8);
            color: white;
            border: none;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 18px;
            backdrop-filter: blur(5px);
            border: 1px solid rgba(108, 117, 125, 0.3);
            transition: all 0.3s ease;
        }

        .scroll-buttons button:hover {
            background: rgba(108, 117, 125, 1);
            transform: translateY(-2px);
        }

        @media (max-width: 768px) {
            .container {
                margin: 10px;
                padding: 20px;
            }

            header {
                flex-direction: column;
                gap: 15px;
                text-align: center;
            }

            .main-actions {
                justify-content: center;
            }

            .scroll-buttons {
                right: 15px;
                bottom: 15px;
            }

            .results-table {
                font-size: 12px;
            }

            .results-table th,
            .results-table td {
                padding: 8px;
            }
        }

        /* fixed brace */

        /* Corporate Modal Styles */
        .corp-modal {
            display: none;
            position: fixed;
            z-index: 9999 !important;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.4);
            /* backdrop-filter removed for stability */
        }

        .corp-modal-content {
            background-color: #fefefe;
            margin: 5% auto;
            padding: 25px;
            border: 1px solid #888;
            width: 90%;
            max-width: 1000px;
            /* Widened for detailed stats */
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }

        .corp-modal-header {
            border-bottom: 1px solid #eee;
            margin-bottom: 20px;
            padding-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .corp-modal-title {
            color: #333;
            margin: 0;
            font-size: 22px;
        }

        .corp-close-btn {
            color: #aaa;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            transition: color 0.3s;
        }

        .corp-close-btn:hover {
            color: #000;
        }

        .corp-step {
            margin-bottom: 30px;
        }

        .corp-step-title {
            font-size: 16px;
            color: #555;
            margin-bottom: 10px;
        }

        .corp-step-desc {
            font-size: 14px;
            color: #777;
            margin-bottom: 10px;
        }

        .corp-btn-template {
            padding: 8px 16px;
            font-size: 13px;
            background: #607d8b;
        }

        .corp-upload-container {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .corp-file-input {
            border: 1px solid #ddd;
            padding: 8px;
            border-radius: 5px;
            flex-grow: 1;
        }

        .corp-btn-validate {
            padding: 10px 20px;
            background: #2196F3;
        }

        .corp-loading {
            display: none;
            text-align: center;
            padding: 15px;
            color: #2196F3;
        }

        .corp-validation-results {
            display: none;
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            border: 1px solid #e9ecef;
        }

        .corp-validation-title {
            margin-top: 0;
            color: #333;
            border-bottom: 1px solid #ddd;
            padding-bottom: 5px;
        }

        .corp-stats {
            font-size: 14px;
            line-height: 1.6;
            color: #555;
            overflow-x: auto;
        }

        /* New Table Styles for Stats */
        .corp-stats-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
            font-size: 13px;
        }

        .corp-stats-table th,
        .corp-stats-table td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: center;
        }

        .corp-stats-table th {
            background-color: #e9ecef;
            color: #333;
        }

        .corp-stats-table td.text-left {
            text-align: left;
        }

        .corp-stats-table .stat-found {
            color: #007bff;
            font-weight: bold;
        }

        .corp-stats-table .stat-insert {
            color: #28a745;
            font-weight: bold;
        }

        .corp-stats-table .stat-update {
            color: #ffc107;
            font-weight: bold;
        }

        .corp-stats-table .stat-error {
            color: #dc3545;
            font-weight: bold;
        }

        .corp-success-msg {
            margin-top: 15px;
            color: #28a745;
            font-weight: bold;
            font-size: 14px;
        }

        .corp-execution-section {
            display: none;
            border-top: 1px dashed #ccc;
            padding-top: 20px;
            margin-top: 20px;
        }

        .corp-password-input {
            padding: 10px 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            width: 200px;
        }

        .corp-btn-execute {
            background: #f44336;
            padding: 10px 24px;
        }

        .corp-btn-execute:disabled {
            background: #cccccc;
            cursor: not-allowed;
            opacity: 0.7;
        }

        .corp-execution-loading {
            display: none;
            margin-top: 10px;
            color: #f44336;
        }

        .corp-status-log {
            margin-top: 20px;
            white-space: pre-wrap;
            font-size: 13px;
            color: #666;
            max-height: 100px;
            overflow-y: auto;
            background: #eee;
            padding: 10px;
            border-radius: 5px;
            display: none;
        }

        /* New File Upload Area Styles */
        .file-upload-area {
            border: 2px dashed #dcdde1;
            padding: 2rem;
            text-align: center;
            border-radius: 8px;
            margin-bottom: 1rem;
            background: #fafafa;
            transition: all 0.3s;
            cursor: pointer;
            position: relative;
        }

        .file-upload-area:hover {
            border-color: #4a90e2;
            background: #f0f7ff;
        }

        .folder-icon {
            font-size: 48px;
            color: #f1c40f;
            /* Yellow folder color */
            margin-bottom: 10px;
        }

        .corp-file-input-hidden {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            opacity: 0;
            cursor: pointer;
        }
    </style>
    <script src="{{ url_for('static', filename='js/auto-logout.js') }}"></script>
</head>

<body>
    <div class="container">
        <header>
            <h1>ê¸°ì—… ì •ë³´ ì¡°íšŒ (ych_m010) <span id="results-count" class="header-subtext"></span></h1>
            <div style="display:flex; align-items:center; justify-content:flex-end; gap:10px; flex-wrap: wrap;">
                <a href="{{ url_for('history_search') }}" class="back-button">ì ‘ì´‰ì´ë ¥ ì¡°íšŒ</a>
                <a href="{{ url_for('main') }}" class="back-button">ë©”ì¸ìœ¼ë¡œ</a>
                <span style="font-weight:bold; color:#333;">{{ user_name }}ë‹˜</span>
                {% if subscription_info %}
                {% if subscription_info.days_remaining > 0 %}
                <span class="subscription-badge" style="color:#28a745; background:rgba(40, 167, 69, 0.2);">
                    {% if subscription_info.subscription_type == 'ANNUAL' %}
                    ì—°ê°„ êµ¬ë… ({{ subscription_info.days_remaining }}ì¼ ë‚¨ìŒ)
                    {% elif subscription_info.subscription_type == 'MONTHLY' %}
                    ì›”ê°„ êµ¬ë… ({{ subscription_info.days_remaining }}ì¼ ë‚¨ìŒ)
                    {% else %}
                    ë¬´ë£Œ êµ¬ë… ({{ subscription_info.days_remaining }}ì¼ ë‚¨ìŒ)
                    {% endif %}
                </span>
                {% elif subscription_info.days_remaining == 0 %}
                <span class="subscription-badge" style="color:#dc3545; background:rgba(220, 53, 69, 0.2);">
                    ì˜¤ëŠ˜ ë§Œë£Œ
                </span>
                {% else %}
                <span class="subscription-badge" style="color:#dc3545; background:rgba(220, 53, 69, 0.2);">
                    êµ¬ë… ë§Œë£Œ ({{ subscription_info.days_remaining|abs }}ì¼ ì§€ë‚¨)
                </span>
                {% endif %}
                {% else %}
                <span class="subscription-badge" style="color:#007bff; background:rgba(0, 123, 255, 0.2);">
                    ì²«ë‹¬ ë¬´ë£Œ ì²´í—˜
                </span>
                {% endif %}
                <a href="{{ url_for('logout') }}" class="logout-button-new">ë¡œê·¸ì•„ì›ƒ</a>
            </div>
        </header>

        <div class="main-actions">

            {% if session.get('user_id') in ['ct0001','ct0002'] %}
            <button type="button" id="excel-download-button" class="action-button excel-button">ì—‘ì…€ì €ì¥</button>
            {% else %}
            <button type="button" class="action-button excel-button" disabled
                style="opacity:0.45;cursor:not-allowed;">ì—‘ì…€ì €ì¥</button>
            {% endif %}
            {% if session.get('user_id') in ['ct0001','ct0002'] %}
            <button type="button" id="corp-upload-btn" class="action-button"
                style="background: linear-gradient(45deg, #9c27b0, #673ab7); box-shadow: 0 4px 15px rgba(156, 39, 176, 0.3);">ë°ì´í„°
                ì¼ê´„ ì¶”ê°€</button>
            {% endif %}
            <button type="reset" id="reset-button" form="search-form" class="action-button reset-button">ì´ˆê¸°í™”</button>
            <button type="button" id="search-button" class="action-button search-button">ê²€ìƒ‰</button>
        </div>

        <div class="search-container">
            <form id="search-form" class="search-grid" onsubmit="return false;">
                <input type="text" name="company_name" placeholder="ê¸°ì—…ëª…">
                <input type="text" name="biz_no" placeholder="ì‚¬ì—…ìë²ˆí˜¸">
                <input type="text" name="industry_name" placeholder="ì—…ì¢…ëª…">
                <select name="company_size">
                    <option value="ì „ì²´">ê¸°ì—…ê·œëª¨ (ì „ì²´)</option>
                    <option value="ëŒ€ê¸°ì—…">ëŒ€ê¸°ì—…</option>
                    <option value="ì¤‘ê²¬ê¸°ì—…">ì¤‘ê²¬ê¸°ì—…</option>
                    <option value="ì¤‘ì†Œê¸°ì—…">ì¤‘ì†Œê¸°ì—…</option>
                    <option value="ì†Œê¸°ì—…">ì†Œê¸°ì—…</option>
                    <option value="í•œì‹œì¤‘ì†Œê¸°ì—…">í•œì‹œì¤‘ì†Œê¸°ì—…</option>
                    <option value="ê¸°íƒ€">ê¸°íƒ€</option>
                </select>
                <input type="text" name="region" placeholder="ì§€ì—­ (ì˜ˆ: ì„œìš¸ ê°•ë‚¨)">
                <div class="range-input">
                    <input type="number" name="ret_min" placeholder="ì´ìµì‰ì—¬ê¸ˆ Min (ë°±ë§Œ)">
                    <span>~</span>
                    <input type="number" name="ret_max" placeholder="ì´ìµì‰ì—¬ê¸ˆ Max (ë°±ë§Œ)">
                </div>
            </form>
        </div>

        <div class="results-container">
            <table class="results-table">
                <thead>
                    <tr>
                        <th style="width: 5%;">ìˆœë²ˆ</th>
                        <th>ì‚¬ì—…ìë²ˆí˜¸</th>
                        <th>ê¸°ì—…ëª…</th>
                        <th>ëŒ€í‘œìëª…</th>
                        <th>ì—…ì¢…</th>
                        <th style="width: 25%;">ì£¼ì†Œ</th>
                        <th>ìµœì‹ ë…„ë„</th>
                        <th>ìì‚°ì´ê³„(ë°±ë§Œ)</th>
                        <th>ë§¤ì¶œì•¡(ë°±ë§Œ)</th>
                        <th>ì´ìµì‰ì—¬ê¸ˆ(ë°±ë§Œ)</th>
                    </tr>
                </thead>
                <tbody id="company-list">
                </tbody>
            </table>
        </div>

        <div class="footer-actions">
            <button id="load-next-btn" style="display:none;">ë‹¤ìŒ</button>
        </div>
    </div>

    <div class="scroll-buttons">
        <button id="scroll-top">â–²</button>
        <button id="scroll-bottom">â–¼</button>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const companyList = document.getElementById('company-list');
            const searchButton = document.getElementById('search-button');
            const searchForm = document.getElementById('search-form');
            const resultsCountSpan = document.getElementById('results-count');
            const resetButton = document.getElementById('reset-button');
            const excelButton = document.getElementById('excel-download-button');
            const loadNextBtn = document.getElementById('load-next-btn');

            let currentPage = 1;
            let isFetching = false;

            function fetchCompanies(page = 1) {
                if (isFetching) return;
                isFetching = true;

                // 'ë‹¤ìŒ' ë²„íŠ¼ í´ë¦­ ì‹œì—ëŠ” ê¸°ì¡´ ëª©ë¡ì„ ìœ ì§€í•˜ê³  ë¡œë”© í‘œì‹œë¥¼ í•˜ì§€ ì•ŠìŒ
                if (page === 1) {
                    companyList.innerHTML = '<tr><td colspan="10" class="loading">ê²€ìƒ‰ ì¤‘...</td></tr>';
                }

                const formData = new FormData(searchForm);
                const params = new URLSearchParams(formData);
                params.set('page', page);

                fetch(`/api/companies?${params.toString()}`)
                    .then(response => response.json())
                    .then(data => {
                        if (page === 1) {
                            companyList.innerHTML = ''; // ìƒˆ ê²€ìƒ‰ ì‹œ ê¸°ì¡´ ëª©ë¡ ì´ˆê¸°í™”
                        }
                        resultsCountSpan.textContent = `ì¡°íšŒê±´ìˆ˜ : ${data.totalRows.toLocaleString()}ê±´`;

                        if (data.companies.length === 0 && page === 1) {
                            companyList.innerHTML = '<tr><td colspan="10">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
                            loadNextBtn.style.display = 'none';
                            return;
                        }

                        const baseIndex = data.offset || (page - 1) * 50;
                        data.companies.forEach((company, index) => {
                            const row = document.createElement('tr');
                            const rowNum = baseIndex + index + 1;

                            // ë°±ë§Œ ë‹¨ìœ„ë¡œ ë³€í™˜í•˜ëŠ” í•¨ìˆ˜
                            const formatToMillion = (value) => {
                                if (value === null || value === undefined) return '';
                                return Math.round(value / 1000000).toLocaleString();
                            };

                            row.innerHTML = `
                            <td class="text-center">${rowNum}</td>
                            <td class="text-center" data-biz-no="${company.biz_no}">${company.biz_no}</td>
                            <td data-biz-no="${company.biz_no}">${company.company_name}</td>
                            <td class="text-center">${company.representative_name || ''}</td>
                            <td>${company.industry_name || ''}</td>
                            <td>${company.address || ''}</td>
                            <td class="text-center">${company.fiscal_year || ''}</td>
                            <td class="text-right">${formatToMillion(company.total_assets)}</td>
                            <td class="text-right">${formatToMillion(company.sales_revenue)}</td>
                            <td class="text-right">${formatToMillion(company.retained_earnings)}</td>
                        `;

                            // í–‰ í´ë¦­ ì´ë²¤íŠ¸ ì¶”ê°€ - ê¸°ì—… ìƒì„¸ ì¡°íšŒ í˜ì´ì§€ë¡œ ì´ë™
                            row.style.cursor = 'pointer';
                            row.title = 'í´ë¦­í•˜ë©´ ìƒì„¸ ì •ë³´ë¥¼ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤';
                            row.addEventListener('click', (e) => {
                                e.preventDefault();
                                e.stopPropagation();

                                // ì‚¬ì—…ìë²ˆí˜¸ì—ì„œ í•˜ì´í”ˆ ì œê±°í•˜ì—¬ ì •í™•í•œ ë¼ìš°íŒ… ë³´ì¥
                                const cleanBizNo = company.biz_no.replace(/-/g, '');
                                const detailUrl = `/company_detail/${cleanBizNo}?source=main`;

                                console.log('ê¸°ì—… í´ë¦­:', company.company_name, 'ì‚¬ì—…ìë²ˆí˜¸:', cleanBizNo, 'URL:', detailUrl);

                                // ê°™ì€ ì°½ì—ì„œ ìƒì„¸ì¡°íšŒ í˜ì´ì§€ ì—´ê¸° (íŒì—… ì°¨ë‹¨ ë°©ì§€)
                                window.location.href = detailUrl;
                            });

                            companyList.appendChild(row);
                        });

                        if (data.hasNextPage) {
                            loadNextBtn.style.display = 'block';
                            currentPage = page + 1;
                        } else {
                            loadNextBtn.style.display = 'none';
                        }
                    })
                    .catch(error => {
                        console.error('Failed to fetch companies:', error);
                        companyList.innerHTML = '<tr><td colspan="11">ë°ì´í„° ì¡°íšŒ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</td></tr>';
                    })
                    .finally(() => {
                        isFetching = false;
                    });
            }

            searchButton.addEventListener('click', () => {
                currentPage = 1; // ê²€ìƒ‰ ë²„íŠ¼ í´ë¦­ ì‹œ í•­ìƒ 1í˜ì´ì§€ë¶€í„°
                fetchCompanies(currentPage);
            });

            loadNextBtn.addEventListener('click', () => {
                fetchCompanies(currentPage);
            });

            searchForm.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    searchButton.click();
                }
            });

            resetButton.addEventListener('click', () => {
                searchForm.reset();
                fetchCompanies(1);
            });

            if (excelButton) {
                excelButton.addEventListener('click', () => {
                    const formData = new FormData(searchForm);
                    const params = new URLSearchParams(formData);
                    window.location.href = `/export_excel?${params.toString()}`;
                });
            }

            const scrollTopBtn = document.getElementById('scroll-top');
            const scrollBottomBtn = document.getElementById('scroll-bottom');
            scrollTopBtn.addEventListener('click', () => window.scrollTo({ top: 0, behavior: 'smooth' }));
            scrollBottomBtn.addEventListener('click', () => window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' }));

            fetchCompanies(1);
        });


    </script>


    <!-- Additional Styles & Keyframes -->
    <style>
        @keyframes spin {
            100% {
                transform: rotate(360deg);
            }
        }

        .close-corp-modal:hover {
            color: #333;
        }

        .modal {
            animation: fadeIn 0.3s;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }
    </style>

    <script>
        // --- Corporate Batch Upload Logic (Data Add Style) ---
        document.addEventListener('DOMContentLoaded', function () {
            const modal = document.getElementById('corpUploadModal');
            const openBtn = document.getElementById('corp-upload-btn');
            const closeSpan = document.querySelector('.close-corp-modal');
            const closeBtn = document.getElementById('closeModalBtn');
            const dropZone = document.getElementById('dropZone');
            const fileInput = document.getElementById('corpFileUpload');
            const fileNameDisplay = document.getElementById('selectedFileName');

            // Open Modal - Alert: Fixed Stability
            if (openBtn) {
                openBtn.onclick = function (e) {
                    e.preventDefault();
                    e.stopPropagation();
                    console.log("Opening Modal");
                    modal.style.display = "block";
                    resetModalState();
                }
            }

            // Close Modal Logic
            function closeModal() {
                modal.style.display = "none";
            }
            if (closeSpan) closeSpan.onclick = closeModal;
            if (closeBtn) closeBtn.onclick = closeModal;

            // Close on background click (Safe Mode)
            window.addEventListener('click', function (event) {
                if (event.target == modal) {
                    closeModal();
                }
            });

            // Reset Modal
            function resetModalState() {
                fileInput.value = '';
                fileNameDisplay.textContent = '';
                fileNameDisplay.style.display = 'none';

                document.getElementById('validationResult').style.display = 'none';
                document.getElementById('executionSection').style.display = 'none';
                document.getElementById('uploadStatus').style.display = 'none';
                document.getElementById('uploadStatus').textContent = '';
                document.getElementById('corpUploadPassword').value = '';
                document.getElementById('validationLoading').style.display = 'none';

                const execBtn = document.getElementById('executeUploadBtn');
                execBtn.style.display = 'none'; // Hide execute button initially
                execBtn.disabled = false;
                execBtn.textContent = 'ì—…ë¡œë“œ ë° ì‹¤í–‰';
                execBtn.style.opacity = '1';
                execBtn.style.cursor = 'pointer';

                const dropP = dropZone.querySelector('p');
                if (dropP) dropP.style.display = 'block';
            }

            // File Drop & Select Logic
            dropZone.addEventListener('dragover', (e) => {
                e.preventDefault();
                dropZone.style.borderColor = '#4a90e2';
                dropZone.style.background = '#f0f7ff';
            });

            dropZone.addEventListener('dragleave', (e) => {
                e.preventDefault();
                dropZone.style.borderColor = '#dcdde1';
                dropZone.style.background = '#fafafa';
            });

            dropZone.addEventListener('drop', (e) => {
                e.preventDefault();
                dropZone.style.borderColor = '#dcdde1';
                dropZone.style.background = '#fafafa';

                if (e.dataTransfer.files.length > 0) {
                    fileInput.files = e.dataTransfer.files;
                    handleFileSelect(fileInput.files[0]);
                }
            });

            fileInput.addEventListener('change', function () {
                if (this.files.length > 0) {
                    handleFileSelect(this.files[0]);
                }
            });

            function handleFileSelect(file) {
                fileNameDisplay.textContent = "ğŸ“„ ì„ íƒëœ íŒŒì¼: " + file.name;
                fileNameDisplay.style.display = 'block';

                // Hide instruction text slightly
                const dropP = dropZone.querySelector('p');
                if (dropP) dropP.style.display = 'none';

                // Reset UI for new validation
                document.getElementById('validationResult').style.display = 'none';
                document.getElementById('executionSection').style.display = 'none';
                document.getElementById('uploadStatus').style.display = 'none';

                const execBtn = document.getElementById('executeUploadBtn');
                execBtn.style.display = 'none';
                execBtn.disabled = false;
                execBtn.textContent = 'ì—…ë¡œë“œ ë° ì‹¤í–‰';
            }

            // Helper: Render Detailed Stats Table
            function renderStatsTable(stats) {
                const tables = ['Company_Basic', 'Company_Financial', 'Company_Additional', 'Company_Representative', 'Company_Shareholder'];
                let html = `
                <table class="corp-stats-table" style="width:100%;">
                    <thead>
                        <tr>
                            <th>í…Œì´ë¸”ëª…</th>
                            <th>ë°œê²¬</th>
                            <th>ì¶”ê°€</th>
                            <th>ìˆ˜ì •</th>
                            <th>ì‹¤íŒ¨</th>
                        </tr>
                    </thead>
                    <tbody>`;

                let totalFound = 0, totalInsert = 0, totalUpdate = 0, totalError = 0;

                tables.forEach(tbl => {
                    const found = stats[`${tbl}_Found`] || 0;
                    const ins = stats[`${tbl}_Inserted`] || 0;
                    const upd = stats[`${tbl}_Updated`] || 0;
                    const err = stats[`${tbl}_Error`] || 0;

                    totalFound += found;
                    totalInsert += ins;
                    totalUpdate += upd;
                    totalError += err;

                    html += `
                        <tr>
                            <td class="text-left" style="font-size:12px;">${tbl}</td>
                            <td>${found.toLocaleString()}</td>
                            <td class="stat-insert">${ins > 0 ? '+' : ''}${ins.toLocaleString()}</td>
                            <td class="stat-update">${upd.toLocaleString()}</td>
                            <td class="stat-error">${err.toLocaleString()}</td>
                        </tr>`;
                });

                html += `
                        <tr style="background:#f8f9fa; font-weight:bold;">
                            <td class="text-left">í•©ê³„ (Total)</td>
                            <td>${totalFound.toLocaleString()}</td>
                            <td>${totalInsert.toLocaleString()}</td>
                            <td>${totalUpdate.toLocaleString()}</td>
                            <td>${totalError.toLocaleString()}</td>
                        </tr>
                    </tbody>
                </table>`;
                return html;
            }

            // 1. Download Template
            document.getElementById('downloadTemplateBtn').onclick = function () {
                window.location.href = '/api/corporate/template';
            }

            // 2. Validate
            document.getElementById('validateUploadBtn').onclick = function () {
                const file = fileInput.files[0];
                if (!file) {
                    alert("íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.");
                    return;
                }

                const formData = new FormData();
                formData.append('company_file', file);

                const loading = document.getElementById('validationLoading');
                const statsDiv = document.getElementById('validationStats');
                const resultDiv = document.getElementById('validationResult');
                const execSection = document.getElementById('executionSection');
                const statusDiv = document.getElementById('uploadStatus');
                const execBtn = document.getElementById('executeUploadBtn');

                loading.style.display = 'block';
                resultDiv.style.display = 'none';
                execSection.style.display = 'none'; // Ensure execution section is hidden
                statusDiv.style.display = 'none';
                execBtn.style.display = 'none'; // Hide execute button

                fetch('/api/corporate/validate_upload', {
                    method: 'POST',
                    body: formData
                })
                    .then(res => res.json())
                    .then(data => {
                        loading.style.display = 'none';
                        if (data.success) {
                            statsDiv.innerHTML = renderStatsTable(data.stats || {});

                            // Check for LastError (Server-side processing error)
                            if (data.stats && data.stats.LastError) {
                                const errorMsg = data.stats.LastError;
                                statusDiv.innerHTML = `<div style="padding:10px; background:#fff3cd; color:#856404; border:1px solid #ffeeba; border-radius:4px; margin-top:10px; word-break:break-all;">âš ï¸ <strong>ì¼ë¶€ ë°ì´í„° ì²˜ë¦¬ ì¤‘ ì—ëŸ¬ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤:</strong><br>${errorMsg}</div>`;
                                statusDiv.style.display = 'block';
                            }

                            resultDiv.style.display = 'block';
                            execSection.style.display = 'block'; // Show password input section

                            // Show Execute Button now
                            execBtn.style.display = 'inline-block';
                            execBtn.disabled = false;
                            execBtn.textContent = 'ì—…ë¡œë“œ ë° ì‹¤í–‰';

                        } else {
                            alert("ê²€ì¦ ì‹¤íŒ¨: " + data.message);
                            statusDiv.style.display = 'block';
                            statusDiv.textContent = data.message;
                        }
                    })
                    .catch(err => {
                        loading.style.display = 'none';
                        alert("ì„œë²„ ì˜¤ë¥˜: " + err);
                    });
            }

            // 3. Execute with SSE Progress
            document.getElementById('executeUploadBtn').onclick = function () {
                const password = document.getElementById('corpUploadPassword').value;
                if (!password) {
                    alert("ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");
                    return;
                }

                const progressSection = document.getElementById('progressSection');
                const progressBar = document.getElementById('uploadProgressBar');
                const progressText = document.getElementById('progressText');
                const tableStatus = document.getElementById('tableStatus');
                const statusDiv = document.getElementById('uploadStatus');
                const statsDiv = document.getElementById('validationStats');
                const btn = this;

                if (confirm("ì •ë§ë¡œ DBì— ë°˜ì˜í•˜ì‹œê² ìŠµë‹ˆê¹Œ? (ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤)")) {
                    // Show progress UI
                    progressSection.style.display = 'block';
                    progressBar.style.width = '0%';
                    progressText.textContent = '0%';
                    tableStatus.innerHTML = '';
                    statusDiv.style.display = 'none';
                    btn.disabled = true;
                    btn.style.opacity = '0.7';
                    btn.style.cursor = 'not-allowed';

                    // Track progress across tables
                    const tableOrder = ['Company_Basic', 'Company_Representative', 'Company_Shareholder', 'Company_Financial', 'Company_Additional'];
                    let currentTableIndex = 0;
                    let tableProgress = {};
                    let finalStats = {};

                    // First, send password via POST then connect SSE
                    fetch('/api/corporate/execute_upload', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ password: password })
                    }).then(response => {
                        const reader = response.body.getReader();
                        const decoder = new TextDecoder();

                        function processStream() {
                            reader.read().then(({ value, done }) => {
                                if (done) return;

                                const text = decoder.decode(value);
                                const lines = text.split('\n');

                                lines.forEach(line => {
                                    if (line.startsWith('data: ')) {
                                        try {
                                            const data = JSON.parse(line.substring(6));

                                            if (data.type === 'table_start') {
                                                tableProgress[data.table] = { total: data.total, current: 0 };
                                                tableStatus.innerHTML += `<div id="status-${data.table}" style="margin:5px 0; font-size:13px;">
                                                    <span style="color:#f39c12;">â³</span> ${data.table}: 0 / ${data.total} ì²˜ë¦¬ì¤‘...
                                                </div>`;
                                            } else if (data.type === 'progress') {
                                                if (tableProgress[data.table]) {
                                                    tableProgress[data.table].current = data.current;
                                                    const statusEl = document.getElementById('status-' + data.table);
                                                    if (statusEl) {
                                                        statusEl.innerHTML = `<span style="color:#f39c12;">â³</span> ${data.table}: ${data.current} / ${data.total} ì²˜ë¦¬ì¤‘...`;
                                                    }
                                                    // Update overall progress
                                                    let totalDone = 0, totalAll = 0;
                                                    Object.values(tableProgress).forEach(t => {
                                                        totalDone += t.current;
                                                        totalAll += t.total;
                                                    });
                                                    const pct = totalAll > 0 ? Math.round((totalDone / totalAll) * 100) : 0;
                                                    progressBar.style.width = pct + '%';
                                                    progressText.textContent = pct + '%';
                                                }
                                            } else if (data.type === 'table_done') {
                                                const statusEl = document.getElementById('status-' + data.table);
                                                if (statusEl) {
                                                    const total = data.inserted + data.updated;
                                                    statusEl.innerHTML = `<span style="color:#2ecc71;">âœ…</span> ${data.table}: ${total}ê±´ ì™„ë£Œ (ì¶”ê°€: ${data.inserted}, ìˆ˜ì •: ${data.updated})`;
                                                }
                                            } else if (data.type === 'complete') {
                                                progressBar.style.width = '100%';
                                                progressText.textContent = '100%';
                                                statsDiv.innerHTML = renderStatsTable(data.stats || {});
                                                statusDiv.innerHTML = `<div style="padding:10px; background:#e8f5e9; color:#2e7d32; border-radius:4px; font-weight:bold;">âœ… [ì„±ê³µ] ëª¨ë“  ë°ì´í„° ì²˜ë¦¬ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.</div>`;
                                                statusDiv.style.display = 'block';
                                                btn.textContent = 'ë°˜ì˜ ì™„ë£Œ';
                                            } else if (data.type === 'error') {
                                                statusDiv.innerHTML = `<div style="padding:10px; background:#ffebee; color:#c62828; border-radius:4px; font-weight:bold;">âŒ ì˜¤ë¥˜: ${data.message}</div>`;
                                                statusDiv.style.display = 'block';
                                                btn.disabled = false;
                                                btn.style.opacity = '1';
                                                btn.style.cursor = 'pointer';
                                            }
                                        } catch (e) { }
                                    }
                                });

                                processStream();
                            });
                        }

                        processStream();
                    }).catch(err => {
                        statusDiv.innerHTML = `<div style="padding:10px; background:#ffebee; color:#c62828; border-radius:4px;">âŒ ì„œë²„ í†µì‹  ì˜¤ë¥˜: ${err}</div>`;
                        statusDiv.style.display = 'block';
                        btn.disabled = false;
                        btn.style.opacity = '1';
                        btn.style.cursor = 'pointer';
                    });
                }
            }
        });
    </script>
    <!-- Corporate Batch Upload Modal (Data Add Style) -->
    <div id="corpUploadModal" class="corp-modal">
        <div class="modal-content corp-modal-content" style="max-width: 700px; padding: 0; border-radius: 12px;">
            <div class="corp-modal-header"
                style="padding: 18px 24px; border-bottom: 2px solid #4a90e2; background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%); display: flex; justify-content: space-between; align-items: center; border-radius: 12px 12px 0 0;">
                <h2 class="corp-modal-title" style="margin:0; font-size: 20px; color: #2c3e50; font-weight: 600;">ë°ì´í„° ì¼ê´„
                    ì¶”ê°€ (ë²•ì¸)</h2>
                <span class="close-corp-modal corp-close-btn"
                    style="font-size: 24px; color: #999; cursor: pointer;">&times;</span>
            </div>

            <div style="padding: 24px;">
                <!-- Download Template (Right aligned) -->
                <div style="text-align: right; margin-bottom: 15px;">
                    <button type="button" id="downloadTemplateBtn" class="action-button corp-btn-template"
                        style="background: #95a5a6; display: inline-flex; align-items: center; gap: 5px;">
                        <span>ğŸ“¥</span> ë“±ë¡ ì–‘ì‹ ë‹¤ìš´ë¡œë“œ
                    </button>
                    <p style="font-size: 13px; color: #666; margin-top: 5px;">
                        ì—‘ì…€ íŒŒì¼(.xlsx)ì„ ì—…ë¡œë“œí•˜ë©´ ìë™ìœ¼ë¡œ DBì— ë°˜ì˜ë©ë‹ˆë‹¤.<br>
                        ê¸°ì¡´ ê¸°ì—…/ì£¼ì£¼ ì •ë³´ëŠ” ìŠ¤ë§ˆíŠ¸í•˜ê²Œ ë³‘í•©ë©ë‹ˆë‹¤.
                    </p>
                </div>

                <div id="uploadMainContent">
                    <!-- Drop Zone -->
                    <div class="file-upload-area" id="dropZone">
                        <div class="folder-icon">ğŸ“</div>
                        <p style="color: #666; margin: 10px 0; font-size: 15px; font-weight: 500;">
                            í´ë¦­í•˜ì—¬ íŒŒì¼ ì„ íƒ ë˜ëŠ” ë“œë˜ê·¸<br>
                            <span style="font-size: 13px; color: #999; font-weight: normal;">(.xlsx íŒŒì¼ë§Œ ì§€ì›)</span>
                        </p>
                        <div id="selectedFileName"
                            style="font-weight: bold; color: #4a90e2; margin-top: 10px; display: none; background: #e8f4fd; padding: 8px; border-radius: 4px;">
                        </div>
                        <input type="file" id="corpFileUpload" accept=".xlsx" class="corp-file-input-hidden">
                    </div>

                    <!-- Validation Loading -->
                    <div id="validationLoading" class="corp-loading"
                        style="display:none; text-align: center; margin: 20px 0; padding: 20px; background: #fff8e1; border-radius: 8px;">
                        <span style="display:inline-block; animation:spin 1s linear infinite;">âŒ›</span>
                        <span style="font-weight: bold; color: #f39c12;">ë°ì´í„° ê²€ì¦ ì¤‘...</span>
                    </div>

                    <!-- Validation Results -->
                    <div id="validationResult" class="corp-validation-results"
                        style="display:none; margin-top:20px; border: 1px solid #e0e0e0; border-radius: 8px; overflow: hidden;">
                        <h4 class="corp-validation-title"
                            style="margin: 0; padding: 12px 15px; background: #f1f2f6; border-bottom: 1px solid #e0e0e0; font-size: 14px;">
                            ê²€ì¦ ê²°ê³¼ ìš”ì•½</h4>
                        <div id="validationStats" class="corp-stats" style="padding: 15px;"></div>
                        <div class="corp-success-msg" style="padding: 0 15px 15px; color: #2ecc71; font-weight: bold;">
                            âœ… ê²€ì¦ ì™„ë£Œ. ì‹¤í–‰í•˜ì‹œê² ìŠµë‹ˆê¹Œ?
                        </div>
                    </div>

                    <!-- Password & Execution -->
                    <div id="executionSection" class="corp-execution-section"
                        style="display:none; margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                        <div style="display: flex; justify-content: flex-end; align-items: center; gap: 10px;">
                            <span style="font-size: 13px; font-weight: bold; color: #555;">ğŸ”’ ê´€ë¦¬ì ìŠ¹ì¸:</span>
                            <input type="password" id="corpUploadPassword" placeholder="ë¹„ë°€ë²ˆí˜¸ ì…ë ¥"
                                class="corp-password-input" style="width: 200px;">
                        </div>
                        <div id="executionLoading" class="corp-execution-loading"
                            style="text-align: right; display:none;">
                            âš ï¸ DB ë°˜ì˜ ì¤‘... ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.
                        </div>
                    </div>

                    <!-- Progress Section -->
                    <div id="progressSection"
                        style="display:none; margin-top: 15px; padding: 15px; background: #fff; border: 1px solid #e0e0e0; border-radius: 8px;">
                        <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 10px;">
                            <span style="font-weight: bold; color: #333;">ì§„í–‰ë¥ :</span>
                            <div
                                style="flex: 1; background: #e0e0e0; border-radius: 10px; height: 20px; overflow: hidden;">
                                <div id="uploadProgressBar"
                                    style="width: 0%; height: 100%; background: linear-gradient(90deg, #4a90e2, #2ecc71); transition: width 0.3s ease;">
                                </div>
                            </div>
                            <span id="progressText"
                                style="font-weight: bold; color: #4a90e2; min-width: 40px;">0%</span>
                        </div>
                        <div id="tableStatus" style="font-size: 13px; color: #555;"></div>
                    </div>

                    <!-- Status Log -->
                    <div id="uploadStatus" class="corp-status-log"></div>
                </div>

                <!-- Footer Actions -->
                <div
                    style="text-align: right; margin-top: 25px; padding-top: 15px; border-top: 1px solid #eee; display: flex; justify-content: flex-end; gap: 10px;">
                    <button type="button" class="action-button" id="closeModalBtn"
                        style="background: #95a5a6;">ë‹«ê¸°</button>
                    <button type="button" id="validateUploadBtn" class="action-button"
                        style="background: #4a90e2; width: 120px;">ê²€ì¦ ì‹œì‘</button>
                    <button type="button" id="executeUploadBtn" class="action-button corp-btn-execute"
                        style="background: #2ecc71; display: none; width: 140px;">ì—…ë¡œë“œ ë° ì‹¤í–‰</button>
                </div>
            </div>
        </div>
    </div>
</body>

</html>